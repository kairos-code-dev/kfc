# KFC 프로젝트 테스트 전략 개요

> 작성일: 2025-12-01
> 참고 프로젝트: `/home/ulalax/project/kairos/eodhd`

## 목표

kfc 라이브러리에 **Live Test**와 **Unit Test**를 도입하여 API 안정성을 보장하고,
레코딩된 응답 데이터를 활용한 빠른 테스트 환경을 구축합니다.

## 테스트 전략

### 1. Live Test (실제 API 호출 + 응답 레코딩)

- **목적**: 실제 KRX, Naver, OPENDART API를 호출하여 응답 검증 및 레코딩
- **위치**: `src/liveTest/kotlin/dev/kairoscode/kfc/live/`
- **실행 방식**:
  ```bash
  ./gradlew liveTest -Drecord.responses=true
  ```
- **특징**:
  - API 키 필요 (OPENDART만 필요, KRX/Naver는 불필요)
  - 응답을 JSON 파일로 자동 레코딩 → `src/test/resources/responses/`
  - 실행 시간: 약 5-10분 (API 호출 포함)
  - 주 1회 또는 API 변경 감지 시 실행 권장

### 2. Unit Test (Mock 기반 빠른 테스트)

- **목적**: Live Test에서 레코딩한 JSON 파일을 사용하여 빠른 테스트 실행
- **위치**: `src/test/kotlin/dev/kairoscode/kfc/api/`
- **실행 방식**:
  ```bash
  ./gradlew test
  ```
- **특징**:
  - API 키 불필요
  - Mock HTTP Client 사용
  - 실행 시간: 약 10-20초
  - CI/CD 파이프라인에서 실행

### 3. 테스트 리소스 (레코딩된 JSON 응답)

- **위치**: `src/test/resources/responses/`
- **구조**:
  ```
  responses/
  ├── etf/
  │   ├── list/                    # getList() 응답
  │   ├── comprehensive/           # getComprehensiveInfo() 응답
  │   ├── daily_prices/            # getAllDailyPrices() 응답
  │   ├── ohlcv/                   # getOhlcv() 응답
  │   ├── adjusted_ohlcv/          # getAdjustedOhlcv() 응답
  │   ├── price_changes/           # getPriceChanges() 응답
  │   ├── portfolio/               # getPortfolio() 응답
  │   ├── tracking_error/          # getTrackingError() 응답
  │   ├── divergence_rate/         # getDivergenceRate() 응답
  │   ├── investor_trading/        # 투자자 거래 관련 응답
  │   └── short/                   # 공매도 관련 응답
  └── corp/
      ├── corp_code/               # getCorpCodeList() 응답
      ├── dividend/                # getDividendInfo() 응답
      ├── stock_split/             # getStockSplitInfo() 응답
      └── disclosure/              # searchDisclosures() 응답
  ```

## 테스트 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                        Live Test                             │
│  (실제 KRX/Naver/OPENDART API 호출 + 응답 레코딩)              │
│                                                              │
│  ./gradlew liveTest -Drecord.responses=true                 │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  │ 레코딩
                  ▼
┌─────────────────────────────────────────────────────────────┐
│         src/test/resources/responses/                        │
│         (JSON 응답 파일 저장소)                                │
│                                                              │
│  ├── etf/                                                    │
│  │   ├── list/etf_list.json                                │
│  │   ├── ohlcv/tiger200_ohlcv.json                         │
│  │   └── ...                                               │
│  └── corp/                                                   │
│      ├── corp_code/corp_code_list.json                      │
│      └── ...                                                │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  │ 로드
                  ▼
┌─────────────────────────────────────────────────────────────┐
│                       Unit Test                              │
│  (Mock HTTP Client + 레코딩된 JSON 사용)                       │
│                                                              │
│  ./gradlew test                                             │
└─────────────────────────────────────────────────────────────┘
```

## API별 테스트 범위

### EtfApi (15개 함수)

| 함수명 | Live Test | Unit Test | 비고 |
|-------|-----------|-----------|-----|
| getList() | ✅ | ✅ | 전체 ETF 목록 |
| getComprehensiveInfo() | ✅ | ✅ | 종합 정보 |
| getAllDailyPrices() | ✅ | ✅ | 일별 시세 |
| getOhlcv() | ✅ | ✅ | OHLCV (KRX) |
| getAdjustedOhlcv() | ✅ | ✅ | 조정주가 (Naver) |
| getPriceChanges() | ✅ | ✅ | 등락률 |
| getPortfolio() | ✅ | ✅ | 포트폴리오 구성 |
| getTrackingError() | ✅ | ✅ | 추적 오차 |
| getDivergenceRate() | ✅ | ✅ | 괴리율 |
| getAllInvestorTrading() | ✅ | ✅ | 투자자별 거래 |
| getAllInvestorTradingByPeriod() | ✅ | ✅ | 투자자별 거래 (기간) |
| getInvestorTrading() | ✅ | ✅ | 개별 ETF 투자자 거래 |
| getInvestorTradingByPeriod() | ✅ | ✅ | 개별 ETF 투자자 거래 (기간) |
| getShortSelling() | ✅ | ✅ | 공매도 거래 |
| getShortBalance() | ✅ | ✅ | 공매도 잔고 |

### CorpApi (4개 함수)

| 함수명 | Live Test | Unit Test | 비고 |
|-------|-----------|-----------|-----|
| getCorpCodeList() | ✅ | ✅ | 고유번호 목록 |
| getDividendInfo() | ✅ | ✅ | 배당 정보 |
| getStockSplitInfo() | ✅ | ✅ | 주식 분할 정보 |
| searchDisclosures() | ✅ | ✅ | 공시 검색 |

## 테스트 커버리지 목표

- **Line Coverage**: 80% 이상
- **Branch Coverage**: 70% 이상
- **모든 public API 함수**: 100% 테스트
- **에러 핸들링**: 주요 에러 케이스 커버

## 실행 시나리오

### 시나리오 1: 신규 개발자 (API 키 없음)

```bash
# Unit Test만 실행 (레코딩된 JSON 파일 사용)
./gradlew test

# 결과: 모든 테스트 통과 (API 키 불필요)
```

### 시나리오 2: API 변경 확인 (API 키 있음)

```bash
# 1. 기존 레코딩 데이터 삭제
./gradlew cleanLiveTest

# 2. Live Test로 최신 API 응답 레코딩
./gradlew liveTest -Drecord.responses=true

# 3. Unit Test로 빠른 검증
./gradlew test
```

### 시나리오 3: CI/CD 파이프라인

```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 21
        uses: actions/setup-java@v2
        with:
          java-version: '21'
      - name: Run Unit Tests
        run: ./gradlew test
      # Live Test는 스케줄링된 작업에서만 실행
```

## 테스트 베스트 프랙티스

1. **Unit Test 우선**: 일상적인 개발에서는 빠른 Unit Test 사용
2. **Live Test 주기적 실행**: API 변경 감지를 위해 주 1회 Live Test 실행
3. **레코딩 데이터 검증**: 레코딩된 JSON 파일을 Git에 커밋하여 팀 공유
4. **API 키 보안**: local.properties는 .gitignore에 추가
5. **실패 시 재레코딩**: Live Test 실패 시 `cleanLiveTest` 후 재실행
6. **Rate Limiting 준수**:
   - KRX API: 초당 1-2회 제한 (이미 구현됨)
   - Naver API: 초당 1-2회 제한 (이미 구현됨)
   - OPENDART API: 일 20,000건 제한 (주의 필요)

## 다음 단계

1. ✅ 테스트 디렉토리 구조 생성 → `01-디렉토리_구조.md` 참고
2. ✅ 테스트 헬퍼 클래스 작성 → `02-헬퍼_클래스_작성_가이드.md` 참고
3. ✅ build.gradle.kts 설정 추가 → `05-build_gradle_설정.md` 참고
4. ✅ EtfApi 테스트 작성 → `03-EtfApi_테스트_계획.md` 참고
5. ✅ CorpApi 테스트 작성 → `04-CorpApi_테스트_계획.md` 참고
6. ✅ 전체 체크리스트 확인 → `99-체크리스트.md` 참고
