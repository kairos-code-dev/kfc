# í—¬í¼ í´ë˜ìŠ¤ ì‘ì„± ê°€ì´ë“œ

## ê°œìš”

í…ŒìŠ¤íŠ¸ í—¬í¼ í´ë˜ìŠ¤ëŠ” Live Testì™€ Unit Testì˜ ê³µí†µ ê¸°ëŠ¥ì„ ì œê³µí•˜ë©°,
ì½”ë“œ ì¤‘ë³µì„ ì¤„ì´ê³  í…ŒìŠ¤íŠ¸ ì‘ì„±ì„ ê°„í¸í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.

## Live Test í—¬í¼ í´ë˜ìŠ¤

### 1. LiveTestBase.kt

ëª¨ë“  Live Testì˜ ë¶€ëª¨ í´ë˜ìŠ¤ì…ë‹ˆë‹¤.

**ìœ„ì¹˜**: `src/liveTest/kotlin/dev/kairoscode/kfc/utils/LiveTestBase.kt`

```kotlin
package dev.kairoscode.kfc.utils

import dev.kairoscode.kfc.KfcClient
import kotlinx.coroutines.test.runTest
import org.junit.jupiter.api.AfterAll
import org.junit.jupiter.api.Assumptions
import org.junit.jupiter.api.BeforeAll
import org.junit.jupiter.api.Tag
import org.junit.jupiter.api.TestInstance
import java.io.File
import java.util.Properties
import kotlin.time.Duration.Companion.seconds

@Tag("live")
@TestInstance(TestInstance.Lifecycle.PER_CLASS)
abstract class LiveTestBase {

    protected lateinit var client: KfcClient

    @BeforeAll
    fun setUp() {
        val apiKey = loadApiKey()

        // OPENDART API í‚¤ê°€ í•„ìš”í•œ ê²½ìš°ë§Œ ì²´í¬
        // KRX, NaverëŠ” API í‚¤ ë¶ˆí•„ìš”

        client = if (apiKey != null) {
            KfcClient(openDartApiKey = apiKey)
        } else {
            println("â„¹ï¸  OPENDART_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Corp API í…ŒìŠ¤íŠ¸ëŠ” skipë©ë‹ˆë‹¤.")
            KfcClient(openDartApiKey = null) // ETF APIëŠ” í‚¤ ì—†ì´ë„ ë™ì‘
        }

        println("ğŸš€ Live Test ì‹œì‘ - Recording: ${RecordingConfig.isRecordingEnabled}")
    }

    @AfterAll
    fun tearDown() {
        if (::client.isInitialized) {
            client.close()
            println("ğŸ Live Test ì¢…ë£Œ")
        }
    }

    /**
     * API í‚¤ë¥¼ local.propertiesì—ì„œ ë¡œë“œ
     */
    private fun loadApiKey(): String? {
        val localPropertiesFile = File("local.properties")
        if (localPropertiesFile.exists()) {
            val properties = Properties()
            localPropertiesFile.inputStream().use { properties.load(it) }
            return properties.getProperty("OPENDART_API_KEY")
        }
        return null
    }

    /**
     * í…ŒìŠ¤íŠ¸ ì‹¤í–‰ í—¬í¼ (íƒ€ì„ì•„ì›ƒ ì„¤ì •)
     */
    protected fun liveTest(
        timeout: kotlin.time.Duration = 30.seconds,
        block: suspend () -> Unit
    ) = runTest(timeout = timeout) {
        block()
    }
}
```

### 2. ResponseRecorder.kt

API ì‘ë‹µì„ JSON íŒŒì¼ë¡œ ì €ì¥í•˜ëŠ” ìœ í‹¸ë¦¬í‹°ì…ë‹ˆë‹¤.

**ìœ„ì¹˜**: `src/liveTest/kotlin/dev/kairoscode/kfc/utils/ResponseRecorder.kt`

```kotlin
package dev.kairoscode.kfc.utils

import kotlinx.serialization.encodeToString
import kotlinx.serialization.json.Json
import java.nio.file.Files
import kotlin.io.path.exists

object ResponseRecorder {
    const val MAX_RECORD_SIZE = 10_000  // ìµœëŒ€ 10,000ê°œë§Œ ë ˆì½”ë”©

    private val json = Json {
        prettyPrint = true
        encodeDefaults = false
        explicitNulls = false
    }

    /**
     * ê°ì²´ë¥¼ JSON íŒŒì¼ë¡œ ì €ì¥
     * @param data ì €ì¥í•  ë°ì´í„° (Serializable)
     * @param category API ì¹´í…Œê³ ë¦¬ (RecordingConfig.Paths ì‚¬ìš©)
     * @param fileName íŒŒì¼ëª… (í™•ì¥ì ì œì™¸)
     */
    inline fun <reified T> record(data: T, category: String, fileName: String) {
        if (!RecordingConfig.isRecordingEnabled) return

        val outputDir = RecordingConfig.baseOutputPath.resolve(category)
        Files.createDirectories(outputDir)

        val outputFile = outputDir.resolve("$fileName.json")
        val jsonString = json.encodeToString(data)
        Files.writeString(outputFile, jsonString)

        println("âœ… Recorded: $outputFile")
    }

    /**
     * ë¦¬ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ JSON íŒŒì¼ë¡œ ì €ì¥
     * ë°ì´í„°ê°€ MAX_RECORD_SIZEë¥¼ ì´ˆê³¼í•˜ë©´ ì²˜ìŒ MAX_RECORD_SIZEê°œë§Œ ë ˆì½”ë”©
     */
    inline fun <reified T> recordList(data: List<T>, category: String, fileName: String) {
        if (!RecordingConfig.isRecordingEnabled) return

        if (data.isEmpty()) {
            println("âš ï¸ ê²½ê³ : $category/$fileName ì— ë ˆì½”ë”©í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            return
        }

        val recordData = if (data.size > MAX_RECORD_SIZE) {
            println("âš ï¸ ë°ì´í„°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤ (${data.size}ê°œ). ì²˜ìŒ $MAX_RECORD_SIZE ê°œë§Œ ë ˆì½”ë”©í•©ë‹ˆë‹¤.")
            data.take(MAX_RECORD_SIZE)
        } else {
            data
        }

        record(recordData, category, fileName)
    }
}
```

### 3. RecordingConfig.kt

ë ˆì½”ë”© ì„¤ì • ë° ê²½ë¡œ ê´€ë¦¬ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤.

**ìœ„ì¹˜**: `src/liveTest/kotlin/dev/kairoscode/kfc/utils/RecordingConfig.kt`

```kotlin
package dev.kairoscode.kfc.utils

import java.nio.file.Path
import java.nio.file.Paths

object RecordingConfig {
    /**
     * ë ˆì½”ë”© í™œì„±í™” ì—¬ë¶€
     * -Drecord.responses=true ë¡œ Gradle ì‹¤í–‰ ì‹œ í™œì„±í™”
     */
    val isRecordingEnabled: Boolean
        get() = System.getProperty("record.responses", "false").toBoolean()

    /**
     * ë ˆì½”ë”© íŒŒì¼ ì €ì¥ ê²½ë¡œ
     */
    val baseOutputPath: Path = Paths.get("src/test/resources/responses")

    /**
     * APIë³„ ë ˆì½”ë”© ê²½ë¡œ
     */
    object Paths {
        object Etf {
            const val LIST = "etf/list"
            const val COMPREHENSIVE = "etf/comprehensive"
            const val DAILY_PRICES = "etf/daily_prices"
            const val OHLCV = "etf/ohlcv"
            const val ADJUSTED_OHLCV = "etf/adjusted_ohlcv"
            const val PRICE_CHANGES = "etf/price_changes"
            const val PORTFOLIO = "etf/portfolio"
            const val TRACKING_ERROR = "etf/tracking_error"
            const val DIVERGENCE_RATE = "etf/divergence_rate"
            const val INVESTOR_TRADING = "etf/investor_trading"
            const val SHORT = "etf/short"
        }

        object Corp {
            const val CORP_CODE = "corp/corp_code"
            const val DIVIDEND = "corp/dividend"
            const val STOCK_SPLIT = "corp/stock_split"
            const val DISCLOSURE = "corp/disclosure"
        }
    }
}
```

### 4. TestSymbols.kt

í…ŒìŠ¤íŠ¸ìš© ETF/ì¢…ëª© ì½”ë“œ ìƒìˆ˜ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

**ìœ„ì¹˜**: `src/liveTest/kotlin/dev/kairoscode/kfc/utils/TestSymbols.kt`

```kotlin
package dev.kairoscode.kfc.utils

/**
 * í…ŒìŠ¤íŠ¸ìš© ETF ë° ì¢…ëª© ì½”ë“œ ìƒìˆ˜
 */
object TestSymbols {
    // ETF ISIN ì½”ë“œ
    const val TIGER_200_ISIN = "KR7102110009"      // TIGER 200
    const val KODEX_200_ISIN = "KR7069500007"      // KODEX 200
    const val TIGER_NASDAQ100_ISIN = "KR7133690003" // TIGER ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100

    // ETF í‹°ì»¤ (6ìë¦¬)
    const val TIGER_200_TICKER = "102110"
    const val KODEX_200_TICKER = "069500"

    // ë²•ì¸ ì½”ë“œ (ì‚¼ì„±ì „ì ë“±)
    const val SAMSUNG_CORP_CODE = "00126380"       // ì‚¼ì„±ì „ì
    const val KAKAO_CORP_CODE = "00222206"         // ì¹´ì¹´ì˜¤
}
```

## Unit Test í—¬í¼ í´ë˜ìŠ¤

### 1. UnitTestBase.kt

ëª¨ë“  Unit Testì˜ ë¶€ëª¨ í´ë˜ìŠ¤ì…ë‹ˆë‹¤.

**ìœ„ì¹˜**: `src/test/kotlin/dev/kairoscode/kfc/utils/UnitTestBase.kt`

```kotlin
package dev.kairoscode.kfc.utils

import dev.kairoscode.kfc.KfcClient
import io.ktor.client.*
import kotlinx.coroutines.test.runTest
import org.junit.jupiter.api.AfterEach
import org.junit.jupiter.api.TestInstance
import kotlin.time.Duration.Companion.seconds

/**
 * Unit Testì˜ ê³µí†µ ë² ì´ìŠ¤ í´ë˜ìŠ¤
 *
 * Mock HttpClientë¥¼ ì£¼ì…í•˜ì—¬ ì‹¤ì œ API í˜¸ì¶œ ì—†ì´ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
 * ë ˆì½”ë”©ëœ JSON ì‘ë‹µ íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.
 */
@TestInstance(TestInstance.Lifecycle.PER_METHOD)
abstract class UnitTestBase {

    protected lateinit var client: KfcClient
    private var mockHttpClient: HttpClient? = null

    /**
     * JSON íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ Mock ì‘ë‹µìœ¼ë¡œ ì„¤ì •
     *
     * @param category ì‘ë‹µ ì¹´í…Œê³ ë¦¬ (etf/list, corp/dividend ë“±)
     * @param fileName íŒŒì¼ëª… (.json í™•ì¥ì ì œì™¸)
     */
    protected fun mockResponse(category: String, fileName: String) {
        val jsonResponse = JsonResponseLoader.load(category, fileName)
        mockHttpClient = MockHttpClientFactory.createWithResponse(jsonResponse)
        client = createClientWithMockHttpClient(mockHttpClient!!)
    }

    // ETF API Mock í—¬í¼
    protected fun mockEtfListResponse(fileName: String) =
        mockResponse("etf/list", fileName)

    protected fun mockEtfComprehensiveResponse(fileName: String) =
        mockResponse("etf/comprehensive", fileName)

    protected fun mockEtfDailyPricesResponse(fileName: String) =
        mockResponse("etf/daily_prices", fileName)

    protected fun mockEtfOhlcvResponse(fileName: String) =
        mockResponse("etf/ohlcv", fileName)

    protected fun mockEtfAdjustedOhlcvResponse(fileName: String) =
        mockResponse("etf/adjusted_ohlcv", fileName)

    // Corp API Mock í—¬í¼
    protected fun mockCorpCodeResponse(fileName: String) =
        mockResponse("corp/corp_code", fileName)

    protected fun mockDividendResponse(fileName: String) =
        mockResponse("corp/dividend", fileName)

    /**
     * Mock HttpClientë¥¼ ì£¼ì…í•œ KfcClient ìƒì„±
     */
    private fun createClientWithMockHttpClient(httpClient: HttpClient): KfcClient {
        return KfcClient(
            openDartApiKey = "test-api-key",
            httpClient = httpClient
        )
    }

    @AfterEach
    fun tearDown() {
        mockHttpClient?.close()
        if (::client.isInitialized) {
            client.close()
        }
    }

    /**
     * í…ŒìŠ¤íŠ¸ ì‹¤í–‰ í—¬í¼
     */
    protected fun unitTest(
        timeout: kotlin.time.Duration = 10.seconds,
        block: suspend () -> Unit
    ) = runTest(timeout = timeout) {
        block()
    }
}
```

### 2. MockHttpClientFactory.kt

Mock HTTP Clientë¥¼ ìƒì„±í•˜ëŠ” íŒ©í† ë¦¬ì…ë‹ˆë‹¤.

**ìœ„ì¹˜**: `src/test/kotlin/dev/kairoscode/kfc/utils/MockHttpClientFactory.kt`

```kotlin
package dev.kairoscode.kfc.utils

import io.ktor.client.*
import io.ktor.client.engine.mock.*
import io.ktor.client.plugins.contentnegotiation.*
import io.ktor.http.*
import io.ktor.serialization.kotlinx.json.*
import io.ktor.utils.io.*
import kotlinx.serialization.json.Json

object MockHttpClientFactory {

    /**
     * JSON ì‘ë‹µì„ ë°˜í™˜í•˜ëŠ” Mock HttpClient ìƒì„±
     */
    fun createWithResponse(jsonResponse: String): HttpClient {
        val mockEngine = MockEngine { _ ->
            respond(
                content = ByteReadChannel(jsonResponse),
                status = HttpStatusCode.OK,
                headers = headersOf(HttpHeaders.ContentType, "application/json")
            )
        }

        return HttpClient(mockEngine) {
            install(ContentNegotiation) {
                json(Json {
                    ignoreUnknownKeys = true
                    isLenient = true
                })
            }
        }
    }

    /**
     * ì—ëŸ¬ ì‘ë‹µì„ ë°˜í™˜í•˜ëŠ” Mock HttpClient ìƒì„±
     */
    fun createWithError(statusCode: HttpStatusCode): HttpClient {
        val mockEngine = MockEngine { _ ->
            respond(
                content = ByteReadChannel("""{"error": "${statusCode.description}"}"""),
                status = statusCode,
                headers = headersOf(HttpHeaders.ContentType, "application/json")
            )
        }

        return HttpClient(mockEngine) {
            install(ContentNegotiation) {
                json(Json {
                    ignoreUnknownKeys = true
                    isLenient = true
                })
            }
        }
    }
}
```

### 3. JsonResponseLoader.kt

JSON íŒŒì¼ì„ ë¡œë“œí•˜ëŠ” ìœ í‹¸ë¦¬í‹°ì…ë‹ˆë‹¤.

**ìœ„ì¹˜**: `src/test/kotlin/dev/kairoscode/kfc/utils/JsonResponseLoader.kt`

```kotlin
package dev.kairoscode.kfc.utils

import java.nio.file.Files
import java.nio.file.Paths

object JsonResponseLoader {

    /**
     * JSON ì‘ë‹µ íŒŒì¼ ë¡œë“œ
     *
     * @param category ì‘ë‹µ ì¹´í…Œê³ ë¦¬ (etf/list, corp/dividend ë“±)
     * @param fileName íŒŒì¼ëª… (.json í™•ì¥ì ì œì™¸)
     * @return JSON ë¬¸ìì—´
     */
    fun load(category: String, fileName: String): String {
        val resourcePath = "responses/$category/$fileName.json"
        val resource = this::class.java.classLoader.getResource(resourcePath)
            ?: throw IllegalArgumentException("í…ŒìŠ¤íŠ¸ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $resourcePath")

        return Files.readString(Paths.get(resource.toURI()))
    }
}
```

### 4. TestExtensions.kt

í…ŒìŠ¤íŠ¸ìš© í™•ì¥ í•¨ìˆ˜ ë° í—¬í¼ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

**ìœ„ì¹˜**: `src/test/kotlin/dev/kairoscode/kfc/utils/TestExtensions.kt`

```kotlin
package dev.kairoscode.kfc.utils

import dev.kairoscode.kfc.model.krx.*
import org.assertj.core.api.Assertions.assertThat
import java.math.BigDecimal

/**
 * EtfListItem ê²€ì¦ í—¬í¼
 */
fun EtfListItem.assertValidEtfListItem() {
    assertThat(this.isin).isNotEmpty()
    assertThat(this.ticker).isNotEmpty()
    assertThat(this.name).isNotEmpty()
}

/**
 * EtfOhlcv ê²€ì¦ í—¬í¼
 */
fun EtfOhlcv.assertValidOhlcv() {
    assertThat(this.date).isNotNull()
    assertThat(this.open).isGreaterThan(BigDecimal.ZERO)
    assertThat(this.high).isGreaterThanOrEqualTo(this.low)
    assertThat(this.close).isGreaterThan(BigDecimal.ZERO)
    assertThat(this.volume).isGreaterThanOrEqualTo(0)
}

/**
 * List í¬ê¸° ê²€ì¦ í—¬í¼
 */
fun <T> List<T>.assertNotEmpty() {
    assertThat(this).isNotEmpty()
}

fun <T> List<T>.assertSize(expectedSize: Int) {
    assertThat(this).hasSize(expectedSize)
}
```

## ë‹¤ìŒ ë‹¨ê³„

1. âœ… ìœ„ í—¬í¼ í´ë˜ìŠ¤ë“¤ì„ ë³µì‚¬í•˜ì—¬ í”„ë¡œì íŠ¸ì— ì¶”ê°€
2. âœ… build.gradle.kts ì„¤ì • ì¶”ê°€ â†’ `05-build_gradle_ì„¤ì •.md` ì°¸ê³ 
3. âœ… ì‹¤ì œ í…ŒìŠ¤íŠ¸ ì‘ì„± ì‹œì‘ â†’ `03-EtfApi_í…ŒìŠ¤íŠ¸_ê³„íš.md` ì°¸ê³ 
