# 프로젝트 개요: kotlin-krx

## 프로젝트 요약

**kotlin-krx**는 한국거래소(KRX) ETF 데이터를 크롤링하고 처리하는 포괄적인 Kotlin 라이브러리로, 고급 백테스팅 기능을 갖춘 ETF.com 스타일 웹사이트 구축을 목표로 합니다. Kotlin 2.2.20, Spring Boot 3.2, JDK 21 기반으로 구축된 이 라이브러리는 모든 KRX ETF 엔드포인트에 대한 타입 안전하고 관용적인 Kotlin 인터페이스를 제공하며, 데이터 완전성, 안정성, 개발자 경험에 중점을 둡니다.

**핵심 차별화 요소:**
- **pykrx 넘어서기**: 참조 라이브러리인 pykrx에서 누락된 중요 엔드포인트인 MDCSTAT04701(ETF 개별 종목 종합정보) 구현
- **백테스트 준비**: 무제한 날짜 범위를 위한 자동 730일 분할 기능이 있는 유연한 과거 데이터 API
- **프로덕션 등급**: KRX 명세에 맞춘 포괄적인 오류 처리, 속도 제한, 데이터 정규화
- **Kotlin 관용적**: 뛰어난 개발자 경험을 위한 타입 안전 모델, 확장 함수, DSL 스타일 API

## 프로젝트 목표 및 배경

### 주요 목표

1. **데이터 완전성**: 총 22개 함수 제공 (KRX 15개 + Naver 1개 + OPENDART 6개)
2. **MDCSTAT04701 우선순위**: 종합 ETF 정보 엔드포인트 우선 구현 (pykrx에 미구현)
3. **백테스팅 지원**: 상장일부터 현재까지 사용자 정의 날짜 범위로 과거 데이터 검색 가능
4. **문서화 우수성**: 파라미터 조합, 응답 필드 매핑, 사용 예제와 함께 모든 엔드포인트 문서화
5. **테스트 커버리지**: 모든 엔드포인트에 대한 포괄적인 단위 및 통합 테스트 작성

### 비즈니스 컨텍스트

대상 애플리케이션은 다음을 제공하는 **ETF.com 스타일 웹사이트**입니다:
- 실시간 및 과거 ETF 데이터 시각화
- 포트폴리오 분석 및 구성 추적
- 성과 지표 및 추적 오차 분석
- 투자 전략을 위한 고급 백테스팅 엔진
- 거래 패턴 데이터를 통한 투자자 심리 분석

### pykrx와의 비교

| 측면 | pykrx (Python) | kotlin-krx (Kotlin) |
|------|----------------|---------------------|
| **언어** | Python 3.x | Kotlin 2.2.20 + JDK 21 |
| **아키텍처** | WebIO → KrxIO → Core → Wrap → API | KrxClient → Service Layer → Domain Models |
| **총 함수 수** | 14개 이상 | 22개 (KRX 15 + Naver 1 + OPENDART 6) |
| **MDCSTAT04701** | 미구현 | 우선순위 구현 |
| **타입 안전성** | 동적 타이핑 | 데이터 클래스를 사용한 정적 타이핑 |
| **날짜 분할** | 730일 자동 분할 | 730일 자동 분할 (호환) |
| **정규화** | Pandas DataFrame | 확장 함수를 사용한 Kotlin 데이터 클래스 |
| **테스팅** | 제한적 | 포괄적인 단위 + 통합 테스트 |
| **Spring 통합** | 해당 없음 | 네이티브 Spring Boot 지원 |

**주요 개선 사항:**
- **종합 ETF 데이터**: MDCSTAT04701은 단일 요청으로 총 보수, 시가총액, 52주 고가/저가, 자산군, 벤치마크 제공
- **향상된 오류 처리**: 명시적 예외 타입, 재시도 로직, 우아한 성능 저하
- **성능**: 연결 풀링 및 설정 가능한 타임아웃을 갖춘 OkHttp 클라이언트
- **유지보수성**: 관심사의 명확한 분리를 갖춘 클린 아키텍처

## 전체 아키텍처 설계

### 상위 레벨 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                     표현 계층 (Presentation Layer)              │
│              (Spring Boot REST Controllers)                     │
└────────────────────────┬────────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────────┐
│                     서비스 계층 (Service Layer)                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ EtfService   │  │ MarketService│  │IndexService  │         │
│  │              │  │              │  │              │         │
│  │ - OHLCV      │  │ - 가격 데이터│  │ - 지수 데이터│         │
│  │ - 포트폴리오 │  │ - 시총/거래량│  │ - 구성 종목  │         │
│  │ - 추적 오차  │  │ - 투자자 정보│  │ - 성과 지표  │         │
│  │ - 괴리율     │  │ - 공매도     │  └──────────────┘         │
│  │ - 종합 정보  │  └──────────────┘                           │
│  │   (04701)    │                                              │
│  └──────┬───────┘                                              │
│         │                                                       │
│         │  정규화 계층 (Extension Functions)                   │
│         │  - parseDate(), parseInt(), parseLong()              │
│         │  - String.toKrxInt(), String.toKrxDouble()           │
│         │                                                       │
└─────────┼───────────────────────────────────────────────────────┘
          │
┌─────────▼───────────────────────────────────────────────────────┐
│               클라이언트 계층 (KrxClient)                        │
│                                                                 │
│  - HTTP 통신 (OkHttp)                                           │
│  - 730일 자동 분할                                              │
│  - 응답 병합                                                    │
│  - 오류 처리                                                    │
│                                                                 │
└─────────┬───────────────────────────────────────────────────────┘
          │
┌─────────▼───────────────────────────────────────────────────────┐
│              KRX 데이터 API (data.krx.co.kr)                    │
│                                                                 │
│  엔드포인트: /comm/bldAttendant/getJsonData.cmd                 │
│  BLD 코드: MDCSTAT04301, 04401, 04501, 04601, 04701 등         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 아키텍처 계층 (pykrx 기반 적용)

#### 1. 클라이언트 계층 (pykrx의 WebIO + KrxIO 대체)

**KrxClient** - 모든 KRX 엔드포인트를 위한 단일, 재사용 가능한 HTTP 클라이언트

```kotlin
class KrxClient(
    private val baseUrl: String = "http://data.krx.co.kr",
    private val http: OkHttpClient
) {
    fun post(bld: String, params: Map<String, String>): Map<String, Any?>
}
```

**책임:**
- 폼 인코딩 데이터로 HTTP POST 요청
- 2년 이상 날짜 범위에 대한 자동 730일 분할
- 분할된 요청에 대한 응답 병합
- 폴백 오류 처리를 갖춘 JSON 파싱
- 속도 제한 (청크 간 1초 지연)

#### 2. 서비스 계층 (pykrx의 Core + Wrap 대체)

비즈니스 로직을 구현하는 도메인별 서비스:

- **EtfService**: ETF 특화 작업 (OHLCV, 포트폴리오, 추적 오차, 괴리율, 투자자 거래)
- **EtfComprehensiveService**: MDCSTAT04701 종합 정보 (신규)
- **MarketService**: 시장 전체 데이터 (가격, 시가총액, 기본 지표)
- **IndexService**: 지수 데이터 및 구성 종목
- **InvestorService**: 투자자 거래 패턴
- **ShortingService**: 공매도 데이터
- **BondService**: 채권 시장 데이터
- **FutureService**: 선물 데이터

#### 3. 모델 계층 (pykrx의 DataFrame 출력 대체)

명시적 필드 타입을 갖춘 타입 안전 데이터 클래스:

```kotlin
data class ComprehensiveEtfInfo(
    val ticker: String,
    val name: String,
    val date: LocalDate,
    val closePrice: Int,
    val nav: BigDecimal,
    val marketCap: Long,
    val totalFee: BigDecimal,
    val weekHigh52: Int,
    val weekLow52: Int,
    val assetClass: String,
    val benchmark: String,
    // ... 30개 이상의 필드
)
```

#### 4. 티커 캐시 계층

티커 <-> ISIN 매핑을 위한 인메모리 캐싱:

- **EtxTickerCache**: ETF/ETN 티커 확인
- **StockTickerCache**: 주식 티커 확인

#### 5. 정규화 계층

일관된 데이터 변환을 위한 확장 함수:

```kotlin
fun String.toKrxInt(): Int = this.replace(",", "").let { if (it == "-") "0" else it }.toIntOrNull() ?: 0
fun String.toKrxLong(): Long = this.replace(",", "").let { if (it == "-") "0" else it }.toLongOrNull() ?: 0L
fun String.toKrxBigDecimal(): BigDecimal = this.replace(",", "").let { if (it == "-") "0" else it }.toBigDecimalOrNull() ?: BigDecimal.ZERO
```

## 기술 스택 선정 이유

### 핵심 기술

| 기술 | 버전 | 선정 이유 |
|------|------|-----------|
| **Kotlin** | 2.2.20 | Null 안전성, 데이터 클래스, 확장 함수, 코루틴 지원 |
| **JDK** | 21 | 가상 스레드 및 성능 개선을 갖춘 최신 LTS |
| **Spring Boot** | 3.2 | 의존성 주입, 구성 관리, 프로덕션 준비 기능 |
| **OkHttp** | 4.x | 연결 풀링, 인터셉터, 타임아웃 관리를 갖춘 강력한 HTTP 클라이언트 |
| **Jackson** | 2.x | Kotlin 모듈 지원을 갖춘 빠른 JSON 파싱 |
| **JUnit 5** | 5.x | 파라미터화된 테스트 및 확장 기능을 갖춘 최신 테스팅 프레임워크 |
| **Kotlin Logging** | 3.x | Kotlin 관용적 API를 갖춘 구조화된 로깅 |

### 설계 근거

1. **Java보다 Kotlin**: 뛰어난 null 안전성, 간결한 문법, 함수형 프로그래밍 기능으로 보일러플레이트 감소
2. **RestTemplate보다 OkHttp**: 더 나은 성능, 더 유연한 인터셉터, 최신 API
3. **Spring Boot**: 프로덕션 애플리케이션을 위한 업계 표준 프레임워크, 광범위한 생태계
4. **Map보다 데이터 클래스**: 타입 안전성으로 런타임 오류 방지, 더 나은 IDE 지원
5. **JDK 21**: 잠재적 비동기 리팩토링을 위한 가상 스레드로 미래 보장

## 모듈 구조

```
kotlin-krx/
├── app/                                      # 메인 애플리케이션 모듈
│   ├── src/
│   │   ├── main/kotlin/com/kairos/krx/
│   │   │   ├── client/
│   │   │   │   └── KrxClient.kt             # HTTP 클라이언트 계층
│   │   │   ├── model/
│   │   │   │   ├── ComprehensiveEtfInfo.kt  # MDCSTAT04701 모델
│   │   │   │   ├── Ohlcv.kt
│   │   │   │   ├── MarketCap.kt
│   │   │   │   ├── Fundamental.kt
│   │   │   │   └── ...
│   │   │   ├── etx/
│   │   │   │   ├── EtfService.kt            # ETF 서비스 계층
│   │   │   │   └── EtfComprehensiveService.kt # 신규: 04701 서비스
│   │   │   ├── market/
│   │   │   │   ├── MarketService.kt
│   │   │   │   ├── InvestorService.kt
│   │   │   │   └── SectorService.kt
│   │   │   ├── index/
│   │   │   │   └── IndexService.kt
│   │   │   ├── ticker/
│   │   │   │   ├── EtxTickerCache.kt
│   │   │   │   └── StockTickerCache.kt
│   │   │   ├── util/
│   │   │   │   └── NormalizationExtensions.kt # 데이터 정규화
│   │   │   └── exception/
│   │   │       ├── KrxApiException.kt
│   │   │       └── TickerNotFoundException.kt
│   │   └── test/kotlin/com/kairos/krx/
│   │       ├── etx/
│   │       │   ├── EtfServiceTest.kt
│   │       │   └── EtfComprehensiveServiceTest.kt
│   │       └── integration/
│   │           └── Mdcstat04701IntegrationTest.kt
│   └── build.gradle.kts
├── plan/                                     # 기술 문서
│   ├── 01-프로젝트-개요.md                   # 이 문서
│   ├── 02-KRX-ETF-엔드포인트-분석.md
│   ├── 03-MDCSTAT04701-상세명세.md
│   ├── 04-데이터-매핑-명세.md
│   ├── 05-구현-로드맵.md
│   ├── 06-API-설계.md
│   └── 07-테스트-전략.md
├── scripts/                                  # 유틸리티 스크립트
│   └── pykrx_runner.py                      # pykrx 비교 실행기
├── vendor/pykrx/                            # 참조 구현
├── build.gradle.kts                         # 루트 빌드 구성
├── settings.gradle.kts
└── README.md
```

## 디자인 패턴

### 1. 템플릿 메서드 패턴 (pykrx 기반)

각 서비스는 일관된 템플릿을 따릅니다:
1. 입력 파라미터 검증
2. 티커를 ISIN으로 확인 (필요시)
3. 요청 파라미터 빌드
4. KrxClient.post() 호출
5. 응답 파싱 및 정규화
6. 타입 지정된 데이터 구조 반환

```kotlin
fun getEtfOhlcvByDate(fromDate: String, toDate: String, ticker: String): List<Map<String, Any>> {
    val isin = etx.getIsin(ticker)                    // 2단계
    val resp = client.post(bld, params)               // 4단계
    val rows = (resp["output"] as? List<*>) ?: []     // 5단계
    return rows.map { normalize(it) }                 // 5단계
}
```

### 2. 전략 패턴

데이터 타입에 따른 다양한 정규화 전략:

```kotlin
interface Normalizer<T> {
    fun normalize(raw: String): T
}

object IntNormalizer : Normalizer<Int> {
    override fun normalize(raw: String) = raw.replace(",", "").let { if (it == "-") "0" else it }.toInt()
}

object DateNormalizer : Normalizer<LocalDate> {
    override fun normalize(raw: String) = when {
        raw.contains("/") -> LocalDate.parse(raw, slashFormatter)
        else -> LocalDate.parse(raw, compactFormatter)
    }
}
```

### 3. 싱글톤 패턴

중복 KRX API 호출을 피하기 위한 티커 캐시 싱글톤:

```kotlin
object EtxTickerCache {
    private val tickerToIsin = mutableMapOf<String, String>()

    fun getIsin(ticker: String): String {
        return tickerToIsin.getOrPut(ticker) {
            fetchFromKrx(ticker)
        }
    }
}
```

### 4. 데코레이터 패턴

원시 KRX 응답에 추가 메타데이터를 추가하는 서비스 계층:

```kotlin
fun getComprehensiveInfo(ticker: String, date: String): ComprehensiveEtfInfo {
    val raw = client.post(bld, params)
    return ComprehensiveEtfInfo.fromRaw(raw).copy(
        fetchedAt = Instant.now(),
        dataSource = "KRX-MDCSTAT04701"
    )
}
```

### 5. 빌더 패턴

다중 파라미터 요청을 위한 복잡한 쿼리 빌더:

```kotlin
class EtfQueryBuilder {
    private var ticker: String? = null
    private var fromDate: LocalDate? = null
    private var toDate: LocalDate = LocalDate.now()

    fun ticker(ticker: String) = apply { this.ticker = ticker }
    fun from(date: LocalDate) = apply { this.fromDate = date }
    fun to(date: LocalDate) = apply { this.toDate = date }

    fun build(): EtfQuery = EtfQuery(ticker!!, fromDate, toDate)
}
```

## 아키텍처 다이어그램

### 요청 흐름 시퀀스

```
┌──────┐      ┌────────────────┐      ┌──────────┐      ┌─────────┐
│Client│      │EtfService      │      │KrxClient │      │KRX API  │
└───┬──┘      └────────┬───────┘      └────┬─────┘      └────┬────┘
    │                  │                    │                 │
    │ getOhlcv(ticker) │                    │                 │
    ├─────────────────>│                    │                 │
    │                  │                    │                 │
    │                  │ getIsin(ticker)    │                 │
    │                  ├──────────────┐     │                 │
    │                  │              │     │                 │
    │                  │<─────────────┘     │                 │
    │                  │                    │                 │
    │                  │ post(bld, params)  │                 │
    │                  ├───────────────────>│                 │
    │                  │                    │                 │
    │                  │                    │ 필요시 분할     │
    │                  │                    ├────────┐        │
    │                  │                    │        │        │
    │                  │                    │<───────┘        │
    │                  │                    │                 │
    │                  │                    │ POST 요청       │
    │                  │                    ├────────────────>│
    │                  │                    │                 │
    │                  │                    │ JSON 응답       │
    │                  │                    │<────────────────┤
    │                  │                    │                 │
    │                  │                    │ 청크 병합       │
    │                  │                    ├────────┐        │
    │                  │                    │        │        │
    │                  │                    │<───────┘        │
    │                  │                    │                 │
    │                  │ Map<String, Any?>  │                 │
    │                  │<───────────────────┤                 │
    │                  │                    │                 │
    │                  │ 데이터 정규화      │                 │
    │                  ├──────────┐         │                 │
    │                  │          │         │                 │
    │                  │<─────────┘         │                 │
    │                  │                    │                 │
    │ List<Ohlcv>      │                    │                 │
    │<─────────────────┤                    │                 │
    │                  │                    │                 │
```

### 데이터 정규화 파이프라인

```
┌────────────────────────────────────────────────────────────────┐
│               KRX 원시 JSON 응답                               │
│  {                                                             │
│    "TRD_DD": "2024/01/02",                                     │
│    "TDD_CLSPRC": "42,965",                                     │
│    "ACC_TRDVOL": "192,061",                                    │
│    "LST_NAV": "43,079.14",                                     │
│    "FLUC_RT": "2.58"                                           │
│  }                                                             │
└────────────────┬───────────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────────┐
│              1단계: 필드 값 추출                               │
│  TRD_DD -> "2024/01/02"                                        │
│  TDD_CLSPRC -> "42,965"                                        │
└────────────────┬───────────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────────┐
│              2단계: 콤마 제거                                  │
│  "42,965" -> "42965"                                           │
│  "192,061" -> "192061"                                         │
└────────────────┬───────────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────────┐
│              3단계: 특수 값 처리                               │
│  "-" -> "0"                                                    │
│  "" -> "0"                                                     │
│  null -> "0"                                                   │
└────────────────┬───────────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────────┐
│              4단계: 타입 변환                                  │
│  "2024/01/02" -> LocalDate(2024, 1, 2)                         │
│  "42965" -> Int(42965)                                         │
│  "192061" -> Long(192061)                                      │
│  "43,079.14" -> BigDecimal(43079.14)                           │
│  "2.58" -> Double(2.58)                                        │
└────────────────┬───────────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────────────┐
│              5단계: 타입 지정된 모델 빌드                      │
│  Ohlcv(                                                        │
│    date = LocalDate(2024, 1, 2),                               │
│    close = 42965,                                              │
│    volume = 192061L,                                           │
│    nav = BigDecimal(43079.14),                                 │
│    changeRate = 2.58                                           │
│  )                                                             │
└────────────────────────────────────────────────────────────────┘
```

### 모듈 의존성 그래프

```
┌─────────────────────────────────────────────────────────────────┐
│                        애플리케이션 계층                        │
│                   (Controllers, Use Cases)                      │
└────────────────────────────┬────────────────────────────────────┘
                             │
                  ┌──────────┴──────────┐
                  │                     │
┌─────────────────▼──────┐   ┌──────────▼──────────────┐
│   EtfService           │   │  EtfComprehensiveService│
│   - OHLCV              │   │  - getComprehensiveInfo │
│   - 포트폴리오         │   │  - 상세 ETF 데이터      │
│   - 추적 오차          │   └──────────┬──────────────┘
│   - 괴리율             │              │
└─────────────┬──────────┘              │
              │                         │
              └────────┬────────────────┘
                       │
         ┌─────────────┴─────────────┐
         │                           │
┌────────▼────────┐         ┌────────▼──────┐
│  KrxClient      │         │ EtxTickerCache│
│  - HTTP 계층    │         │ - ISIN 캐시   │
│  - 분할         │         └───────────────┘
│  - 병합         │
└─────────────────┘
```

## 품질 속성

### 성능
- **목표**: 단일 날짜 쿼리 < 2초, 730일 범위 < 10초
- **최적화**: 연결 풀링, 응답 캐싱 (선택적), 병렬 청크 요청 (향후)

### 확장성
- **수평**: 상태 비저장 서비스를 여러 인스턴스에 배포 가능
- **수직**: OkHttp 연결 풀 구성, JVM 힙 튜닝

### 안정성
- **재시도 로직**: 일시적 실패에 대한 지수 백오프
- **서킷 브레이커**: KRX API 다운 시 빠른 실패
- **데이터 검증**: Null 안전성 및 타입 체크로 런타임 오류 방지

### 유지보수성
- **코드 커버리지**: > 80% 목표
- **문서화**: 모든 공개 API에 대한 KDoc
- **로깅**: INFO, DEBUG, ERROR 레벨의 구조화된 로깅

### 보안
- **입력 검증**: 날짜 문자열 및 티커 정제
- **속도 제한**: KRX 서버 제한 준수 (청크 요청 시 1 req/sec)
- **민감 데이터 없음**: 모든 KRX 엔드포인트는 공개, 인증 불필요

## 성공 기준

1. **기능 완전성**: 총 22개 함수 (KRX 15 + Naver 1 + OPENDART 6) 구현 및 테스트
2. **MDCSTAT04701 우선순위**: 종합 ETF 정보 엔드포인트 완전 작동
3. **pykrx 호환성**: 중복 엔드포인트에 대한 1:1 출력 일치
4. **백테스트 준비**: 자동 분할로 상장일부터 과거 데이터 검색
5. **문서화**: 완전한 API 문서, 사용 예제, 필드 매핑
6. **테스트 커버리지**: > 80% 단위 테스트 커버리지, 모든 엔드포인트에 대한 통합 테스트
7. **성능**: 부하 상태에서 지연 시간 목표 충족

## 다음 단계

1. **Phase 1**: MDCSTAT04701 구현 (`05-구현-로드맵.md` 참조)
2. **Phase 2**: pykrx에 없는 나머지 ETF 엔드포인트 완료
3. **Phase 3**: 백테스트 중심 헬퍼 API 추가
4. **Phase 4**: 포괄적인 테스트 및 문서화
5. **Phase 5**: 프로덕션 배포 및 모니터링

## 참조

- pykrx 소스 코드: `/vendor/pykrx/pykrx/website/krx/etx/core.py`
- KRX 데이터 포털: http://data.krx.co.kr/
- Kotlin 코딩 규칙: https://kotlinlang.org/docs/coding-conventions.html
- Spring Boot 레퍼런스: https://docs.spring.io/spring-boot/docs/current/reference/html/
