# KRX ETF API 함수 시그니처 카탈로그

> **API 인터페이스**: `KrxEtfApi` (소스: KRX, 상품: ETF)
> **패키지**: `io.github.ulalax.krx.api.krx`
> **설계 원칙**: KRX API 엔드포인트 1:1 매핑
> **라이브러리 책임**: KRX API 호출 및 Raw Data 반환
> **애플리케이션 책임**: 비즈니스 로직, 데이터 조합, ETL 처리

---

## 목차

1. [ETF 목록 및 기본 정보](#1-etf-목록-및-기본-정보)
2. [ETF 시세 및 OHLCV](#2-etf-시세-및-ohlcv)
3. [ETF 포트폴리오 구성](#3-etf-포트폴리오-구성)
4. [ETF 성과 및 추적](#4-etf-성과-및-추적)
5. [투자자별 거래](#5-투자자별-거래)
6. [공매도 데이터](#6-공매도-데이터)
7. [조정 가격 (Naver API)](#7-조정-가격-naver-api)

---

## 1. ETF 목록 및 기본 정보

### 1.1 `getEtfList()` - 전체 ETF 목록 조회

**KRX API**: MDCSTAT04601 - ETF 전종목 기본정보

**목적**: 상장된 모든 ETF의 기본 메타데이터를 한 번에 조회

**사용 사례**:
- 초기 DB 구축 (티커 목록 수집)
- 신규 상장 ETF 감지
- ETF 마스터 데이터 갱신

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
interface KrxEtfApi {
    suspend fun getEtfList(): List<EtfListItem>
}
```

**파라미터**: 없음 (모든 ETF 반환)

**반환 데이터**:
```kotlin
data class EtfListItem(
    val isin: String,              // ISU_CD: KR7152100004
    val ticker: String,            // ISU_SRT_CD: 152100
    val name: String,              // ISU_ABBRV: ARIRANG 200
    val fullName: String,          // ISU_NM: 전체 공식명
    val englishName: String,       // ISU_ENG_NM
    val listingDate: LocalDate,    // LIST_DD: 2018/03/20
    val benchmarkIndex: String,    // ETF_OBJ_IDX_NM: 코스피 200
    val indexProvider: String,     // IDX_CALC_INST_NM1: KRX
    val leverageType: String?,     // IDX_CALC_INST_NM2: 2X 레버리지 (2)
    val replicationMethod: String, // ETF_REPLICA_METHD_TP_CD: 실물/합성
    val marketType: String,        // IDX_MKT_CLSS_NM: 국내/해외
    val assetClass: String,        // IDX_ASST_CLSS_NM: 주식/채권/상품/파생
    val listedShares: Long,        // LIST_SHRS: 500,000
    val assetManager: String,      // COM_ABBRV: 디비자산운용
    val cuQuantity: Long,          // CU_QTY: 100,000
    val totalExpenseRatio: BigDecimal, // ETF_TOT_FEE: 0.510
    val taxType: String            // TAX_TP_CD: 배당소득세(보유기간과세)
)
```

**KRX API 매핑**:
```
요청: POST /comm/bldAttendant/getJsonData.cmd
Body: { bld: "dbms/MDC/STAT/standard/MDCSTAT04601" }
응답: { output: [...] }
```

---

### 1.2 `getEtfDetail()` - 개별 ETF 종합 정보 조회 ⭐

**KRX API**: MDCSTAT04701 - ETF 개별종목 종합정보

**목적**: 단일 ETF의 모든 정보를 한 번에 조회 (OHLCV + 메타데이터 + 52주 고가/저가)

**사용 사례**:
- ETF 상세 페이지 데이터 수집
- 일일 마스터 데이터 갱신
- 단일 요청으로 최대 정보 획득

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
interface KrxEtfApi {
    suspend fun getEtfDetail(
        isin: String,
        date: LocalDate
    ): EtfDetail
}
```

**파라미터**:
- `isin`: ETF ISIN 코드 (예: "KR7152100004")
- `date`: 조회 날짜

**반환 데이터**:
```kotlin
data class EtfDetail(
    // 기본 정보 (MDCSTAT04601과 동일)
    val isin: String,
    val ticker: String,
    val name: String,
    val listingDate: LocalDate,
    val assetManager: String,
    val totalExpenseRatio: BigDecimal,
    val benchmarkIndex: String,
    val assetClass: String,
    val listedShares: Long,

    // 가격 정보 (MDCSTAT04501과 동일)
    val tradeDate: LocalDate,      // TRD_DD
    val openPrice: Int,            // TDD_OPNPRC
    val highPrice: Int,            // TDD_HGPRC
    val lowPrice: Int,             // TDD_LWPRC
    val closePrice: Int,           // TDD_CLSPRC
    val volume: Long,              // ACC_TRDVOL
    val tradingValue: Long,        // ACC_TRDVAL
    val nav: BigDecimal,           // LST_NAV
    val marketCap: Long,           // MKTCAP

    // 지수 정보
    val indexName: String,         // IDX_IND_NM
    val indexValue: BigDecimal,    // OBJ_STKPRC_IDX

    // 추가 정보 (04701 전용)
    val week52High: Int,           // WK52_HGPR: 52주 고가
    val week52Low: Int,            // WK52_LWPR: 52주 저가
    val priceChange: Int,          // CMPPREVDD_PRC
    val priceChangeRate: Double,   // FLUC_RT
    val navChange: BigDecimal,     // NAV 변화액
    val navChangeRate: Double      // NAV 변화율
)
```

**KRX API 매핑**:
```
요청: POST /comm/bldAttendant/getJsonData.cmd
Body: {
  bld: "dbms/MDC/STAT/standard/MDCSTAT04701",
  trdDd: "20240102",
  isuCd: "KR7152100004"
}
응답: { output: [{ ...30+ fields }] }
```

---

### 1.3 `searchEtf()` - ETF 검색

**KRX API**: finder_secuprodisu - 상장종목검색

**목적**: 종목명으로 ETF 검색 (드롭다운, 자동완성용)

**사용 사례**:
- UI 자동완성
- 티커 검증
- 이름 기반 검색

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
    suspend fun searchEtf(
    searchTerm: String = ""
): List<EtfSearchResult>
```

**파라미터**:
- `searchTerm`: 검색어 (빈 문자열 = 전체 조회)

**반환 데이터**:
```kotlin
data class EtfSearchResult(
    val isin: String,      // full_code: KR7152100004
    val ticker: String,    // short_code: 152100
    val name: String       // codeName: ARIRANG 200
)
```

**KRX API 매핑**:
```
요청: POST /comm/bldAttendant/getJsonData.cmd
Body: {
  bld: "dbms/comm/finder/finder_secuprodisu",
  mktsel: "ETF",
  searchText: "KODEX"
}
응답: { block1: [...] }
```

---

## 2. ETF 시세 및 OHLCV

### 2.1 `getEtfOhlcv()` - 개별 ETF OHLCV 조회

**KRX API**: MDCSTAT04501 - 개별종목 시세 추이

**목적**: 단일 ETF의 과거 OHLCV 데이터 조회

**사용 사례**:
- 가격 차트 생성
- 백테스팅 데이터 수집
- 기술적 분석

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
    suspend fun getEtfOhlcv(
    isin: String,
    fromDate: LocalDate,
    toDate: LocalDate
): List<EtfOhlcv>
```

**파라미터**:
- `isin`: ETF ISIN 코드
- `fromDate`: 시작 날짜
- `toDate`: 종료 날짜 (최대 730일)

**날짜 범위 제한**:
- KRX API는 요청당 최대 730일 지원
- 더 긴 범위는 라이브러리가 자동 분할 처리

**반환 데이터**:
```kotlin
data class EtfOhlcv(
    val tradeDate: LocalDate,      // TRD_DD
    val openPrice: Int,            // TDD_OPNPRC (원본, 조정 안됨)
    val highPrice: Int,            // TDD_HGPRC (원본, 조정 안됨)
    val lowPrice: Int,             // TDD_LWPRC (원본, 조정 안됨)
    val closePrice: Int,           // TDD_CLSPRC (원본, 조정 안됨)
    val volume: Long,              // ACC_TRDVOL
    val tradingValue: Long,        // ACC_TRDVAL: 거래대금
    val nav: BigDecimal,           // LST_NAV: 순자산가치
    val priceChange: Int,          // CMPPREVDD_PRC: 전일 대비
    val priceChangeRate: Double,   // FLUC_RT: 등락률 %
    val marketCap: Long,           // MKTCAP: 시가총액
    val netAsset: Long,            // INVSTASST_NETASST_TOTAMT
    val listedShares: Long,        // LIST_SHRS
    val indexName: String,         // IDX_IND_NM: 지수명
    val indexValue: BigDecimal,    // OBJ_STKPRC_IDX: 지수 값
    val indexChange: BigDecimal,   // CMPPREVDD_IDX
    val indexChangeRate: Double    // IDX_FLUC_RT: 지수 등락률 %
)
```

**KRX API 매핑**:
```
요청: POST /comm/bldAttendant/getJsonData.cmd
Body: {
  bld: "dbms/MDC/STAT/standard/MDCSTAT04501",
  strtDd: "20240101",
  endDd: "20240131",
  isuCd: "KR7152100004"
}
응답: { output: [...] }
```

---

### 2.2 `getAllEtfDailyPrices()` - 전체 ETF 일별 시세 조회

**KRX API**: MDCSTAT04301 - 전종목 시세 (일자별 전종목)

**목적**: 특정 날짜의 모든 ETF 시세를 한 번에 조회

**사용 사례**:
- 일일 시장 스냅샷
- ETF 스크리너
- 히트맵 데이터

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
    suspend fun getAllEtfDailyPrices(
    date: LocalDate
): List<EtfDailyPrice>
```

**파라미터**:
- `date`: 조회 날짜

**반환 데이터**:
```kotlin
data class EtfDailyPrice(
    val ticker: String,            // ISU_SRT_CD
    val name: String,              // ISU_ABBRV
    val closePrice: Int,           // TDD_CLSPRC
    val priceChange: Int,          // CMPPREVDD_PRC
    val priceChangeRate: Double,   // FLUC_RT
    val nav: BigDecimal,           // NAV
    val openPrice: Int,            // TDD_OPNPRC
    val highPrice: Int,            // TDD_HGPRC
    val lowPrice: Int,             // TDD_LWPRC
    val volume: Long,              // ACC_TRDVOL
    val tradingValue: Long,        // ACC_TRDVAL
    val marketCap: Long,           // MKTCAP
    val listedShares: Long,        // LIST_SHRS
    val indexName: String,         // IDX_IND_NM
    val indexValue: BigDecimal,    // OBJ_STKPRC_IDX
    val indexChange: BigDecimal,   // CMPPREVDD_IDX
    val indexChangeRate: Double    // FLUC_RT1
)
```

**KRX API 매핑**:
```
요청: POST /comm/bldAttendant/getJsonData.cmd
Body: {
  bld: "dbms/MDC/STAT/standard/MDCSTAT04301",
  trdDd: "20240102"
}
응답: { output: [...] }  // 모든 ETF
```

---

### 2.3 `getEtfPriceChanges()` - ETF 등락률 조회

**KRX API**: MDCSTAT04401 - 전종목 등락률 (기간별 등락률)

**목적**: 특정 기간의 모든 ETF 가격 변화 조회

**사용 사례**:
- 성과 비교
- 순위 생성
- 기간 수익률 분석

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
    suspend fun getEtfPriceChanges(
    fromDate: LocalDate,
    toDate: LocalDate
): List<EtfPriceChange>
```

**파라미터**:
- `fromDate`: 시작 날짜
- `toDate`: 종료 날짜

**반환 데이터**:
```kotlin
data class EtfPriceChange(
    val ticker: String,            // ISU_SRT_CD
    val name: String,              // ISU_ABBRV
    val startPrice: Int,           // BAS_PRC
    val endPrice: Int,             // CLSPRC
    val priceChange: Int,          // CMP_PRC
    val changeRate: Double,        // FLUC_RT: 등락률 %
    val totalVolume: Long,         // ACC_TRDVOL: 누적 거래량
    val totalTradingValue: Long    // ACC_TRDVAL: 누적 거래대금
)
```

**KRX API 매핑**:
```
요청: POST /comm/bldAttendant/getJsonData.cmd
Body: {
  bld: "dbms/MDC/STAT/standard/MDCSTAT04401",
  strtDd: "20240101",
  endDd: "20240105"
}
응답: { output: [...] }
```

---

## 3. ETF 포트폴리오 구성

### 3.1 `getEtfPortfolio()` - ETF 포트폴리오 구성 종목 조회

**KRX API**: MDCSTAT05001 - PDF (Portfolio Deposit File)

**목적**: ETF 바스켓 구성 종목 및 비중 조회

**사용 사례**:
- 포트폴리오 분석
- 복제 전략
- 구성 종목 추적

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
    suspend fun getEtfPortfolio(
    isin: String,
    date: LocalDate
): List<PortfolioConstituent>
```

**파라미터**:
- `isin`: ETF ISIN 코드
- `date`: 조회 날짜

**반환 데이터**:
```kotlin
data class PortfolioConstituent(
    val constituentCode: String,   // COMPST_ISU_CD (혼합 ISIN/티커)
    val constituentName: String,   // COMPST_ISU_NM
    val sharesPerCu: BigDecimal,   // COMPST_ISU_CU1_SHRS: CU당 주식 수
    val value: Long,               // VALU_AMT: 가치 (원)
    val constituentAmount: Long,   // COMPST_AMT: 구성금액
    val weightPercent: BigDecimal  // COMPST_RTO: 비중 %
)
```

**알려진 이슈**:
- `constituentCode`는 ISIN과 티커가 혼재
- ISIN 형식인 경우 `substring(3, 9)`로 티커 추출 필요
- `value == 0`인 항목은 제외 필요

**KRX API 매핑**:
```
요청: POST /comm/bldAttendant/getJsonData.cmd
Body: {
  bld: "dbms/MDC/STAT/standard/MDCSTAT05001",
  trdDd: "20240102",
  isuCd: "KR7152100004"
}
응답: { output: [...] }
```

**사용 예제 (티커 추출)**:
```kotlin
val portfolio = getEtfPortfolio("KR7152100004", LocalDate.of(2024, 1, 2))

val cleanedPortfolio = portfolio
    .filter { it.value > 0 }  // 가치 0인 항목 제거
    .map { constituent ->
        val ticker = if (constituent.constituentCode.startsWith("KR")) {
            constituent.constituentCode.substring(3, 9)  // ISIN → 티커
        } else {
            constituent.constituentCode
        }
        constituent.copy(constituentCode = ticker)
    }
```

---

## 4. ETF 성과 및 추적

### 4.1 `getEtfTrackingError()` - ETF 추적 오차 조회

**KRX API**: MDCSTAT05901 - 추적오차율 추이

**목적**: ETF와 벤치마크 지수 간의 추적 오차 조회

**사용 사례**:
- ETF 품질 평가
- 추적 효율성 분석
- 펀드 비교

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
    suspend fun getEtfTrackingError(
    isin: String,
    fromDate: LocalDate,
    toDate: LocalDate
): List<TrackingError>
```

**파라미터**:
- `isin`: ETF ISIN 코드
- `fromDate`: 시작 날짜
- `toDate`: 종료 날짜

**반환 데이터**:
```kotlin
data class TrackingError(
    val tradeDate: LocalDate,      // TRD_DD
    val nav: BigDecimal,           // LST_NAV
    val navChangeRate: Double,     // NAV_CHG_RT: NAV 변화율 %
    val indexValue: BigDecimal,    // OBJ_STKPRC_IDX
    val indexChangeRate: Double,   // IDX_CHG_RTO: 지수 변화율 %
    val trackingMultiple: BigDecimal, // TRACE_YD_MULT: 추적 배수
    val trackingErrorRate: Double  // TRACE_ERR_RT: 추적 오차율 %
)
```

**KRX API 매핑**:
```
요청: POST /comm/bldAttendant/getJsonData.cmd
Body: {
  bld: "dbms/MDC/STAT/standard/MDCSTAT05901",
  strtDd: "20240101",
  endDd: "20240131",
  isuCd: "KR7152100004"
}
응답: { output: [...] }
```

---

### 4.2 `getEtfDivergenceRate()` - ETF 괴리율 조회

**KRX API**: MDCSTAT06001 - 괴리율 추이

**목적**: ETF 가격과 NAV 간의 괴리율 조회

**사용 사례**:
- 차익거래 기회 발견
- 가격 효율성 평가
- 시장 왜곡 감지

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
    suspend fun getEtfDivergenceRate(
    isin: String,
    fromDate: LocalDate,
    toDate: LocalDate
): List<DivergenceRate>
```

**파라미터**:
- `isin`: ETF ISIN 코드
- `fromDate`: 시작 날짜
- `toDate`: 종료 날짜

**반환 데이터**:
```kotlin
data class DivergenceRate(
    val tradeDate: LocalDate,      // TRD_DD
    val closePrice: Int,           // CLSPRC
    val nav: BigDecimal,           // LST_NAV
    val divergenceRate: Double     // DIVRG_RT: 괴리율 %
)
```

**공식**: `divergenceRate = ((closePrice - nav) / nav) * 100`

**KRX API 매핑**:
```
요청: POST /comm/bldAttendant/getJsonData.cmd
Body: {
  bld: "dbms/MDC/STAT/standard/MDCSTAT06001",
  strtDd: "20240101",
  endDd: "20240131",
  isuCd: "KR7152100004"
}
응답: { output: [...] }
```

---

## 5. 투자자별 거래

### 5.1 `getAllEtfInvestorTrading()` - 전체 ETF 투자자별 거래 조회

**KRX API**: MDCSTAT04801 - ETF 투자자별 거래실적 (기간합계)

**목적**: 모든 ETF의 투자자 유형별 거래 현황 조회

**사용 사례**:
- 시장 전체 투자자 동향 파악
- 기관/개인/외국인 순매수 현황
- 시장 심리 분석

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
    suspend fun getAllEtfInvestorTrading(
    date: LocalDate
): List<InvestorTrading>
```

**파라미터**:
- `date`: 조회 날짜 (단일 날짜만 지원)

**반환 데이터**:
```kotlin
data class InvestorTrading(
    val investorType: String,      // INVST_TP_NM: 투자자 유형
    val askVolume: Long,           // ASK_TRDVOL: 매도 거래량
    val askValue: Long,            // ASK_TRDVAL: 매도 거래대금
    val bidVolume: Long,           // BID_TRDVOL: 매수 거래량
    val bidValue: Long,            // BID_TRDVAL: 매수 거래대금
    val netBuyVolume: Long,        // NETBID_TRDVOL: 순매수 거래량
    val netBuyValue: Long          // NETBID_TRDVAL: 순매수 거래대금
)
```

**투자자 유형 (13개)**:
```
금융투자, 보험, 투신, 사모, 은행, 기타금융, 연기금,
기관합계, 기타법인, 개인, 외국인, 기타외국인, 전체
```

**KRX API 매핑**:
```
요청: POST /comm/bldAttendant/getJsonData.cmd
Body: {
  bld: "dbms/MDC/STAT/standard/MDCSTAT04801",
  strtDd: "20240102",
  endDd: "20240102"
}
응답: { output: [...] }
```

---

### 5.2 `getAllEtfInvestorTradingByPeriod()` - 전체 ETF 투자자별 거래 (기간)

**KRX API**: MDCSTAT04802 - ETF 투자자별 거래실적 (기간별)

**목적**: 기간별 모든 ETF의 투자자 유형별 거래 추이

**사용 사례**:
- 투자자 거래 패턴 분석
- 장기 추세 파악

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
    suspend fun getAllEtfInvestorTradingByPeriod(
    fromDate: LocalDate,
    toDate: LocalDate
): List<InvestorTradingByDate>
```

**파라미터**:
- `fromDate`: 시작 날짜
- `toDate`: 종료 날짜

**반환 데이터**:
```kotlin
data class InvestorTradingByDate(
    val tradeDate: LocalDate,      // TRD_DD
    val investorType: String,      // INVST_TP_NM
    val askVolume: Long,           // ASK_TRDVOL
    val askValue: Long,            // ASK_TRDVAL
    val bidVolume: Long,           // BID_TRDVOL
    val bidValue: Long,            // BID_TRDVAL
    val netBuyVolume: Long,        // NETBID_TRDVOL
    val netBuyValue: Long          // NETBID_TRDVAL
)
```

**KRX API 매핑**:
```
요청: POST /comm/bldAttendant/getJsonData.cmd
Body: {
  bld: "dbms/MDC/STAT/standard/MDCSTAT04802",
  strtDd: "20240101",
  endDd: "20240131"
}
응답: { output: [...] }
```

---

### 5.3 `getEtfInvestorTrading()` - 개별 ETF 투자자별 거래 조회

**KRX API**: MDCSTAT04901 - 개별 종목 투자자별 거래실적 (기간합계)

**목적**: 특정 ETF의 투자자 유형별 거래 현황

**사용 사례**:
- 개별 ETF 투자자 동향
- 종목별 수급 분석

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
    suspend fun getEtfInvestorTrading(
    isin: String,
    date: LocalDate
): List<InvestorTrading>
```

**파라미터**:
- `isin`: ETF ISIN 코드
- `date`: 조회 날짜

**반환 데이터**: `InvestorTrading` (5.1과 동일)

**KRX API 매핑**:
```
요청: POST /comm/bldAttendant/getJsonData.cmd
Body: {
  bld: "dbms/MDC/STAT/standard/MDCSTAT04901",
  strtDd: "20240102",
  endDd: "20240102",
  isuCd: "KR7152100004"
}
응답: { output: [...] }
```

---

### 5.4 `getEtfInvestorTradingByPeriod()` - 개별 ETF 투자자별 거래 (기간)

**KRX API**: MDCSTAT04902 - 개별 종목 투자자별 거래실적 (기간별)

**목적**: 특정 ETF의 기간별 투자자 거래 추이

**사용 사례**:
- 투자자별 거래 패턴 추적
- 시계열 분석

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
    suspend fun getEtfInvestorTradingByPeriod(
    isin: String,
    fromDate: LocalDate,
    toDate: LocalDate
): List<InvestorTradingByDate>
```

**파라미터**:
- `isin`: ETF ISIN 코드
- `fromDate`: 시작 날짜
- `toDate`: 종료 날짜

**반환 데이터**: `InvestorTradingByDate` (5.2와 동일)

**KRX API 매핑**:
```
요청: POST /comm/bldAttendant/getJsonData.cmd
Body: {
  bld: "dbms/MDC/STAT/standard/MDCSTAT04902",
  strtDd: "20240101",
  endDd: "20240131",
  isuCd: "KR7152100004"
}
응답: { output: [...] }
```

---

## 6. 공매도 데이터

### 6.1 `getEtfShortSelling()` - ETF 공매도 거래 조회

**KRX API**: MDCSTAT31401 - 공매도 거래 (종목별)

**목적**: 개별 ETF의 공매도 거래 현황

**사용 사례**:
- 공매도 거래량/대금 추적
- 시장 심리 분석

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
    suspend fun getEtfShortSelling(
    isin: String,
    fromDate: LocalDate,
    toDate: LocalDate
): List<ShortSelling>
```

**파라미터**:
- `isin`: ETF ISIN 코드
- `fromDate`: 시작 날짜
- `toDate`: 종료 날짜

**반환 데이터**:
```kotlin
data class ShortSelling(
    val tradeDate: LocalDate,      // TRD_DD
    val ticker: String,            // ISU_SRT_CD
    val name: String,              // ISU_ABBRV
    val shortVolume: Long,         // CVSRTSELL_TRDVOL: 공매도 거래량
    val shortValue: Long,          // CVSRTSELL_TRDVAL: 공매도 거래대금
    val totalVolume: Long,         // ACC_TRDVOL: 전체 거래량
    val totalValue: Long,          // ACC_TRDVAL: 전체 거래대금
    val shortVolumeRatio: Double,  // VALU_PD_AVG_VRSS_TRD_WT: 거래량 비중 %
    val shortValueRatio: Double    // VALU_PD_AVG_VRSS_CVSRTSELL_WT: 거래대금 비중 %
)
```

**KRX API 매핑**:
```
요청: POST /comm/bldAttendant/getJsonData.cmd
Body: {
  bld: "dbms/MDC/STAT/standard/MDCSTAT31401",
  strtDd: "20240101",
  endDd: "20240131",
  isuCd: "KR7152100004"
}
응답: { output: [...] }
```

---

### 6.2 `getEtfShortBalance()` - ETF 공매도 잔고 조회

**KRX API**: MDCSTAT31501 - 공매도 잔고 (종목별)

**목적**: 개별 ETF의 공매도 잔고 현황

**사용 사례**:
- 공매도 포지션 추적
- 숏 커버링 가능성 분석

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
    suspend fun getEtfShortBalance(
    isin: String,
    fromDate: LocalDate,
    toDate: LocalDate
): List<ShortBalance>
```

**파라미터**:
- `isin`: ETF ISIN 코드
- `fromDate`: 시작 날짜
- `toDate`: 종료 날짜

**반환 데이터**:
```kotlin
data class ShortBalance(
    val tradeDate: LocalDate,      // TRD_DD
    val ticker: String,            // ISU_SRT_CD
    val name: String,              // ISU_ABBRV
    val shortBalance: Long,        // CVSRTSELL_RQTY: 공매도 잔고 수량
    val shortBalanceValue: Long,   // CVSRTSELL_RQTY_VAL: 공매도 잔고 금액
    val listedShares: Long,        // LIST_SHRS: 상장 주식 수
    val shortBalanceRatio: Double  // CVSRTSELL_RQTY_RT: 잔고 비율 %
)
```

**KRX API 매핑**:
```
요청: POST /comm/bldAttendant/getJsonData.cmd
Body: {
  bld: "dbms/MDC/STAT/standard/MDCSTAT31501",
  strtDd: "20240101",
  endDd: "20240131",
  isuCd: "KR7152100004"
}
응답: { output: [...] }
```

---

## 7. 조정 가격 (Naver API)

### 7.1 `getAdjustedClose()` - 조정 종가 조회 (배당+분할 반영)

**데이터 소스**: Naver Finance Chart API

**목적**: 배당금 및 주식 분할이 반영된 조정 종가 조회

**사용 사례**:
- 백테스팅용 조정 가격 데이터 수집
- Corporate Actions 반영 검증
- 기술적 지표 계산 기준 데이터

**함수 시그니처**:
```kotlin
interface KrxEtfApi {
    suspend fun getAdjustedClose(
    ticker: String,
    fromDate: LocalDate,
    toDate: LocalDate
): List<AdjustedClose>
```

**파라미터**:
- `ticker`: ETF 티커 (6자리, 예: "152100")
- `fromDate`: 시작 날짜
- `toDate`: 종료 날짜

**반환 데이터**:
```kotlin
data class AdjustedClose(
    val tradeDate: LocalDate,      // 거래일
    val closePrice: Int,           // 원본 종가 (조정 안됨)
    val adjustedClose: BigDecimal, // 조정 종가 (배당+분할 반영)
    val volume: Long               // 거래량
)
```

**Naver API 매핑**:
```
요청: GET https://fchart.stock.naver.com/sise.nhn
쿼리 파라미터:
  symbol={ticker}      # 152100
  timeframe=day        # 일봉
  count=500            # 최대 500일
  requestType=0        # 조정 가격

응답: 파이프(|) 구분 텍스트
날짜|시가|고가|저가|종가|거래량|조정종가
20240102|35500|35600|35400|35550|1234567|35550
```

**응답 파싱 로직**:
```kotlin
interface KrxEtfApi {
    suspend fun parseNaverChartResponse(response: String): List<AdjustedClose> {
    return response.split("\n")
        .drop(1)  // 헤더 제거
        .filter { it.isNotBlank() }
        .map { line ->
            val fields = line.split("|")
            AdjustedClose(
                tradeDate = LocalDate.parse(fields[0], DateTimeFormatter.ofPattern("yyyyMMdd")),
                closePrice = fields[4].toInt(),
                adjustedClose = fields[6].toBigDecimal(),
                volume = fields[5].toLong()
            )
        }
}
```

**주의사항**:
- Naver API는 최대 500일 데이터만 반환
- 더 긴 기간은 여러 번 요청 필요
- Rate limiting 필요 (권장: 100ms delay)
- KRX OHLCV와 결합하여 조정 OHLC 계산 가능

**사용 예제**:
```kotlin
class AdjustedPriceCollector(
    private val krxClient: KrxApiClient,
    private val naverClient: NaverApiClient
) {
interface KrxEtfApi {
    suspend fun collectAdjustedPrices(ticker: String, date: LocalDate) {
        // 1. KRX에서 원본 OHLCV 조회
        val ohlcv = krxClient.getEtfOhlcv(
            isin = "KR7${ticker}004",
            fromDate = date,
            toDate = date
        ).first()

        // 2. Naver에서 조정 종가 조회
        val adjusted = naverClient.getAdjustedClose(
            ticker = ticker,
            fromDate = date,
            toDate = date
        ).first()

        // 3. 조정 인수 계산
        val adjustmentFactor = adjusted.adjustedClose.divide(
            ohlcv.closePrice.toBigDecimal(),
            6,
            RoundingMode.HALF_UP
        )

        // 4. 조정 OHLC 계산
        val adjustedOhlc = AdjustedOhlc(
            tradeDate = date,
            adjustedOpen = (ohlcv.openPrice.toBigDecimal() * adjustmentFactor),
            adjustedHigh = (ohlcv.highPrice.toBigDecimal() * adjustmentFactor),
            adjustedLow = (ohlcv.lowPrice.toBigDecimal() * adjustmentFactor),
            adjustedClose = adjusted.adjustedClose,
            volume = ohlcv.volume
        )

        // 5. DB 저장
        database.insert("etf_daily_prices", adjustedOhlc)
    }
}
```

**대안: 장기 데이터 수집 (500일 초과)**:
```kotlin
suspend fun collectLongTermAdjustedPrices(
    ticker: String,
    fromDate: LocalDate,
    toDate: LocalDate
): List<AdjustedClose> {
    val allData = mutableListOf<AdjustedClose>()
    var currentDate = toDate
    val limit = 500

    while (currentDate.isAfter(fromDate)) {
        val data = naverClient.getAdjustedClose(
            ticker = ticker,
            fromDate = fromDate,
            toDate = currentDate
        )

        allData.addAll(data)

        // 마지막 날짜에서 1일 전으로 이동
        currentDate = data.minOf { it.tradeDate }.minusDays(1)

        delay(100) // Rate limiting

        // 500일 미만이면 종료
        if (data.size < limit) break
    }

    return allData.distinctBy { it.tradeDate }
        .sortedBy { it.tradeDate }
}
```

---

## 애플리케이션 레이어 사용 예제

### 예제 1: ETF 마스터 데이터 초기 수집

```kotlin
class EtfMasterCollector(
    private val krxClient: KrxApiClient
) {
interface KrxEtfApi {
    suspend fun collectAllEtfMasters(): List<EtfMaster> {
        // 1. 전체 ETF 목록 조회
        val etfList = krxClient.getEtfList()

        val today = LocalDate.now()
        val masters = mutableListOf<EtfMaster>()

        // 2. 각 ETF별로 상세 정보 조회
        etfList.forEach { item ->
            delay(100) // Rate limiting: 10 req/sec

            try {
                val detail = krxClient.getEtfDetail(
                    isin = item.isin,
                    date = today
                )

                // 3. EtfList + EtfDetail 조합
                masters.add(
                    EtfMaster(
                        ticker = item.ticker,
                        isin = item.isin,
                        name = item.name,
                        issuer = detail.assetManager,
                        listingDate = detail.listingDate,
                        expenseRatio = detail.totalExpenseRatio,
                        aum = detail.marketCap.toBigDecimal(),
                        benchmarkIndex = detail.benchmarkIndex,
                        category = detail.assetClass,
                        outstandingShares = detail.listedShares,
                        week52High = detail.week52High,
                        week52Low = detail.week52Low
                    )
                )
            } catch (e: Exception) {
                logger.error("Failed to fetch detail for ${item.ticker}", e)
            }
        }

        return masters
    }
}
```

### 예제 2: 일별 OHLCV 데이터 수집

```kotlin
class DailyOhlcvCollector(
    private val krxClient: KrxApiClient,
    private val database: Database
) {
interface KrxEtfApi {
    suspend fun collectDailyOhlcv(date: LocalDate) {
        // 1. DB에서 활성 ETF 티커 목록 조회
        val activeTickers = database.query(
            "SELECT isin, ticker FROM etf_masters WHERE status = 1"
        )

        // 2. 각 ETF별로 OHLCV 수집
        activeTickers.forEach { (isin, ticker) ->
            delay(100) // Rate limiting

            try {
                val ohlcvList = krxClient.getEtfOhlcv(
                    isin = isin,
                    fromDate = date,
                    toDate = date
                )

                // 3. DB 저장 (eod_prices 테이블)
                ohlcvList.forEach { ohlcv ->
                    database.insert("eod_prices", mapOf(
                        "ticker" to ticker,
                        "trade_date" to ohlcv.tradeDate,
                        "open_price" to ohlcv.openPrice,
                        "high_price" to ohlcv.highPrice,
                        "low_price" to ohlcv.lowPrice,
                        "close_price" to ohlcv.closePrice,
                        "volume" to ohlcv.volume,
                        "nav" to ohlcv.nav,
                        "trading_value" to ohlcv.tradingValue
                    ))
                }
            } catch (e: Exception) {
                logger.error("Failed to fetch OHLCV for $ticker", e)
            }
        }
    }
}
```

### 예제 3: 포트폴리오 분석

```kotlin
class PortfolioAnalyzer(
    private val krxClient: KrxApiClient
) {
interface KrxEtfApi {
    suspend fun analyzePortfolio(ticker: String, date: LocalDate): PortfolioAnalysis {
        val etfList = krxClient.getEtfList()
        val etf = etfList.find { it.ticker == ticker }
            ?: throw IllegalArgumentException("ETF not found: $ticker")

        // 1. 포트폴리오 구성 조회
        val portfolio = krxClient.getEtfPortfolio(
            isin = etf.isin,
            date = date
        )

        // 2. 티커 추출 및 정제
        val constituents = portfolio
            .filter { it.value > 0 }
            .map { constituent ->
                val constituentTicker = if (constituent.constituentCode.startsWith("KR")) {
                    constituent.constituentCode.substring(3, 9)
                } else {
                    constituent.constituentCode
                }

                PortfolioItem(
                    ticker = constituentTicker,
                    name = constituent.constituentName,
                    weightPercent = constituent.weightPercent,
                    value = constituent.value
                )
            }
            .sortedByDescending { it.weightPercent }

        // 3. 분석 결과 반환
        return PortfolioAnalysis(
            etfTicker = ticker,
            asOfDate = date,
            totalConstituents = constituents.size,
            top10Concentration = constituents.take(10).sumOf { it.weightPercent },
            constituents = constituents
        )
    }
}
```

### 예제 4: 투자자 거래 분석

```kotlin
class InvestorTradingAnalyzer(
    private val krxClient: KrxApiClient
) {
interface KrxEtfApi {
    suspend fun analyzeMarketSentiment(date: LocalDate): MarketSentiment {
        // 전체 ETF 투자자 거래 조회
        val trading = krxClient.getAllEtfInvestorTrading(date)

        // 투자자 유형별 순매수 집계
        val foreignNet = trading.find { it.investorType == "외국인" }?.netBuyValue ?: 0L
        val institutionNet = trading.find { it.investorType == "기관합계" }?.netBuyValue ?: 0L
        val individualNet = trading.find { it.investorType == "개인" }?.netBuyValue ?: 0L

        return MarketSentiment(
            date = date,
            foreignNetBuy = foreignNet,
            institutionNetBuy = institutionNet,
            individualNetBuy = individualNet,
            marketTrend = when {
                foreignNet > 0 && institutionNet > 0 -> "강세"
                foreignNet < 0 && institutionNet < 0 -> "약세"
                else -> "혼조"
            }
        )
    }
}
```

---

## 라이브러리 구조

```
kotlin-krx/
├── src/main/kotlin/io/github/ulalax/krx/
│   ├── api/
│   │   ├── KrxApiClient.kt          # KRX API 15개 함수 인터페이스
│   │   └── NaverApiClient.kt        # Naver API 1개 함수 인터페이스
│   ├── model/
│   │   ├── EtfListItem.kt
│   │   ├── EtfDetail.kt
│   │   ├── EtfOhlcv.kt
│   │   ├── PortfolioConstituent.kt
│   │   ├── TrackingError.kt
│   │   ├── DivergenceRate.kt
│   │   ├── InvestorTrading.kt
│   │   ├── ShortSelling.kt
│   │   ├── ShortBalance.kt
│   │   └── AdjustedClose.kt         # Naver API 모델
│   └── internal/
│       ├── KrxApiClientImpl.kt      # KRX API HTTP 호출
│       ├── KrxDataParser.kt         # KRX 응답 파싱
│       ├── NaverApiClientImpl.kt    # Naver API HTTP 호출
│       └── NaverDataParser.kt       # Naver 응답 파싱
└── README.md
```

---

## Rate Limiting 권장사항

KRX API는 공식적인 rate limit을 명시하지 않지만, 안전한 사용을 위해:

- **권장**: 10 requests/second
- **구현**: 애플리케이션 레이어에서 `delay(100)` 사용
- **배치 수집**: 야간/새벽 시간대 활용

---

## 요약

| 카테고리 | 함수 수 | 데이터 소스 | 주요 함수 |
|---------|--------|-----------|----------|
| ETF 목록/정보 | 3 | KRX API | getEtfList(), getEtfDetail(), searchEtf() |
| 시세/OHLCV | 3 | KRX API | getEtfOhlcv(), getAllEtfDailyPrices(), getEtfPriceChanges() |
| 포트폴리오 | 1 | KRX API | getEtfPortfolio() |
| 성과/추적 | 2 | KRX API | getEtfTrackingError(), getEtfDivergenceRate() |
| 투자자 거래 | 4 | KRX API | getAllEtfInvestorTrading(), getEtfInvestorTrading() 등 |
| 공매도 | 2 | KRX API | getEtfShortSelling(), getEtfShortBalance() |
| 조정 가격 | 1 | Naver API | getAdjustedClose() |
| **합계** | **16** | | |

**설계 철학**:
- ✅ KRX API 1:1 매핑
- ✅ Naver API 조정 가격 통합
- ✅ Raw Data 반환 (계산 로직 제외)
- ✅ 명확한 함수 네이밍
- ✅ 조합은 애플리케이션 책임
