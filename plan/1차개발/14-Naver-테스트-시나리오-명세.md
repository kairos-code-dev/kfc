# Naver API 테스트 시나리오 명세

> **목적**: Naver Finance Chart API 함수의 테스트 시나리오 정의
> **참조 문서**: plan/10-함수-시그니처-카탈로그.md (섹션 7)
> **테스트 패턴**: AAA (Arrange-Act-Assert)

---

## 목차

1. [테스트 데이터](#1-테스트-데이터)
2. [조정 종가 조회](#2-조정-종가-조회)
3. [데이터 검증](#3-데이터-검증)
4. [장기 데이터 수집](#4-장기-데이터-수집)
5. [에러 처리](#5-에러-처리)
6. [통합 시나리오](#6-통합-시나리오)

---

## 1. 테스트 데이터

### 1.1 고정 테스트 데이터

| 항목 | 값 | 비고 |
|------|-----|------|
| **KODEX 200** | | |
| - Ticker | 069500 | |
| - ISIN | KR7069500007 | |
| **TIGER 200** | | |
| - Ticker | 102110 | |
| - ISIN | KR7102110009 | |
| **테스트 날짜** | | |
| - 단일 날짜 | 2024-01-15 | 거래일 |
| - 기간 시작 | 2024-01-02 | |
| - 기간 종료 | 2024-01-31 | 약 20 거래일 |
| - 장기 시작 | 2022-01-03 | |
| - 장기 종료 | 2024-01-31 | 약 500 거래일 |

---

## 2. 조정 종가 조회

### 2.1 getAdjustedClose() - 기본 조회

#### TC-ADJ-001: 1개월 조정 종가 조회

**사전 조건**:
- Ticker: 069500 (KODEX 200)
- 기간: 2024-01-02 ~ 2024-01-31 (약 20 거래일)

**테스트 단계**:
1. `getAdjustedClose(ticker, 시작일, 종료일)` 호출
2. 반환된 데이터 확인

**예상 결과**:
- 15~25개의 거래일 데이터 반환
- 각 항목에 다음 필드 포함:
  - tradeDate (날짜)
  - closePrice (원본 종가)
  - adjustedClose (조정 종가)
  - volume (거래량)
- 날짜 오름차순 정렬

**검증 항목**:
- [ ] 데이터 개수: 15~25
- [ ] 날짜 범위: 2024-01-02 ~ 2024-01-31
- [ ] closePrice > 0
- [ ] adjustedClose > 0
- [ ] volume >= 0
- [ ] 날짜 정렬: 오름차순

---

#### TC-ADJ-002: 단일 날짜 조회

**사전 조건**:
- Ticker: 069500
- 날짜: 2024-01-15 (거래일)

**테스트 단계**:
1. `getAdjustedClose(ticker, 날짜, 날짜)` 호출

**예상 결과**:
- 1개의 데이터 반환
- 날짜 = 2024-01-15

**검증 항목**:
- [ ] 데이터 개수 = 1
- [ ] tradeDate = 2024-01-15
- [ ] 모든 필드 > 0 (volume 제외)

---

#### TC-ADJ-003: 500일 데이터 조회 (최대 한도)

**사전 조건**:
- Ticker: 069500
- 기간: 최근 500 거래일 (약 2년)

**테스트 단계**:
1. 종료일 = 현재 날짜
2. 시작일 = 종료일 - 730일 (캘린더 기준)
3. `getAdjustedClose(ticker, 시작일, 종료일)` 호출

**예상 결과**:
- 최대 500개의 거래일 데이터
- Naver API 제한에 의해 500일 초과 불가

**검증 항목**:
- [ ] 데이터 개수 <= 500
- [ ] 날짜 연속성
- [ ] 중복 날짜 없음

---

### 2.2 조정 인수 검증

#### TC-ADJ-004: 배당 미발생 기간 (조정 인수 = 1)

**사전 조건**:
- Ticker: 069500
- 기간: 배당락일 이전 1개월 (배당 미발생)

**테스트 단계**:
1. `getAdjustedClose(ticker, 시작일, 종료일)` 호출
2. 각 날짜별 조정 인수 계산: adjustedClose / closePrice

**예상 결과**:
- 배당 미발생 기간에는 조정 인수 ≈ 1.0
- 오차 범위: ±0.001

**검증 항목**:
- [ ] 모든 날짜의 조정 인수: 0.999 ~ 1.001
- [ ] adjustedClose ≈ closePrice

---

#### TC-ADJ-005: 배당 발생 기간 (조정 인수 < 1)

**사전 조건**:
- Ticker: 069500
- 기간: 배당락일을 포함하는 기간

**테스트 단계**:
1. `getAdjustedClose(ticker, 시작일, 종료일)` 호출
2. 배당락일 전후 조정 인수 비교

**예상 결과**:
- 배당락일 이전: 조정 인수 < 1 (과거 가격이 하향 조정됨)
- 배당락일 이후: 조정 인수 ≈ 1
- 조정 종가의 연속성 유지 (갭 없음)

**검증 항목**:
- [ ] 배당락일 이전 조정 인수 < 1
- [ ] 조정 종가 연속성 (갭 없음)
- [ ] 수익률 계산 시 배당 반영

---

#### TC-ADJ-006: 여러 배당 이벤트 (누적 조정)

**사전 조건**:
- Ticker: 069500
- 기간: 2년 (여러 번의 배당 포함)

**테스트 단계**:
1. `getAdjustedClose(ticker, 2년전, 현재)` 호출
2. 과거로 갈수록 조정 인수 감소 확인

**예상 결과**:
- 과거 날짜일수록 조정 인수 작음 (누적 조정)
- 최근 날짜는 조정 인수 ≈ 1

**검증 항목**:
- [ ] 과거 조정 인수 < 최근 조정 인수
- [ ] 조정 인수 단조 증가 (과거 → 현재)

---

## 3. 데이터 검증

### 3.1 데이터 품질

#### TC-VAL-001: 가격 논리 검증

**사전 조건**:
- Ticker: 069500
- 기간: 2024-01-02 ~ 2024-01-31

**테스트 단계**:
1. `getAdjustedClose(ticker, 시작일, 종료일)` 호출
2. 각 항목의 가격 논리 검증

**예상 결과**:
- closePrice > 0
- adjustedClose > 0
- volume >= 0
- adjustedClose와 closePrice의 비율이 합리적 범위 (0.5 ~ 1.5)

**검증 항목**:
- [ ] closePrice > 0
- [ ] adjustedClose > 0
- [ ] 0.5 <= (adjustedClose / closePrice) <= 1.5

---

#### TC-VAL-002: 날짜 연속성

**사전 조건**:
- Ticker: 069500
- 기간: 2024-01-02 ~ 2024-01-31

**테스트 단계**:
1. `getAdjustedClose(ticker, 시작일, 종료일)` 호출
2. 반환된 날짜가 모두 거래일인지 확인

**예상 결과**:
- 주말/공휴일 제외
- 거래일만 포함
- 중복 날짜 없음

**검증 항목**:
- [ ] 주말 날짜 없음
- [ ] 중복 날짜 없음
- [ ] 정렬 순서: 오름차순

---

#### TC-VAL-003: 거래량 검증

**사전 조건**:
- Ticker: 069500
- 기간: 2024-01-02 ~ 2024-01-31

**테스트 단계**:
1. `getAdjustedClose(ticker, 시작일, 종료일)` 호출
2. 거래량 필드 검증

**예상 결과**:
- 모든 거래일의 거래량 >= 0
- 정상 거래일의 거래량 > 0

**검증 항목**:
- [ ] volume >= 0
- [ ] 대부분의 거래일에서 volume > 0

---

### 3.2 KRX 데이터와 비교

#### TC-CMP-001: Naver vs KRX 종가 일치

**사전 조건**:
- Ticker: 069500
- ISIN: KR7069500007
- 날짜: 2024-01-15

**테스트 단계**:
1. Naver API: `getAdjustedClose(ticker, 날짜, 날짜)` 호출
2. KRX API: `getEtfOhlcv(isin, 날짜, 날짜)` 호출
3. 두 소스의 closePrice 비교

**예상 결과**:
- Naver closePrice = KRX closePrice
- 오차 범위: ±1원 (반올림 오차 허용)

**검증 항목**:
- [ ] |Naver closePrice - KRX closePrice| <= 1

---

#### TC-CMP-002: Naver vs KRX 거래량 일치

**사전 조건**:
- Ticker: 069500
- ISIN: KR7069500007
- 날짜: 2024-01-15

**테스트 단계**:
1. Naver API: `getAdjustedClose(ticker, 날짜, 날짜)` 호출
2. KRX API: `getEtfOhlcv(isin, 날짜, 날짜)` 호출
3. 두 소스의 volume 비교

**예상 결과**:
- Naver volume ≈ KRX volume
- 오차 범위: ±1% (데이터 갱신 시차 허용)

**검증 항목**:
- [ ] |Naver volume - KRX volume| / KRX volume <= 0.01

---

## 4. 장기 데이터 수집

### 4.1 500일 초과 기간

#### TC-LONG-001: 2년 데이터 수집 (분할 요청)

**사전 조건**:
- Ticker: 069500
- 기간: 2022-01-03 ~ 2024-01-31 (약 500 거래일)
- Naver API 제한: 최대 500일

**테스트 단계**:
1. 첫 요청: `getAdjustedClose(ticker, 2022-01-03, 2024-01-31)` (최근 500일)
2. 반환된 데이터의 최초 날짜 확인
3. 필요시 두 번째 요청: 최초 날짜 - 1일 이전 기간

**예상 결과**:
- 첫 요청에서 최대 500개 데이터
- 500일 초과 시 추가 요청 필요
- 전체 기간 커버

**검증 항목**:
- [ ] 첫 요청 데이터 <= 500
- [ ] 중복 날짜 없음
- [ ] 날짜 범위 완전 커버

---

#### TC-LONG-002: 5년 데이터 수집 (여러 번 분할)

**사전 조건**:
- Ticker: 069500
- 기간: 2019-01-02 ~ 2024-01-31 (약 1250 거래일)

**테스트 단계**:
1. 500일씩 분할하여 3회 요청
2. 각 요청 사이에 100ms 대기 (Rate limiting)
3. 모든 데이터 병합

**예상 결과**:
- 3회 요청으로 전체 기간 커버
- 중복 제거 후 1200개 이상의 거래일 데이터

**검증 항목**:
- [ ] 요청 횟수 = 3
- [ ] 중복 제거 후 데이터 > 1200
- [ ] 첫 날짜 >= 2019-01-02
- [ ] 마지막 날짜 <= 2024-01-31

---

### 4.2 Rate Limiting

#### TC-RATE-001: 연속 요청 시 Rate Limiting

**사전 조건**:
- Ticker 리스트: [069500, 102110, ...]
- 날짜: 2024-01-15

**테스트 단계**:
1. 10개 ETF에 대해 연속 요청
2. 각 요청 사이에 100ms 대기
3. 전체 소요 시간 측정

**예상 결과**:
- 전체 소요 시간 >= 1000ms (10개 × 100ms)
- 모든 요청 성공

**검증 항목**:
- [ ] 소요 시간 >= 1000ms
- [ ] 모든 요청 성공 (에러 없음)

---

## 5. 에러 처리

### 5.1 잘못된 입력

#### TC-ERR-001: 잘못된 Ticker 형식

**사전 조건**:
- Ticker: "INVALID" (6자리 숫자 아님)

**테스트 단계**:
1. `getAdjustedClose("INVALID", 날짜, 날짜)` 호출

**예상 결과**:
- IllegalArgumentException 발생 또는
- 빈 응답 반환

**검증 항목**:
- [ ] 예외 발생 또는 빈 데이터

---

#### TC-ERR-002: 존재하지 않는 Ticker

**사전 조건**:
- Ticker: "999999" (존재하지 않는 ETF)

**테스트 단계**:
1. `getAdjustedClose("999999", 날짜, 날짜)` 호출

**예상 결과**:
- 빈 응답 또는
- NoDataException 발생

**검증 항목**:
- [ ] 빈 데이터 또는 예외 발생

---

#### TC-ERR-003: 미래 날짜

**사전 조건**:
- Ticker: 069500
- 날짜: 현재 + 10일 (미래)

**테스트 단계**:
1. `getAdjustedClose(ticker, 미래날짜, 미래날짜)` 호출

**예상 결과**:
- 빈 응답 반환

**검증 항목**:
- [ ] 데이터 개수 = 0

---

#### TC-ERR-004: 역순 날짜 범위

**사전 조건**:
- Ticker: 069500
- 시작일: 2024-01-31
- 종료일: 2024-01-01 (시작일 > 종료일)

**테스트 단계**:
1. `getAdjustedClose(ticker, 2024-01-31, 2024-01-01)` 호출

**예상 결과**:
- IllegalArgumentException 발생 또는
- 빈 응답

**검증 항목**:
- [ ] 예외 발생 또는 빈 데이터

---

### 5.2 API 응답 에러

#### TC-ERR-005: 파싱 에러 (잘못된 응답 형식)

**사전 조건**:
- Naver API가 잘못된 형식의 응답 반환 (시뮬레이션)

**테스트 단계**:
1. Mock 응답: "INVALID|DATA|FORMAT"
2. 파싱 시도

**예상 결과**:
- ParseException 발생
- 적절한 에러 메시지

**검증 항목**:
- [ ] ParseException 발생
- [ ] 에러 메시지 포함

---

#### TC-ERR-006: 네트워크 타임아웃

**사전 조건**:
- 네트워크 지연 시뮬레이션

**테스트 단계**:
1. Timeout 설정: 1초
2. 1초 이상 지연되는 요청 시도

**예상 결과**:
- TimeoutException 발생

**검증 항목**:
- [ ] TimeoutException 발생
- [ ] 재시도 로직 작동 (옵션)

---

## 6. 통합 시나리오

### 6.1 KRX + Naver 조합

#### TC-INT-001: 조정 OHLC 계산

**시나리오**:
1. KRX API로 KODEX 200 OHLCV 조회 (2024-01-15)
2. Naver API로 조정 종가 조회 (2024-01-15)
3. 조정 인수 계산: adjustedClose / closePrice
4. 조정 OHLC 계산:
   - adjustedOpen = openPrice × 조정 인수
   - adjustedHigh = highPrice × 조정 인수
   - adjustedLow = lowPrice × 조정 인수
   - adjustedClose = adjustedClose (Naver)

**예상 결과**:
- 조정 인수 계산 성공
- 조정 OHLC 계산 완료
- 가격 논리 유지: adjustedHigh >= adjustedLow

**검증 항목**:
- [ ] 조정 인수 > 0
- [ ] adjustedHigh >= adjustedLow
- [ ] adjustedHigh >= adjustedOpen, adjustedClose
- [ ] adjustedLow <= adjustedOpen, adjustedClose

---

#### TC-INT-002: 장기 백테스팅 데이터 준비

**시나리오**:
1. KRX API로 KODEX 200 OHLCV 조회 (2022-01-03 ~ 2024-01-31)
2. Naver API로 조정 종가 조회 (분할 요청, 500일씩)
3. 날짜별 매칭하여 조정 OHLC 계산
4. DB 저장 (etf_daily_prices 테이블)

**예상 결과**:
- 500개 이상의 거래일 데이터
- 모든 날짜에서 KRX + Naver 데이터 매칭 성공
- DB 저장 완료

**검증 항목**:
- [ ] 데이터 개수 > 500
- [ ] 매칭 실패 건수 = 0
- [ ] DB 저장 성공
- [ ] 조정 인수 범위: 0.5 ~ 1.5

---

#### TC-INT-003: 배치 수집 워크플로우

**시나리오**:
1. DB에서 활성 ETF 티커 목록 조회 (100개)
2. 각 ETF별로:
   - KRX OHLCV 조회 (100ms 대기)
   - Naver 조정 종가 조회 (100ms 대기)
   - 조정 OHLC 계산
   - DB 저장
3. 전체 소요 시간 측정

**예상 결과**:
- 100개 ETF 데이터 수집 완료
- 소요 시간: 약 20초 (100개 × 200ms)
- 성공률 > 95%

**검증 항목**:
- [ ] 수집 완료 개수 >= 95
- [ ] 소요 시간: 18초 ~ 25초
- [ ] 에러 로그 기록

---

### 6.2 Corporate Actions 검증

#### TC-CORP-001: 배당 이벤트 검증

**시나리오**:
1. OPENDART API로 KODEX 200 배당 정보 조회 (plan/12 참조)
2. Naver API로 배당락일 전후 조정 종가 조회
3. 조정 인수 변화 확인
4. 배당금 역산: 조정 인수 변화 × closePrice

**예상 결과**:
- 배당락일에 조정 인수 변화 감지
- 역산 배당금 ≈ OPENDART 배당금 (±5% 오차)

**검증 항목**:
- [ ] 배당락일에 조정 인수 하락
- [ ] 역산 배당금 정확도 > 95%

---

#### TC-CORP-002: 주식 분할 검증

**시나리오**:
1. OPENDART API로 주식 분할 정보 조회
2. Naver API로 분할일 전후 조정 종가 조회
3. 조정 인수 변화 확인 (2:1 분할 시 조정 인수 약 0.5)

**예상 결과**:
- 분할일에 조정 인수 급격히 변화
- 조정 종가는 연속성 유지

**검증 항목**:
- [ ] 분할일에 조정 인수 변화
- [ ] 조정 종가 연속성 유지

---

## 요약

| 카테고리 | 시나리오 수 |
|---------|-----------|
| 조정 종가 조회 | 6 |
| 데이터 검증 | 5 |
| 장기 데이터 수집 | 3 |
| 에러 처리 | 6 |
| 통합 시나리오 | 5 |
| **합계** | **25** |

---

**작성일**: 2025-01-18
**버전**: v1.0
**작성자**: kotlin-krx 프로젝트
