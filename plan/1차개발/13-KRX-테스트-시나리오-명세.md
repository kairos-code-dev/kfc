# KRX API 테스트 시나리오 명세

> **목적**: KRX API 함수의 테스트 시나리오 정의
> **참조 문서**: plan/10-함수-시그니처-카탈로그-v3.md
> **테스트 패턴**: AAA (Arrange-Act-Assert)

---

## 목차

1. [테스트 데이터](#1-테스트-데이터)
2. [ETF 목록 및 기본 정보](#2-etf-목록-및-기본-정보)
3. [ETF 시세 및 OHLCV](#3-etf-시세-및-ohlcv)
4. [ETF 포트폴리오 구성](#4-etf-포트폴리오-구성)
5. [ETF 성과 및 추적](#5-etf-성과-및-추적)
6. [투자자별 거래](#6-투자자별-거래)
7. [공매도 데이터](#7-공매도-데이터)
8. [에러 처리](#8-에러-처리)
9. [통합 시나리오](#9-통합-시나리오)

---

## 1. 테스트 데이터

### 1.1 고정 테스트 데이터

| 항목 | 값 | 비고 |
|------|-----|------|
| **KODEX 200** | | |
| - ISIN | KR7069500007 | |
| - Ticker | 069500 | |
| **TIGER 200** | | |
| - ISIN | KR7102110009 | |
| - Ticker | 102110 | |
| **테스트 날짜** | | |
| - 단일 날짜 | 2024-01-15 | 거래일 |
| - 기간 시작 | 2024-01-02 | |
| - 기간 종료 | 2024-01-31 | 약 20 거래일 |

---

## 2. ETF 목록 및 기본 정보

### 2.1 getEtfList() - 전체 ETF 목록 조회

#### TC-ETF-001: 전체 ETF 목록 조회

**사전 조건**:
- KRX API 정상 작동

**테스트 단계**:
1. `getEtfList()` 함수 호출
2. 반환된 목록 확인

**예상 결과**:
- 200개 이상의 ETF 반환
- 각 항목에 다음 필드 포함:
  - ISIN (12자리, KR로 시작)
  - Ticker (6자리 숫자)
  - ETF명 (한글)
  - 운용사명
  - 상장일자
  - 총보수 (0 이상)

**검증 항목**:
- [ ] 데이터 개수 >= 200
- [ ] ISIN 형식: `KR7\d{6}\d{3}`
- [ ] Ticker 형식: `\d{6}`
- [ ] 모든 필수 필드 존재
- [ ] 총보수 >= 0

---

#### TC-ETF-002: KODEX 200 존재 확인

**사전 조건**:
- `getEtfList()` 정상 작동

**테스트 단계**:
1. `getEtfList()` 호출
2. Ticker가 "069500"인 항목 검색

**예상 결과**:
- KODEX 200 항목 발견
- ISIN: KR7069500007
- 이름: "KODEX 200" 포함
- 벤치마크: "코스피 200" 또는 "KOSPI 200"
- 자산 클래스: "주식"

**검증 항목**:
- [ ] KODEX 200 존재
- [ ] 메타데이터 일치

---

#### TC-ETF-003: 필드 데이터 무결성

**사전 조건**:
- `getEtfList()` 정상 작동

**테스트 단계**:
1. `getEtfList()` 호출
2. 모든 항목의 필드 검증

**예상 결과**:
- 모든 ETF에서 필수 필드가 유효한 값
- 상장일 < 현재 날짜
- 상장 주식수 > 0

**검증 항목**:
- [ ] 필수 필드 누락 없음
- [ ] 날짜 논리 정합성
- [ ] 숫자 필드 양수

---

### 2.2 getEtfDetail() - 개별 ETF 상세 정보

#### TC-DETAIL-001: KODEX 200 상세 정보

**사전 조건**:
- ISIN: KR7069500007
- 날짜: 2024-01-15 (거래일)

**테스트 단계**:
1. `getEtfDetail(ISIN, 날짜)` 호출
2. 반환된 상세 정보 확인

**예상 결과**:
- 기본 정보: ISIN, Ticker, ETF명, 운용사
- 가격 정보: OHLC, Volume, NAV
- 52주 고가/저가
- 가격 논리: High >= Low, High >= Close, Low <= Close

**검증 항목**:
- [ ] 모든 가격 필드 > 0
- [ ] High >= Low
- [ ] Close <= Week52High
- [ ] Close >= Week52Low
- [ ] NAV > 0

---

#### TC-DETAIL-002: 비거래일 조회

**사전 조건**:
- ISIN: KR7069500007
- 날짜: 2024-01-01 (신정, 비거래일)

**테스트 단계**:
1. `getEtfDetail(ISIN, 비거래일)` 호출

**예상 결과**:
- 데이터 없음 예외 또는 빈 응답

**검증 항목**:
- [ ] NoDataException 발생 또는
- [ ] 빈 응답 반환

---

### 2.3 searchEtf() - ETF 검색

#### TC-SEARCH-001: KODEX 키워드 검색

**사전 조건**:
- 검색어: "KODEX"

**테스트 단계**:
1. `searchEtf("KODEX")` 호출

**예상 결과**:
- 50개 이상의 KODEX ETF 반환
- 모든 결과에 "KODEX" 포함

**검증 항목**:
- [ ] 결과 개수 >= 50
- [ ] 모든 이름에 "KODEX" 포함
- [ ] ISIN, Ticker 형식 유효

---

#### TC-SEARCH-002: 빈 검색어

**사전 조건**:
- 검색어: "" (빈 문자열)

**테스트 단계**:
1. `searchEtf("")` 호출

**예상 결과**:
- 전체 ETF 목록 반환 (200개 이상)

**검증 항목**:
- [ ] 결과 개수 >= 200

---

#### TC-SEARCH-003: 존재하지 않는 ETF

**사전 조건**:
- 검색어: "NONEXISTENT_XYZ"

**테스트 단계**:
1. `searchEtf("NONEXISTENT_XYZ")` 호출

**예상 결과**:
- 빈 리스트 반환

**검증 항목**:
- [ ] 결과 개수 = 0

---

## 3. ETF 시세 및 OHLCV

### 3.1 getEtfOhlcv() - OHLCV 조회

#### TC-OHLCV-001: 1개월 OHLCV 조회

**사전 조건**:
- ISIN: KR7069500007
- 기간: 2024-01-02 ~ 2024-01-31 (약 20 거래일)

**테스트 단계**:
1. `getEtfOhlcv(ISIN, 시작일, 종료일)` 호출
2. 반환 데이터 확인

**예상 결과**:
- 15~25개의 거래일 데이터 (주말 제외)
- 날짜 오름차순 정렬
- 각 행의 OHLC 논리 정합성

**검증 항목**:
- [ ] 데이터 개수: 15~25
- [ ] 날짜 정렬: 오름차순
- [ ] High >= Low
- [ ] High >= Open, Close
- [ ] Low <= Open, Close
- [ ] Volume >= 0

---

#### TC-OHLCV-002: 730일 초과 조회 (자동 분할)

**사전 조건**:
- ISIN: KR7069500007
- 기간: 2022-01-03 ~ 2024-01-31 (2년, 730일 초과)

**테스트 단계**:
1. `getEtfOhlcv(ISIN, 시작일, 종료일)` 호출
2. 라이브러리가 자동으로 730일씩 분할 요청하는지 확인

**예상 결과**:
- 500개 이상의 거래일 데이터 반환
- 중복 날짜 없음
- 날짜 연속성 유지

**검증 항목**:
- [ ] 데이터 개수 > 500
- [ ] 중복 날짜 없음
- [ ] 첫 날짜 >= 시작일
- [ ] 마지막 날짜 <= 종료일

---

#### TC-OHLCV-003: 단일 날짜 조회

**사전 조건**:
- ISIN: KR7069500007
- 날짜: 2024-01-15

**테스트 단계**:
1. `getEtfOhlcv(ISIN, 날짜, 날짜)` 호출

**예상 결과**:
- 1개의 데이터 반환
- 날짜 = 2024-01-15

**검증 항목**:
- [ ] 데이터 개수 = 1
- [ ] 날짜 일치

---

### 3.2 getAllEtfDailyPrices() - 전체 ETF 시세

#### TC-DAILY-001: 특정일 전체 ETF 시세

**사전 조건**:
- 날짜: 2024-01-15

**테스트 단계**:
1. `getAllEtfDailyPrices(날짜)` 호출

**예상 결과**:
- 600개 이상의 ETF 데이터
- KODEX 200 포함

**검증 항목**:
- [ ] 데이터 개수 > 600
- [ ] KODEX 200 존재
- [ ] 모든 가격 > 0
- [ ] NAV > 0

---

### 3.3 getEtfPriceChanges() - 등락률 조회

#### TC-CHANGE-001: 1주일 등락률

**사전 조건**:
- 기간: 2024-01-02 ~ 2024-01-05

**테스트 단계**:
1. `getEtfPriceChanges(시작일, 종료일)` 호출

**예상 결과**:
- 600개 이상의 ETF 등락률
- 등락률 계산 정확성

**검증 항목**:
- [ ] 데이터 개수 > 600
- [ ] 등락률 = ((종가 - 시가) / 시가) × 100
- [ ] 등락률 범위: -30% ~ +30%

---

## 4. ETF 포트폴리오 구성

### 4.1 getEtfPortfolio() - 포트폴리오 조회

#### TC-PORT-001: KODEX 200 포트폴리오

**사전 조건**:
- ISIN: KR7069500007
- 날짜: 2024-01-15

**테스트 단계**:
1. `getEtfPortfolio(ISIN, 날짜)` 호출

**예상 결과**:
- 180개 이상의 구성 종목
- 각 종목의 비중, CU당 주식수 포함

**검증 항목**:
- [ ] 구성 종목 > 180
- [ ] 비중 > 0
- [ ] CU당 주식수 > 0

---

#### TC-PORT-002: 포트폴리오 비중 합계

**사전 조건**:
- ISIN: KR7069500007
- 날짜: 2024-01-15

**테스트 단계**:
1. `getEtfPortfolio(ISIN, 날짜)` 호출
2. value > 0인 항목만 필터링
3. 비중 합계 계산

**예상 결과**:
- 비중 합계 ≈ 100% (±1% 오차 허용)

**검증 항목**:
- [ ] 비중 합계: 99% ~ 101%

---

#### TC-PORT-003: 티커 추출

**사전 조건**:
- ISIN: KR7069500007
- 날짜: 2024-01-15

**테스트 단계**:
1. `getEtfPortfolio(ISIN, 날짜)` 호출
2. ISIN 형식 구성종목코드에서 티커 추출 (substring(3, 9))

**예상 결과**:
- 추출된 티커 형식: 6자리 숫자

**검증 항목**:
- [ ] 모든 티커 형식: `\d{6}`

---

## 5. ETF 성과 및 추적

### 5.1 getEtfTrackingError() - 추적 오차

#### TC-TRACK-001: 추적 오차 조회

**사전 조건**:
- ISIN: KR7069500007
- 기간: 2024-01-02 ~ 2024-01-31

**테스트 단계**:
1. `getEtfTrackingError(ISIN, 시작일, 종료일)` 호출

**예상 결과**:
- 일별 추적 오차율 반환
- NAV, 지수값, 추적 오차율 포함

**검증 항목**:
- [ ] 데이터 존재
- [ ] NAV > 0
- [ ] 지수값 > 0
- [ ] 추적 오차율: -5% ~ +5%

---

#### TC-TRACK-002: 추적 오차 평균

**사전 조건**:
- ISIN: KR7069500007 (KODEX 200은 우수한 추적 성과)
- 기간: 2024-01-02 ~ 2024-01-31

**테스트 단계**:
1. `getEtfTrackingError(ISIN, 시작일, 종료일)` 호출
2. 절대값 추적 오차의 평균 계산

**예상 결과**:
- 평균 추적 오차 < 1%

**검증 항목**:
- [ ] 평균 |추적 오차| < 1%

---

### 5.2 getEtfDivergenceRate() - 괴리율

#### TC-DIV-001: 괴리율 조회

**사전 조건**:
- ISIN: KR7069500007
- 기간: 2024-01-02 ~ 2024-01-31

**테스트 단계**:
1. `getEtfDivergenceRate(ISIN, 시작일, 종료일)` 호출

**예상 결과**:
- 일별 괴리율 반환
- 종가, NAV, 괴리율 포함

**검증 항목**:
- [ ] 데이터 존재
- [ ] 종가 > 0
- [ ] NAV > 0
- [ ] 괴리율: -10% ~ +10%

---

#### TC-DIV-002: 괴리율 계산 검증

**사전 조건**:
- ISIN: KR7069500007
- 날짜: 2024-01-15

**테스트 단계**:
1. `getEtfDivergenceRate(ISIN, 날짜, 날짜)` 호출
2. 괴리율 = ((종가 - NAV) / NAV) × 100 계산
3. API 반환값과 비교

**예상 결과**:
- 계산 괴리율 = API 괴리율 (±0.01% 오차)

**검증 항목**:
- [ ] 괴리율 계산 정확성

---

## 6. 투자자별 거래

### 6.1 getAllEtfInvestorTrading() - 전체 ETF 투자자 거래

#### TC-INV-001: 투자자별 거래 조회

**사전 조건**:
- 날짜: 2024-01-15

**테스트 단계**:
1. `getAllEtfInvestorTrading(날짜)` 호출

**예상 결과**:
- 13개 투자자 유형 데이터 반환
  - 금융투자, 보험, 투신, 사모, 은행, 기타금융, 연기금
  - 기관합계, 기타법인, 개인, 외국인, 기타외국인, 전체

**검증 항목**:
- [ ] 데이터 개수 = 13
- [ ] 모든 투자자 유형 포함
- [ ] 매수/매도 거래량 >= 0

---

#### TC-INV-002: 순매수 계산 검증

**사전 조건**:
- 날짜: 2024-01-15

**테스트 단계**:
1. `getAllEtfInvestorTrading(날짜)` 호출
2. 각 투자자의 순매수 = 매수 - 매도 계산
3. API 반환값과 비교

**예상 결과**:
- 순매수 거래량 = 매수 거래량 - 매도 거래량
- 순매수 거래대금 = 매수 거래대금 - 매도 거래대금

**검증 항목**:
- [ ] 순매수 계산 정확성

---

### 6.2 getEtfInvestorTrading() - 개별 ETF 투자자 거래

#### TC-INV-003: 개별 ETF 투자자 거래

**사전 조건**:
- ISIN: KR7069500007
- 날짜: 2024-01-15

**테스트 단계**:
1. `getEtfInvestorTrading(ISIN, 날짜)` 호출

**예상 결과**:
- 13개 투자자 유형 데이터

**검증 항목**:
- [ ] 데이터 개수 = 13
- [ ] 거래량/거래대금 >= 0

---

## 7. 공매도 데이터

### 7.1 getEtfShortSelling() - 공매도 거래

#### TC-SHORT-001: 공매도 거래 조회

**사전 조건**:
- ISIN: KR7069500007
- 기간: 2024-01-02 ~ 2024-01-31

**테스트 단계**:
1. `getEtfShortSelling(ISIN, 시작일, 종료일)` 호출

**예상 결과**:
- 일별 공매도 데이터
- 공매도 거래량, 전체 거래량, 비중 포함

**검증 항목**:
- [ ] 데이터 존재
- [ ] 공매도 거래량 <= 전체 거래량
- [ ] 공매도 비중: 0% ~ 100%

---

#### TC-SHORT-002: 공매도 비중 계산

**사전 조건**:
- ISIN: KR7069500007
- 날짜: 2024-01-15

**테스트 단계**:
1. `getEtfShortSelling(ISIN, 날짜, 날짜)` 호출
2. 비중 = (공매도 거래량 / 전체 거래량) × 100 계산

**예상 결과**:
- 계산 비중 = API 비중 (±0.1% 오차)

**검증 항목**:
- [ ] 비중 계산 정확성

---

### 7.2 getEtfShortBalance() - 공매도 잔고

#### TC-BAL-001: 공매도 잔고 조회

**사전 조건**:
- ISIN: KR7069500007
- 기간: 2024-01-02 ~ 2024-01-31

**테스트 단계**:
1. `getEtfShortBalance(ISIN, 시작일, 종료일)` 호출

**예상 결과**:
- 일별 공매도 잔고
- 공매도 잔고, 상장 주식수, 비율 포함

**검증 항목**:
- [ ] 데이터 존재
- [ ] 공매도 잔고 <= 상장 주식수
- [ ] 잔고 비율: 0% ~ 100%

---

## 8. 에러 처리

### 8.1 잘못된 입력

#### TC-ERR-001: 잘못된 ISIN 형식

**사전 조건**:
- 잘못된 ISIN: "INVALID_ISIN"

**테스트 단계**:
1. `getEtfDetail("INVALID_ISIN", 날짜)` 호출

**예상 결과**:
- IllegalArgumentException 발생

**검증 항목**:
- [ ] 예외 발생

---

#### TC-ERR-002: 존재하지 않는 ISIN

**사전 조건**:
- 존재하지 않는 ISIN: "KR7999999999"

**테스트 단계**:
1. `getEtfDetail("KR7999999999", 날짜)` 호출

**예상 결과**:
- NoDataException 발생

**검증 항목**:
- [ ] NoDataException 발생

---

#### TC-ERR-003: 미래 날짜

**사전 조건**:
- 미래 날짜: 현재 + 10일

**테스트 단계**:
1. `getEtfDetail(ISIN, 미래날짜)` 호출

**예상 결과**:
- NoDataException 발생

**검증 항목**:
- [ ] NoDataException 발생

---

#### TC-ERR-004: 역순 날짜 범위

**사전 조건**:
- 시작일: 2024-01-31
- 종료일: 2024-01-01

**테스트 단계**:
1. `getEtfOhlcv(ISIN, 2024-01-31, 2024-01-01)` 호출

**예상 결과**:
- IllegalArgumentException 발생

**검증 항목**:
- [ ] IllegalArgumentException 발생

---

## 9. 통합 시나리오

### 9.1 ETF 데이터 수집 워크플로우

#### TC-INT-001: 전체 ETF 데이터 수집

**시나리오**:
1. `getEtfList()` 호출 → 전체 ETF 목록 획득
2. 상위 5개 ETF 선택
3. 각 ETF별 `getEtfDetail()` 호출 (100ms 간격)

**예상 결과**:
- 5개 ETF 상세 정보 수집 완료

**검증 항목**:
- [ ] 5개 ETF 데이터 획득
- [ ] Rate limiting 준수 (500ms 이상 소요)

---

### 9.2 백테스팅 데이터 준비

#### TC-INT-002: OHLCV + 포트폴리오 + 추적오차

**시나리오**:
1. `getEtfOhlcv(KODEX 200, 기간)` 호출
2. `getEtfPortfolio(KODEX 200, 종료일)` 호출 (100ms 대기)
3. `getEtfTrackingError(KODEX 200, 기간)` 호출 (100ms 대기)
4. 데이터 일관성 검증: OHLCV 마지막 NAV = TrackingError 마지막 NAV

**예상 결과**:
- 3가지 데이터 모두 수집
- NAV 값 일치

**검증 항목**:
- [ ] 데이터 수집 완료
- [ ] NAV 일치 (±0.01 오차)

---

### 9.3 투자자 분석

#### TC-INT-003: 전체 시장 vs 개별 ETF 투자자 거래 비교

**시나리오**:
1. `getAllEtfInvestorTrading(날짜)` 호출 → 전체 시장 외국인 순매수
2. `getEtfInvestorTrading(KODEX 200, 날짜)` 호출 (100ms 대기) → KODEX 200 외국인 순매수
3. 개별 ETF 거래량 <= 전체 시장 거래량 검증

**예상 결과**:
- KODEX 200 외국인 순매수 <= 전체 시장 외국인 순매수

**검증 항목**:
- [ ] 논리 정합성

---

## 요약

| 카테고리 | 시나리오 수 |
|---------|-----------|
| ETF 목록/정보 | 9 |
| 시세/OHLCV | 8 |
| 포트폴리오 | 3 |
| 성과/추적 | 4 |
| 투자자 거래 | 4 |
| 공매도 | 3 |
| 에러 처리 | 4 |
| 통합 시나리오 | 3 |
| **합계** | **38** |

---

**작성일**: 2025-01-18
**버전**: v1.0
**작성자**: kotlin-krx 프로젝트
