# MDCSTAT04701 상세 명세

## 개요

**MDCSTAT04701** (ETF 개별종목 종합정보)은 pykrx에서 누락된 가장 중요한 엔드포인트입니다. 이 엔드포인트는 단일 요청으로 ETF의 포괄적인 정보를 제공하며, 다른 방법으로는 여러 엔드포인트를 호출해야 하는 데이터를 결합합니다.

**최우선 순위인 이유**:
- 30개 이상의 필드를 단일 요청으로 제공
- 다른 엔드포인트에서 사용할 수 없는 중요 데이터 포함 (총 보수, 52주 고가/저가)
- API 지연 시간 및 부하 감소
- ETF 상세 페이지 및 대시보드에 이상적

## 엔드포인트 정보

**BLD 코드**: `dbms/MDC/STAT/standard/MDCSTAT04701`

**URL**: `http://data.krx.co.kr/comm/bldAttendant/getJsonData.cmd`

**HTTP 메서드**: POST

**Content-Type**: `application/x-www-form-urlencoded`

**헤더**:
```
User-Agent: Mozilla/5.0
Referer: http://data.krx.co.kr/
```

## 파라미터

| 파라미터 | 타입 | 필수 | 형식 | 설명 | 예시 |
|---------|------|------|------|------|------|
| bld | String | 예 | BLD 경로 | BLD 코드 | dbms/MDC/STAT/standard/MDCSTAT04701 |
| trdDd | String | 예 | YYYYMMDD | 거래 날짜 | 20240102 |
| isuCd | String | 예 | ISIN | 전체 ISIN 코드 (티커 아님) | KR7152100004 |

**중요**: `isuCd`는 6자리 티커가 아닌 전체 ISIN 코드여야 합니다. 티커를 ISIN으로 변환하려면 `EtxTickerCache.getIsin(ticker)`를 사용하세요.

## 완전한 필드 사전

### 기본 식별 정보

| KRX 필드 | 한글명 | 데이터 타입 | 설명 | 예시 값 |
|---------|--------|-----------|------|--------|
| TRD_DD | 거래일자 | String → LocalDate | 거래일 (yyyy/MM/dd) | 2024/01/02 |
| ISU_CD | 종목코드 | String | 전체 ISIN 코드 | KR7152100004 |
| ISU_SRT_CD | 단축코드 | String | 6자리 티커 | 152100 |
| ISU_ABBRV | 종목약명 | String | ETF 약식 이름 | ARIRANG 200 |
| ISU_NM | 종목명 | String | ETF 전체 공식 이름 | ARIRANG 200 증권상장지수투자신탁[주식] |

### 가격 데이터 (OHLCV)

| KRX 필드 | 한글명 | 데이터 타입 | 설명 | 예시 값 |
|---------|--------|-----------|------|--------|
| TDD_OPNPRC | 시가 | String → **BigDecimal** | 시가 (콤마 제거) | 42,075 → BigDecimal("42075.00") |
| TDD_HGPRC | 고가 | String → **BigDecimal** | 고가 | 43,250 → BigDecimal("43250.00") |
| TDD_LWPRC | 저가 | String → **BigDecimal** | 저가 | 41,900 → BigDecimal("41900.00") |
| TDD_CLSPRC | 종가 | String → **BigDecimal** | 종가 | 42,965 → BigDecimal("42965.00") |
| CMPPREVDD_PRC | 전일대비 | String → **BigDecimal** | 전일 대비 가격 변화 | 1,080 → BigDecimal("1080.00") |
| FLUC_TP_CD | 등락구분 | String → Int | 1=상승, 2=하락, 3=보합 | 1 |
| FLUC_RT | 등락률 | String → **BigDecimal** | 변화율 (%) | 2.58 → BigDecimal("2.5800") |
| ACC_TRDVOL | 거래량 | String → Long | 총 거래량 | 192,061 → 192061L |
| ACC_TRDVAL | 거래대금 | String → **BigDecimal** | 총 거래대금 (원) | 8,222,510,755 → BigDecimal("8222510755") |

### NAV 및 시가총액

| KRX 필드 | 한글명 | 데이터 타입 | 설명 | 예시 값 |
|---------|--------|-----------|------|--------|
| LST_NAV | NAV | String → BigDecimal | 순자산가치 | 43,079.14 |
| NAV_CHG_VAL | NAV변화금액 | String → BigDecimal | NAV 변화액 | 1,095.82 |
| NAV_CHG_RT | NAV변화율 | String → **BigDecimal** | NAV 변화율 (%) | 2.61 → BigDecimal("2.6100") |
| MKTCAP | 시가총액 | String → **BigDecimal** | 시가총액 (원) | 850,707,000,000 → BigDecimal("850707000000") |
| INVSTASST_NETASST_TOTAMT | 순자산총액 | String → **BigDecimal** | 순자산 총액 (원) | 852,966,972,000 → BigDecimal("852966972000") |
| LIST_SHRS | 상장주식수 | String → Long | 상장 주식 수 | 19,800,000 → 19800000L |

### 52주 고가/저가 (핵심 - 다른 엔드포인트에 없음)

| KRX 필드 | 한글명 | 데이터 타입 | 설명 | 예시 값 |
|---------|--------|-----------|------|--------|
| WK52_HGPR | 52주최고가 | String → **BigDecimal** | 52주 고가 | 45,230 → BigDecimal("45230.00") |
| WK52_HGPR_DD | 52주최고가일자 | String → LocalDate | 52주 고가 날짜 | 2023/11/28 |
| WK52_LWPR | 52주최저가 | String → **BigDecimal** | 52주 저가 | 38,125 → BigDecimal("38125.00") |
| WK52_LWPR_DD | 52주최저가일자 | String → LocalDate | 52주 저가 날짜 | 2023/03/15 |

### 지수 정보

| KRX 필드 | 한글명 | 데이터 타입 | 설명 | 예시 값 |
|---------|--------|-----------|------|--------|
| OBJ_STKPRC_IDX | 기초지수 | String → BigDecimal | 벤치마크 지수 값 | 421.35 |
| IDX_IND_NM | 지수명 | String | 지수명 | 코스피 200 |
| CMPPREVDD_IDX | 지수전일대비 | String → BigDecimal | 지수 변화 | 10.85 |
| FLUC_TP_CD1 | 지수등락구분 | String → Int | 지수 방향 (1/2/3) | 1 |
| IDX_FLUC_RT | 지수등락률 | String → **BigDecimal** | 지수 변화율 (%) | 2.64 → BigDecimal("2.6400") |

### 괴리율 및 추적

| KRX 필드 | 한글명 | 데이터 타입 | 설명 | 예시 값 |
|---------|--------|-----------|------|--------|
| DIVRG_RT | 괴리율 | String → **BigDecimal** | (종가 - NAV) / NAV * 100 | -0.27 → BigDecimal("-0.2700") |

### ETF 기본 정보 (MDCSTAT04601 필드)

| KRX 필드 | 한글명 | 데이터 타입 | 설명 | 예시 값 |
|---------|--------|-----------|------|--------|
| LIST_DD | 상장일 | String → LocalDate | ETF 상장일 | 2008/02/01 |
| COM_ABBRV | 운용사 | String | 자산 운용사명 | 한국투자신탁운용 |
| ETF_TOT_FEE | 총보수 | String → BigDecimal | 총 보수율 (%) **중요!** | 0.15 → BigDecimal("0.1500") |
| CU_QTY | CU수량 | String → Long | 생성 단위 수량 | 100,000 |
| ETF_OBJ_IDX_NM | 기초지수명 | String | 벤치마크 지수 전체명 | 코스피 200 지수 |
| IDX_CALC_INST_NM1 | 지수산출기관 | String | 지수 제공기관 | KRX |
| IDX_MKT_CLSS_NM | 시장구분 | String | 시장 분류 | 국내 |
| IDX_ASST_CLSS_NM | 자산구분 | String | 자산군 **중요!** | 주식 |
| ETF_REPLICA_METHD_TP_CD | 복제방법 | String | 복제 방법 | 실물 |
| IDX_CALC_INST_NM2 | 레버리지/인버스구분 | String | 레버리지/인버스 유형 | 일반 |

### 추가 메타데이터

| KRX 필드 | 한글명 | 데이터 타입 | 설명 | 예시 값 |
|---------|--------|-----------|------|--------|
| TAX_TP_CD | 과세유형 | String | 세금 유형 | 배당소득세(보유기간과세) |
| MKT_NM | 시장명 | String | 시장명 | KOSPI |

## 다른 엔드포인트와의 비교

### MDCSTAT04501 (OHLCV)와 비교

| 데이터 | 04501 | 04701 | 차이점 |
|--------|-------|-------|--------|
| OHLCV | ✅ | ✅ | 동일 |
| NAV | ✅ | ✅ | 동일 |
| 거래량/거래대금 | ✅ | ✅ | 동일 |
| 시가총액 | ✅ | ✅ | 동일 |
| 52주 고가/저가 | ❌ | ✅ | **04701만 제공** |
| 총 보수 | ❌ | ✅ | **04701만 제공** |
| 자산군 | ❌ | ✅ | **04701만 제공** |
| 상장일 | ❌ | ✅ | **04701만 제공** |
| 운용사 | ❌ | ✅ | **04701만 제공** |
| 날짜 범위 | ✅ (730일) | ❌ | 04501은 범위 지원 |

### MDCSTAT04601 (기본 정보)와 비교

| 데이터 | 04601 | 04701 | 차이점 |
|--------|-------|-------|--------|
| 기본 정보 | ✅ | ✅ | 동일 |
| OHLCV | ❌ | ✅ | **04701만 제공** |
| 52주 고가/저가 | ❌ | ✅ | **04701만 제공** |
| 전체 목록 | ✅ | ❌ | 04601은 전체 목록 |
| 특정 날짜 | ❌ | ✅ | 04701은 날짜별 스냅샷 |

### 결론: 언제 무엇을 사용할 것인가

| 사용 사례 | 권장 엔드포인트 | 이유 |
|----------|---------------|------|
| 상세 페이지 | **MDCSTAT04701** | 단일 요청으로 모든 데이터 |
| 백테스팅 (과거 데이터) | MDCSTAT04501 | 730일 범위 지원 |
| 목록/스크리너 | MDCSTAT04601 또는 04301 | 전체 시장 스냅샷 |
| 일일 대시보드 | **MDCSTAT04701** | 최신 종합 정보 |

## 응답 데이터 샘플

### JSON 응답 (실제 KRX API)

```json
{
  "result": "succ",
  "output": [
    {
      "TRD_DD": "2024/01/02",
      "ISU_CD": "KR7152100004",
      "ISU_SRT_CD": "152100",
      "ISU_ABBRV": "ARIRANG 200",
      "ISU_NM": "ARIRANG 200 증권상장지수투자신탁[주식]",
      "TDD_OPNPRC": "42,075",
      "TDD_HGPRC": "43,250",
      "TDD_LWPRC": "41,900",
      "TDD_CLSPRC": "42,965",
      "CMPPREVDD_PRC": "1,080",
      "FLUC_TP_CD": "1",
      "FLUC_RT": "2.58",
      "ACC_TRDVOL": "192,061",
      "ACC_TRDVAL": "8,222,510,755",
      "LST_NAV": "43,079.14",
      "NAV_CHG_VAL": "1,095.82",
      "NAV_CHG_RT": "2.61",
      "MKTCAP": "850,707,000,000",
      "INVSTASST_NETASST_TOTAMT": "852,966,972,000",
      "LIST_SHRS": "19,800,000",
      "WK52_HGPR": "45,230",
      "WK52_HGPR_DD": "2023/11/28",
      "WK52_LWPR": "38,125",
      "WK52_LWPR_DD": "2023/03/15",
      "OBJ_STKPRC_IDX": "421.35",
      "IDX_IND_NM": "코스피 200",
      "CMPPREVDD_IDX": "10.85",
      "FLUC_TP_CD1": "1",
      "IDX_FLUC_RT": "2.64",
      "DIVRG_RT": "-0.27",
      "LIST_DD": "2008/02/01",
      "COM_ABBRV": "한국투자신탁운용",
      "ETF_TOT_FEE": "0.15",
      "CU_QTY": "100,000",
      "ETF_OBJ_IDX_NM": "코스피 200 지수",
      "IDX_CALC_INST_NM1": "KRX",
      "IDX_MKT_CLSS_NM": "국내",
      "IDX_ASST_CLSS_NM": "주식",
      "ETF_REPLICA_METHD_TP_CD": "실물",
      "IDX_CALC_INST_NM2": "일반",
      "TAX_TP_CD": "배당소득세(보유기간과세)",
      "MKT_NM": "KOSPI"
    }
  ]
}
```

## Kotlin 모델 클래스 설계

### ComprehensiveEtfInfo.kt (전체 구현)

```kotlin
package com.kairos.krx.model

import java.math.BigDecimal
import java.time.LocalDate

/**
 * MDCSTAT04701 - ETF 개별종목 종합정보
 *
 * ETF의 모든 주요 정보를 단일 요청으로 제공하는 종합 데이터 모델
 * OHLCV, NAV, 시가총액, 52주 고가/저가, 기본 정보 등을 포함
 */
data class ComprehensiveEtfInfo(
    // 기본 식별 정보
    val tradeDate: LocalDate,
    val isin: String,
    val ticker: String,
    val name: String,
    val fullName: String,

    // 가격 데이터 (OHLCV) - 모두 BigDecimal
    val openPrice: BigDecimal,
    val highPrice: BigDecimal,
    val lowPrice: BigDecimal,
    val closePrice: BigDecimal,
    val priceChange: BigDecimal,
    val priceChangeDirection: Int,  // 1=상승, 2=하락, 3=보합
    val priceChangeRate: BigDecimal,

    // 거래량 및 거래대금
    val volume: Long,
    val tradingValue: BigDecimal,

    // NAV 정보
    val nav: BigDecimal,
    val navChange: BigDecimal,
    val navChangeRate: BigDecimal,
    val divergenceRate: BigDecimal,  // 괴리율

    // 시가총액 및 주식 수
    val marketCap: BigDecimal,
    val netAssetValue: BigDecimal,
    val listedShares: Long,

    // 52주 고가/저가 (핵심 필드) - BigDecimal
    val week52High: BigDecimal,
    val week52HighDate: LocalDate,
    val week52Low: BigDecimal,
    val week52LowDate: LocalDate,

    // 지수 정보
    val indexValue: BigDecimal,
    val indexName: String,
    val indexChange: BigDecimal,
    val indexChangeDirection: Int,
    val indexChangeRate: BigDecimal,

    // ETF 기본 정보
    val listingDate: LocalDate,
    val assetManager: String,
    val totalFee: BigDecimal,  // 핵심 필드
    val creationUnit: Long,
    val benchmarkIndex: String,
    val indexProvider: String,
    val marketClassification: String,  // 국내/해외
    val assetClass: String,  // 핵심 필드: 주식/채권/상품/파생
    val replicationMethod: String,  // 실물/합성
    val leverageType: String,  // 일반/레버리지/인버스
    val taxType: String,
    val marketName: String
) {
    companion object {
        /**
         * KRX API 원시 응답으로부터 ComprehensiveEtfInfo 생성
         */
        fun fromRaw(raw: Map<*, *>): ComprehensiveEtfInfo {
            return ComprehensiveEtfInfo(
                tradeDate = raw["TRD_DD"].toString().toKrxDate(),
                isin = raw["ISU_CD"].toString(),
                ticker = raw["ISU_SRT_CD"].toString(),
                name = raw["ISU_ABBRV"].toString(),
                fullName = raw["ISU_NM"].toString(),

                openPrice = raw["TDD_OPNPRC"].toString().toKrxPrice(),
                highPrice = raw["TDD_HGPRC"].toString().toKrxPrice(),
                lowPrice = raw["TDD_LWPRC"].toString().toKrxPrice(),
                closePrice = raw["TDD_CLSPRC"].toString().toKrxPrice(),
                priceChange = raw["CMPPREVDD_PRC"].toString().toKrxPrice(),
                priceChangeDirection = raw["FLUC_TP_CD"].toString().toIntOrNull() ?: 3,
                priceChangeRate = raw["FLUC_RT"].toString().toKrxRate(),

                volume = raw["ACC_TRDVOL"].toString().toKrxLong(),
                tradingValue = raw["ACC_TRDVAL"].toString().toKrxAmount(),

                nav = raw["LST_NAV"].toString().toKrxBigDecimal(),
                navChange = raw["NAV_CHG_VAL"].toString().toKrxBigDecimal(),
                navChangeRate = raw["NAV_CHG_RT"].toString().toKrxRate(),
                divergenceRate = raw["DIVRG_RT"].toString().toKrxRate(),

                marketCap = raw["MKTCAP"].toString().toKrxAmount(),
                netAssetValue = raw["INVSTASST_NETASST_TOTAMT"].toString().toKrxAmount(),
                listedShares = raw["LIST_SHRS"].toString().toKrxLong(),

                week52High = raw["WK52_HGPR"].toString().toKrxPrice(),
                week52HighDate = raw["WK52_HGPR_DD"].toString().toKrxDate(),
                week52Low = raw["WK52_LWPR"].toString().toKrxPrice(),
                week52LowDate = raw["WK52_LWPR_DD"].toString().toKrxDate(),

                indexValue = raw["OBJ_STKPRC_IDX"].toString().toKrxBigDecimal(),
                indexName = raw["IDX_IND_NM"].toString(),
                indexChange = raw["CMPPREVDD_IDX"].toString().toKrxBigDecimal(),
                indexChangeDirection = raw["FLUC_TP_CD1"].toString().toIntOrNull() ?: 3,
                indexChangeRate = raw["IDX_FLUC_RT"].toString().toKrxRate(),

                listingDate = raw["LIST_DD"].toString().toKrxDate(),
                assetManager = raw["COM_ABBRV"].toString(),
                totalFee = raw["ETF_TOT_FEE"].toString().toKrxRate(),
                creationUnit = raw["CU_QTY"].toString().toKrxLong(),
                benchmarkIndex = raw["ETF_OBJ_IDX_NM"].toString(),
                indexProvider = raw["IDX_CALC_INST_NM1"].toString(),
                marketClassification = raw["IDX_MKT_CLSS_NM"].toString(),
                assetClass = raw["IDX_ASST_CLSS_NM"].toString(),
                replicationMethod = raw["ETF_REPLICA_METHD_TP_CD"].toString(),
                leverageType = raw["IDX_CALC_INST_NM2"].toString(),
                taxType = raw["TAX_TP_CD"].toString(),
                marketName = raw["MKT_NM"].toString()
            )
        }
    }

    /**
     * 가격이 52주 고가 근처인지 확인 (95% 이상)
     */
    fun isNear52WeekHigh(): Boolean {
        val threshold = week52High.multiply(BigDecimal("0.95"))
        return closePrice >= threshold
    }

    /**
     * 가격이 52주 저가 근처인지 확인 (105% 이하)
     */
    fun isNear52WeekLow(): Boolean {
        val threshold = week52Low.multiply(BigDecimal("1.05"))
        return closePrice <= threshold
    }

    /**
     * 괴리율이 과도한지 확인 (절대값 1% 이상)
     */
    fun hasExcessiveDivergence(): Boolean {
        return divergenceRate.abs() >= BigDecimal("1.0")
    }

    /**
     * 총 보수가 저렴한지 확인 (0.3% 이하)
     */
    fun hasLowFee(): Boolean {
        return totalFee <= BigDecimal("0.3")
    }
}

// 정규화 확장 함수 (NormalizationExtensions.kt에 정의)
fun String.toKrxPrice(): BigDecimal {
    return this.replace(",", "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toBigDecimalOrNull()
        ?.setScale(2, RoundingMode.HALF_UP)
        ?: BigDecimal.ZERO
}

fun String.toKrxAmount(): BigDecimal {
    return this.replace(",", "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toBigDecimalOrNull()
        ?.setScale(0, RoundingMode.HALF_UP)
        ?: BigDecimal.ZERO
}

fun String.toKrxRate(): BigDecimal {
    return this.replace(",", "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toBigDecimalOrNull()
        ?.setScale(4, RoundingMode.HALF_UP)
        ?: BigDecimal.ZERO
}

fun String.toKrxLong(): Long {
    return this.replace(",", "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toLongOrNull() ?: 0L
}

fun String.toKrxBigDecimal(): BigDecimal {
    return this.replace(",", "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toBigDecimalOrNull() ?: BigDecimal.ZERO
}

fun String.toKrxDate(): LocalDate {
    val s = this.trim()
    return when {
        s.isEmpty() || s == "-" -> LocalDate.MIN
        s.contains("/") -> LocalDate.parse(s, DateTimeFormatter.ofPattern("yyyy/MM/dd"))
        else -> LocalDate.parse(s, DateTimeFormatter.ofPattern("yyyyMMdd"))
    }
}
```

## 서비스 메서드 구현

### EtfComprehensiveService.kt (전체 구현)

```kotlin
package com.kairos.krx.etx

import com.kairos.krx.client.KrxClient
import com.kairos.krx.model.ComprehensiveEtfInfo
import com.kairos.krx.ticker.EtxTickerCache
import org.springframework.stereotype.Service
import java.time.LocalDate
import java.time.format.DateTimeFormatter

/**
 * MDCSTAT04701 - ETF 개별종목 종합정보 서비스
 *
 * ETF의 모든 주요 정보를 단일 요청으로 제공
 */
@Service
class EtfComprehensiveService(
    private val client: KrxClient,
    private val tickerCache: EtxTickerCache
) {
    companion object {
        private const val BLD_CODE = "dbms/MDC/STAT/standard/MDCSTAT04701"
    }

    /**
     * ETF 종합 정보 조회
     *
     * @param ticker 6자리 티커 (예: "152100")
     * @param date 거래일 (기본값: 오늘)
     * @return ComprehensiveEtfInfo
     * @throws TickerNotFoundException 티커를 찾을 수 없는 경우
     * @throws KrxApiException API 호출 실패 시
     */
    fun getComprehensiveInfo(
        ticker: String,
        date: LocalDate = LocalDate.now()
    ): ComprehensiveEtfInfo? {
        // 1. 티커를 ISIN으로 변환
        val isin = tickerCache.getIsin(ticker)

        // 2. 요청 파라미터 빌드
        val params = mapOf(
            "trdDd" to date.format(DateTimeFormatter.ofPattern("yyyyMMdd")),
            "isuCd" to isin
        )

        // 3. KRX API 호출
        val response = client.post(BLD_CODE, params)

        // 4. 응답 파싱
        val output = (response["output"] as? List<*>) ?: return null
        if (output.isEmpty()) return null

        val raw = output[0] as? Map<*, *> ?: return null

        // 5. 정규화 및 모델 생성
        return ComprehensiveEtfInfo.fromRaw(raw)
    }

    /**
     * 여러 ETF의 종합 정보 조회
     *
     * @param tickers 티커 목록
     * @param date 거래일
     * @return Map<티커, ComprehensiveEtfInfo>
     */
    fun getComprehensiveInfoMultiple(
        tickers: List<String>,
        date: LocalDate = LocalDate.now()
    ): Map<String, ComprehensiveEtfInfo> {
        return tickers.mapNotNull { ticker ->
            getComprehensiveInfo(ticker, date)?.let { ticker to it }
        }.toMap()
    }

    /**
     * 저보수 ETF 필터링 (0.3% 이하)
     */
    fun getLowFeeEtfs(
        tickers: List<String>,
        date: LocalDate = LocalDate.now()
    ): List<ComprehensiveEtfInfo> {
        return getComprehensiveInfoMultiple(tickers, date)
            .values
            .filter { it.hasLowFee() }
            .sortedBy { it.totalFee }
    }

    /**
     * 52주 고가 근처 ETF 찾기
     */
    fun getEtfsNear52WeekHigh(
        tickers: List<String>,
        date: LocalDate = LocalDate.now()
    ): List<ComprehensiveEtfInfo> {
        return getComprehensiveInfoMultiple(tickers, date)
            .values
            .filter { it.isNear52WeekHigh() }
    }
}
```

## 통합 테스트

### Mdcstat04701IntegrationTest.kt

```kotlin
package com.kairos.krx.integration

import com.kairos.krx.etx.EtfComprehensiveService
import org.junit.jupiter.api.Test
import org.junit.jupiter.api.Assertions.*
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.context.SpringBootTest
import java.time.LocalDate

@SpringBootTest
class Mdcstat04701IntegrationTest {

    @Autowired
    private lateinit var service: EtfComprehensiveService

    @Test
    fun `MDCSTAT04701 - 종합 정보 조회 성공`() {
        // Given
        val ticker = "152100"  // ARIRANG 200
        val date = LocalDate.of(2024, 1, 2)

        // When
        val info = service.getComprehensiveInfo(ticker, date)

        // Then
        assertNotNull(info)
        assertEquals(ticker, info!!.ticker)
        assertEquals(date, info.tradeDate)

        // 가격 데이터 검증
        assertTrue(info.closePrice > BigDecimal.ZERO)
        assertTrue(info.openPrice > BigDecimal.ZERO)
        assertTrue(info.highPrice >= info.closePrice)
        assertTrue(info.lowPrice <= info.closePrice)

        // NAV 검증
        assertTrue(info.nav > BigDecimal.ZERO)

        // 52주 고가/저가 검증 (핵심)
        assertTrue(info.week52High > BigDecimal.ZERO)
        assertTrue(info.week52Low > BigDecimal.ZERO)
        assertTrue(info.week52High >= info.closePrice)
        assertTrue(info.week52Low <= info.closePrice)

        // 총 보수 검증 (핵심)
        assertTrue(info.totalFee >= BigDecimal.ZERO)
        assertTrue(info.totalFee < BigDecimal("10"))  // 10% 미만이어야 함

        // 자산군 검증
        assertNotNull(info.assetClass)
        assertTrue(info.assetClass in listOf("주식", "채권", "상품", "파생"))
    }

    @Test
    fun `저보수 ETF 필터링`() {
        // Given
        val tickers = listOf("152100", "069500", "114800")  // ARIRANG, KODEX, TIGER

        // When
        val lowFeeEtfs = service.getLowFeeEtfs(tickers)

        // Then
        assertTrue(lowFeeEtfs.isNotEmpty())
        lowFeeEtfs.forEach { etf ->
            assertTrue(etf.hasLowFee())
            assertTrue(etf.totalFee <= BigDecimal("0.3"))
        }
    }
}
```

## 사용 예제

### 예제 1: ETF 상세 페이지

```kotlin
// Controller
@GetMapping("/etf/{ticker}")
fun getEtfDetail(@PathVariable ticker: String): EtfDetailResponse {
    val info = comprehensiveService.getComprehensiveInfo(ticker)
        ?: throw NotFoundException("ETF not found: $ticker")

    return EtfDetailResponse(
        ticker = info.ticker,
        name = info.name,
        currentPrice = info.closePrice,
        nav = info.nav,
        divergence = info.divergenceRate,
        totalFee = info.totalFee,
        week52High = info.week52High,
        week52Low = info.week52Low,
        assetClass = info.assetClass,
        marketCap = info.marketCap
    )
}
```

### 예제 2: 52주 고가/저가 분석

```kotlin
fun analyze52WeekRange(ticker: String) {
    val info = comprehensiveService.getComprehensiveInfo(ticker) ?: return

    val range = info.week52High.subtract(info.week52Low)
    val currentFromLow = info.closePrice.subtract(info.week52Low)
    val percentageInRange = currentFromLow.divide(range, 4, RoundingMode.HALF_UP)
        .multiply(BigDecimal("100"))

    println("${info.name} 52주 분석:")
    println("현재가: ${info.closePrice}")
    println("52주 고가: ${info.week52High} (${info.week52HighDate})")
    println("52주 저가: ${info.week52Low} (${info.week52LowDate})")
    println("52주 범위 내 위치: ${percentageInRange.setScale(1, RoundingMode.HALF_UP)}%")

    when {
        info.isNear52WeekHigh() -> println("⚠️ 52주 고가 근처입니다")
        info.isNear52WeekLow() -> println("⚠️ 52주 저가 근처입니다")
    }
}
```

### 예제 3: 보수 비교

```kotlin
fun compareETFs(tickers: List<String>) {
    val infos = comprehensiveService.getComprehensiveInfoMultiple(tickers)

    println("ETF 보수 비교:")
    infos.values
        .sortedBy { it.totalFee }
        .forEach { info ->
            println("${info.name}: ${info.totalFee}%")
        }
}
```

## 핵심 차별화 포인트

1. **52주 고가/저가**: 다른 엔드포인트에서 제공하지 않는 중요한 기술적 지표
2. **총 보수**: ETF 비교 및 선택에 필수적인 비용 정보
3. **자산군**: 포트폴리오 다양화 분석에 필요
4. **단일 요청**: 여러 엔드포인트 호출 없이 모든 데이터 획득

## 다음 단계

1. **Phase 1.1**: `ComprehensiveEtfInfo.kt` 모델 생성
2. **Phase 1.2**: `EtfComprehensiveService.kt` 서비스 구현
3. **Phase 1.3**: 통합 테스트 작성 및 실행
4. **Phase 1.4**: 기존 EtfService와 통합
5. **Phase 1.5**: REST API 엔드포인트 노출

## 참조

- 02-KRX-ETF-엔드포인트-분석.md: 전체 엔드포인트 카탈로그
- 04-데이터-매핑-명세.md: 정규화 규칙
- 05-구현-로드맵.md: 단계별 구현 계획
- 07-테스트-전략.md: 테스트 시나리오
