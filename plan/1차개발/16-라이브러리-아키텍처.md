# kotlin-krx 라이브러리 아키텍처

> **목적**: kotlin-krx 라이브러리의 설계 원칙, 레이어 구조, 책임 분리 정의
> **작성일**: 2025-01-18
> **버전**: v1.0

---

## 목차

1. [설계 철학](#1-설계-철학)
2. [아키텍처 원칙](#2-아키텍처-원칙)
3. [레이어 구조](#3-레이어-구조)
4. [소스별 분류 구조](#4-소스별-분류-구조)
5. [책임 분리](#5-책임-분리)
6. [확장성 전략](#6-확장성-전략)
7. [디자인 패턴](#7-디자인-패턴)
8. [인터페이스 설계](#8-인터페이스-설계)

---

## 1. 설계 철학

### 1.1 핵심 원칙

**"Do One Thing Well"** - UNIX 철학

이 라이브러리는 **데이터 수집 라이브러리**입니다. 다음에만 집중합니다:

1. ✅ **KRX/Naver/OPENDART API 호출**
2. ✅ **Raw 데이터 반환**
3. ✅ **타입 안전성 제공**
4. ✅ **Rate Limiting (Source별 자동 제어)**
5. ❌ 비즈니스 로직 (계산, 조합, 분석)
6. ❌ 데이터 저장 (DB 연동)

### 1.2 라이브러리 vs 애플리케이션

```
┌───────────────────────────────────────────────────────────────┐
│                     애플리케이션 레이어                        │
│                                                               │
│  - 비즈니스 로직 (조정 OHLC 계산, 백테스팅)                   │
│  - 데이터 조합 (KRX + Naver + OPENDART)                       │
│  - 데이터 저장 (DB 저장, 캐싱)                                │
│  - Rate Limiting (API 호출 제어)                              │
│  - 스케줄링 (배치 수집)                                       │
│                                                               │
└────────────────────────┬──────────────────────────────────────┘
                         │
    ╔════════════════════▼════════════════════╗
    ║      kotlin-krx 라이브러리              ║
    ║                                          ║
    ║  ✅ API 호출 (HTTP 통신)                ║
    ║  ✅ 응답 파싱 (JSON/XML → 데이터 클래스)║
    ║  ✅ 타입 변환 (String → Int/BigDecimal) ║
    ║  ✅ 예외 처리 (네트워크, 파싱 에러)     ║
    ║  ✅ 인터페이스 제공 (22개 함수)         ║
    ║                                          ║
    ╚════════════════════╤════════════════════╝
                         │
┌────────────────────────▼──────────────────────────────────────┐
│              외부 데이터 소스                                 │
│                                                               │
│  - KRX API (data.krx.co.kr)                                   │
│  - Naver Finance Chart API                                    │
│  - OPENDART API (opendart.fss.or.kr)                          │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

---

## 2. 아키텍처 원칙

### 2.1 API 1:1 매핑 원칙

**각 라이브러리 함수는 단일 API 엔드포인트에 매핑됩니다.**

```kotlin
// ✅ 좋은 예: 1:1 매핑
fun getEtfList(): List<EtfListItem>
// → KRX API: MDCSTAT04601

fun getEtfOhlcv(isin: String, fromDate: LocalDate, toDate: LocalDate): List<EtfOhlcv>
// → KRX API: MDCSTAT04501

// ❌ 나쁜 예: 여러 API 조합
fun getEtfWithAdjustedPrices(ticker: String): EtfWithAdjustedPrices
// → KRX API + Naver API + 계산 로직 (애플리케이션 책임)
```

**예외**: 730일 자동 분할은 내부 구현 세부사항 (사용자에게 투명)

### 2.2 Raw Data 반환 원칙

**계산이나 조합 없이 API 응답을 그대로 반환합니다.**

```kotlin
// ✅ 좋은 예: Raw Data 반환
data class EtfOhlcv(
    val tradeDate: LocalDate,
    val openPrice: Int,           // 원본 가격 (조정 안됨)
    val closePrice: Int,          // 원본 가격
    val volume: Long,
    val nav: BigDecimal
)

// ❌ 나쁜 예: 계산된 데이터 포함
data class EtfOhlcv(
    val tradeDate: LocalDate,
    val adjustedOpen: BigDecimal,  // 조정 가격 (계산 필요)
    val adjustedClose: BigDecimal, // 조정 가격
    val adjustmentFactor: BigDecimal // 계산 필요
)
```

### 2.3 타입 안전성 원칙

**모든 데이터는 명시적인 타입으로 변환됩니다.**

```kotlin
// ✅ 좋은 예: 타입 안전
data class EtfDetail(
    val isin: String,              // 명시적 타입
    val ticker: String,
    val closePrice: Int,           // Int (null 불가)
    val totalExpenseRatio: BigDecimal, // BigDecimal (정밀도)
    val listingDate: LocalDate     // 날짜 타입
)

// ❌ 나쁜 예: 타입 불명확
data class EtfDetail(
    val data: Map<String, Any?>    // 런타임 타입 체크 필요
)
```

### 2.4 인터페이스 우선 원칙

**구현보다 인터페이스를 먼저 정의합니다.**

```kotlin
// Public API: 인터페이스
interface KrxApiClient {
    suspend fun getEtfList(): List<EtfListItem>
    suspend fun getEtfOhlcv(isin: String, fromDate: LocalDate, toDate: LocalDate): List<EtfOhlcv>
}

// Internal Implementation
internal class KrxApiClientImpl(
    private val httpClient: HttpClient
) : KrxApiClient {
    // 구현 세부사항
}
```

---

## 3. 레이어 구조

### 3.1 3-Layer Architecture (소스별 분류)

```
┌───────────────────────────────────────────────────────────────────────────┐
│                          API Layer (Public)                               │
│                                                                           │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐       │
│  │ api/krx/         │  │ api/naver/       │  │ api/opendart/    │       │
│  │                  │  │                  │  │                  │       │
│  │ KrxEtfApi        │  │ NaverEtfApi      │  │ OpenDartApi      │       │
│  │ KrxBondApi (향후)│  │ NaverStockApi    │  │ (공통)           │       │
│  │ KrxStockApi (향후)│  │ (향후)           │  │  6 functions     │       │
│  │                  │  │                  │  │                  │       │
│  │ 15 ETF functions │  │  1 ETF function  │  │                  │       │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘       │
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────┐      │
│  │                  KrxApiClient (Facade)                         │      │
│  │  - val krx: KrxApi                                             │      │
│  │  - val naver: NaverApi                                         │      │
│  │  - val openDart: OpenDartApi                                   │      │
│  └────────────────────────────────────────────────────────────────┘      │
│                                                                           │
└─────────────────────────────────┬─────────────────────────────────────────┘
                                  │
┌─────────────────────────────────▼─────────────────────────────────────────┐
│                             Model Layer                                   │
│                                                                           │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐       │
│  │ model/krx/etf/   │  │ model/naver/etf/ │  │ model/opendart/  │       │
│  │  13 ETF types    │  │  1 ETF type      │  │  6 types         │       │
│  ├──────────────────┤  ├──────────────────┤  │                  │       │
│  │ model/krx/bond/  │  │ model/naver/     │  └──────────────────┘       │
│  │ (향후)           │  │  stock/ (향후)   │                              │
│  ├──────────────────┤  └──────────────────┘                              │
│  │ model/krx/stock/ │                                                    │
│  │ (향후)           │  ┌──────────────────┐                              │
│  └──────────────────┘  │ model/common/    │                              │
│                        │  Ohlcv, etc      │                              │
│                        └──────────────────┘                              │
│                                                                           │
└─────────────────────────────────┬─────────────────────────────────────────┘
                                  │
┌─────────────────────────────────▼─────────────────────────────────────────┐
│                     Internal Implementation (Internal)                    │
│                                                                           │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐       │
│  │ internal/krx/etf/│  │ internal/naver/  │  │ internal/        │       │
│  │                  │  │  etf/            │  │  opendart/       │       │
│  │ KrxEtfApiImpl    │  │ NaverEtfApiImpl  │  │ OpenDartApiImpl  │       │
│  │ KrxEtfDataParser │  │ NaverEtfParser   │  │ OpenDartXmlParser│       │
│  │ KrxDateSplitter  │  │                  │  │ OpenDartZipHandler│      │
│  │ KrxTypeConverter │  │                  │  │                  │       │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘       │
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────┐      │
│  │              internal/http/ (공통 HTTP 클라이언트)             │      │
│  │  - HttpClientFactory                                           │      │
│  │  - HttpRequestBuilder                                          │      │
│  └────────────────────────────────────────────────────────────────┘      │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

### 3.2 레이어별 책임

#### Layer 1: API Layer (Public)

**책임**:
- 사용자 대상 공개 인터페이스 제공
- 22개 함수의 시그니처 정의
- 파라미터 검증 (날짜 범위, ISIN 형식)
- 예외 정의 및 전파

**가시성**: `public`

**파일 위치**: `src/main/kotlin/dev/kairoscode/kfc/api/`

**예제**:
```kotlin
interface KrxApiClient {
    suspend fun getEtfList(): List<EtfListItem>
    suspend fun getEtfDetail(isin: String, date: LocalDate): EtfDetail
    // ... 13 more functions
}

interface NaverApiClient {
    suspend fun getAdjustedClose(
        ticker: String,
        fromDate: LocalDate,
        toDate: LocalDate
    ): List<AdjustedClose>
}

interface OpenDartApiClient {
    suspend fun getCorpCodeList(): List<CorpCode>
    suspend fun getDividendInfo(corpCode: String, year: Int): List<DividendInfo>
    // ... 4 more functions
}
```

#### Layer 2: Model Layer (Public)

**책임**:
- 데이터 클래스 정의
- 타입 안전성 제공
- 불변성 보장 (`val` only)

**가시성**: `public`

**파일 위치**: `src/main/kotlin/dev/kairoscode/kfc/model/`

**예제**:
```kotlin
data class EtfListItem(
    val isin: String,
    val ticker: String,
    val name: String,
    val listingDate: LocalDate,
    val totalExpenseRatio: BigDecimal
)

data class AdjustedClose(
    val tradeDate: LocalDate,
    val closePrice: Int,
    val adjustedClose: BigDecimal,
    val volume: Long
)
```

#### Layer 3: Internal Implementation (Internal)

**책임**:
- HTTP 통신 (Ktor Client)
- JSON/XML 파싱
- 타입 변환 (String → Int, BigDecimal, LocalDate)
- 데이터 정규화 (콤마 제거, "-" → 0)
- 730일 자동 분할 (KRX API)
- ZIP 압축 해제 (OPENDART API)

**가시성**: `internal`

**파일 위치**: `src/main/kotlin/dev/kairoscode/kfc/internal/`

**예제**:
```kotlin
internal class KrxApiClientImpl(
    private val httpClient: HttpClient
) : KrxApiClient {
    override suspend fun getEtfList(): List<EtfListItem> {
        val response = httpClient.post(url) { /* ... */ }
        val json = Json.parseToJsonElement(response.bodyAsText())
        return parseEtfList(json)
    }

    private fun parseEtfList(json: JsonElement): List<EtfListItem> {
        // 파싱 로직
    }
}

internal fun String.toKrxInt(): Int {
    return this.replace(",", "")
        .let { if (it == "-") "0" else it }
        .toIntOrNull() ?: 0
}
```

---

## 4. 소스별 분류 구조

### 4.1 설계 결정: 소스별 vs 상품별

kotlin-krx는 **소스별 대분류** 구조를 채택합니다:

```
api/krx/        # KRX API (ETF/채권/주식)
api/naver/      # Naver API (ETF/주식)
api/opendart/   # OPENDART API (공통)
```

**대안 (비권장): 상품별 대분류**
```
api/etf/        # 모든 소스의 ETF API
api/bond/       # 모든 소스의 채권 API
api/stock/      # 모든 소스의 주식 API
```

### 4.2 소스별 분류의 장점

| 장점 | 설명 | 예시 |
|-----|------|------|
| **변경 영향 범위 명확** | 특정 소스 API 변경 시 해당 패키지만 수정 | KRX API 변경 → `api/krx/` 만 영향 |
| **HTTP 클라이언트 독립** | 소스별로 다른 HTTP 설정 가능 | KRX (30초 timeout), OPENDART (100ms delay) |
| **인증 전략 분리** | 소스별 인증 방식 다름 | OPENDART는 API Key, KRX/Naver는 인증 없음 |
| **새 소스 추가 용이** | 독립적으로 새 데이터 소스 추가 | `api/yahoo/`, `api/investing/` 추가 |
| **Rate Limiting 분리** | 소스별로 다른 Rate Limit | KRX 10req/s, OPENDART 10req/s, Naver 10req/s |
| **패키지 크기 최적화** | 필요한 소스만 의존 가능 (멀티 모듈 시) | KRX만 사용 시 `kotlin-krx-krx` 의존 |

### 4.3 Facade 패턴 적용

사용자 편의를 위해 통합 API 클라이언트 제공:

```kotlin
// Facade: 통합 API 클라이언트
interface KrxApiClient {
    val krx: KrxApi
    val naver: NaverApi
    val openDart: OpenDartApi
}

// 소스별 API 그룹
interface KrxApi {
    val etf: KrxEtfApi
    val bond: KrxBondApi  // 향후
    val stock: KrxStockApi  // 향후
}

interface NaverApi {
    val etf: NaverEtfApi
    val stock: NaverStockApi  // 향후
}

// OPENDART는 상품 구분 없음 (모든 상장 기업 공통)
interface OpenDartApi {
    suspend fun getCorpCodeList(): List<CorpCode>
    suspend fun getDividendInfo(corpCode: String, year: Int): List<DividendInfo>
    // ... 4 more functions
}
```

**사용 예시**:

```kotlin
// Facade 사용 (권장)
val client = KrxApiClient.create()

// 계층적 접근
val etfList = client.krx.etf.getEtfList()
val adjustedClose = client.naver.etf.getAdjustedClose(...)
val corpCodes = client.openDart.getCorpCodeList()

// 개별 API 직접 사용 (세밀한 제어)
val krxEtfApi = KrxEtfApiFactory.create()
val etfList = krxEtfApi.getEtfList()
```

### 4.4 패키지 구조 상세

#### 4.4.1 API 패키지 (소스별)

```
api/
├── krx/
│   ├── KrxEtfApi.kt                  # interface (15 ETF 함수)
│   ├── KrxBondApi.kt                 # interface (향후)
│   └── KrxStockApi.kt                # interface (향후)
│
├── naver/
│   ├── NaverEtfApi.kt                # interface (1 ETF 함수)
│   └── NaverStockApi.kt              # interface (향후)
│
├── opendart/
│   └── OpenDartApi.kt                # interface (6 함수)
│
└── KrxApiClient.kt                   # Facade interface
```

#### 4.4.2 모델 패키지 (소스별 + 상품별 계층)

```
model/
├── krx/
│   ├── etf/                          # KRX ETF 모델 (13개)
│   │   ├── EtfListItem.kt
│   │   ├── EtfDetail.kt
│   │   ├── EtfOhlcv.kt
│   │   └── ...
│   │
│   ├── bond/                         # KRX 채권 모델 (향후)
│   └── stock/                        # KRX 주식 모델 (향후)
│
├── naver/
│   ├── etf/                          # Naver ETF 모델 (1개)
│   │   └── AdjustedClose.kt
│   │
│   └── stock/                        # Naver 주식 모델 (향후)
│
├── opendart/                         # OPENDART 모델 (6개, 상품 구분 없음)
│   ├── CorpCode.kt
│   ├── DividendInfo.kt
│   └── ...
│
└── common/                           # 공통 모델
    ├── Ohlcv.kt                      # 공통 OHLCV 구조
    └── TradingVolume.kt              # 공통 거래량 구조
```

#### 4.4.3 내부 구현 패키지 (소스별 + 상품별 계층)

```
internal/
├── krx/
│   ├── etf/
│   │   ├── KrxEtfApiImpl.kt          # KRX ETF API 구현
│   │   ├── KrxEtfDataParser.kt       # KRX ETF 응답 파싱
│   │   ├── KrxDateRangeSplitter.kt   # 730일 자동 분할
│   │   └── KrxTypeConverter.kt       # 타입 변환
│   │
│   ├── bond/                         # KRX 채권 구현 (향후)
│   └── stock/                        # KRX 주식 구현 (향후)
│
├── naver/
│   ├── etf/
│   │   ├── NaverEtfApiImpl.kt        # Naver ETF API 구현
│   │   └── NaverEtfDataParser.kt     # Naver ETF 응답 파싱
│   │
│   └── stock/                        # Naver 주식 구현 (향후)
│
├── opendart/
│   ├── OpenDartApiImpl.kt            # OPENDART API 구현
│   ├── OpenDartXmlParser.kt          # XML 파싱
│   └── OpenDartZipHandler.kt         # ZIP 압축 해제
│
└── http/                             # 공통 HTTP 클라이언트
    ├── HttpClientFactory.kt
    └── HttpRequestBuilder.kt
```

### 4.5 확장 시나리오

#### 시나리오 1: KRX 채권 데이터 추가

```kotlin
// 1. API 인터페이스 추가
package dev.kairoscode.kfc.api.krx

interface KrxBondApi {
    suspend fun getBondList(): List<BondListItem>
    suspend fun getBondYield(isin: String, date: LocalDate): BondYield
}

// 2. 모델 추가
package dev.kairoscode.kfc.model.krx.bond

data class BondListItem(
    val isin: String,
    val name: String,
    val issueDate: LocalDate,
    val maturityDate: LocalDate
)

// 3. 내부 구현 추가
package dev.kairoscode.kfc.internal.krx.bond

internal class KrxBondApiImpl : KrxBondApi {
    // 구현
}

// 4. Facade 업데이트
interface KrxApi {
    val etf: KrxEtfApi
    val bond: KrxBondApi  // 추가
}
```

**영향 범위**:
- ✅ KRX 패키지만 수정
- ✅ Naver, OPENDART 패키지 영향 없음
- ✅ 기존 ETF 사용자 코드 영향 없음

#### 시나리오 2: Yahoo Finance API 추가

```kotlin
// 1. 새 소스 패키지 생성
package dev.kairoscode.kfc.api.yahoo

interface YahooApi {
    val stock: YahooStockApi
}

interface YahooStockApi {
    suspend fun getStockQuote(ticker: String): StockQuote
}

// 2. Facade 업데이트
interface KfcClient {
    val krx: KrxApi
    val naver: NaverApi
    val openDart: OpenDartApi
    val yahoo: YahooApi  // 추가
}
```

**영향 범위**:
- ✅ 새 패키지 추가만 필요
- ✅ 기존 소스 (KRX/Naver/OPENDART) 영향 없음

---

## 5. 책임 분리

### 5.1 라이브러리 책임

이 라이브러리가 **반드시 제공해야 하는** 기능:

| 책임 | 구현 위치 | 예제 |
|-----|----------|------|
| ✅ API 호출 | Internal | Ktor HttpClient POST |
| ✅ 응답 파싱 | Internal | JSON → Data Class |
| ✅ 타입 변환 | Internal | "42,965" → Int(42965) |
| ✅ 데이터 정규화 | Internal | "-" → 0, 콤마 제거 |
| ✅ 예외 처리 | API Layer | NoDataException, ApiException |
| ✅ 인터페이스 제공 | API Layer | 22개 함수 |
| ✅ 자동 분할 (730일) | Internal | KRX API 제한 대응 |
| ✅ Rate Limiting | Internal | Token Bucket (Source별) |

### 5.2 애플리케이션 책임

애플리케이션에서 **구현해야 하는** 기능:

| 책임 | 이유 | 예제 |
|-----|------|------|
| ❌ 비즈니스 로직 | 도메인별 요구사항 다양 | 조정 OHLC 계산 |
| ❌ 데이터 조합 | 사용 사례별 차이 | KRX + Naver 병합 |
| ❌ 데이터 저장 | DB 선택은 사용자 결정 | PostgreSQL, MongoDB |
| ❌ 캐싱 | 전략은 사용자 결정 | Redis, In-memory |
| ❌ 스케줄링 | 수집 주기는 사용자 결정 | 일일, 주간, 실시간 |
| ❌ 재시도 로직 | 재시도 전략 다양 | Exponential backoff |

### 5.3 경계 사례 (Borderline Cases)

**Q: 730일 자동 분할은 왜 라이브러리에 포함되나요?**
- KRX API의 기술적 제한 (730일 max)
- 모든 사용자에게 동일하게 적용
- 사용자가 신경 쓸 필요 없는 구현 세부사항

**Q: Rate Limiting은 왜 라이브러리에 포함되나요?**
- 모든 사용자에게 KRX, Naver, OPENDART의 기술적 제한이 동일
- 730일 자동 분할과 마찬가지로 구현 세부사항 (투명한 처리)
- 자동으로 관리되므로 사용자가 신경 쓸 필요 없음
- 필요시 커스터마이징 가능 (기본값 또는 비활성화)

**Q: Ticker → ISIN 변환은 왜 라이브러리에 없나요?**
- ETF 목록은 변동 (신규 상장, 상장 폐지)
- 캐싱 전략은 사용자 결정 (In-memory, DB, Redis)
- `getEtfList()`로 매핑 데이터 제공, 활용은 사용자 책임

---

## 5. 확장성 전략

### 5.1 새로운 API 추가

**예시: Yahoo Finance API 추가**

```kotlin
// 1. 새로운 인터페이스 정의
interface YahooFinanceApiClient {
    suspend fun getStockQuote(ticker: String): StockQuote
}

// 2. 모델 정의
data class StockQuote(
    val ticker: String,
    val price: BigDecimal,
    val volume: Long
)

// 3. 구현체 작성
internal class YahooFinanceApiClientImpl : YahooFinanceApiClient {
    // 구현
}
```

**영향 범위**: 기존 KRX/Naver/OPENDART와 독립적

### 5.2 새로운 데이터 타입 추가

**예시: 선물 데이터 추가**

```kotlin
// KRX API 선물 엔드포인트 매핑
interface KrxFuturesApiClient {
    suspend fun getFuturesList(): List<FuturesItem>
}

data class FuturesItem(
    val contractCode: String,
    val baseAsset: String,
    val expirationDate: LocalDate
)
```

**영향 범위**: 기존 ETF API와 독립적

### 5.3 버전 관리 전략

**Semantic Versioning**:
- **Major (v2.0.0)**: Breaking changes (함수 시그니처 변경)
- **Minor (v1.1.0)**: 새로운 함수 추가 (하위 호환)
- **Patch (v1.0.1)**: 버그 수정

**Breaking Change 예시**:
```kotlin
// v1.0.0
fun getEtfOhlcv(isin: String, fromDate: String, toDate: String): List<EtfOhlcv>

// v2.0.0 (Breaking)
fun getEtfOhlcv(isin: String, fromDate: LocalDate, toDate: LocalDate): List<EtfOhlcv>
```

**Deprecation 전략**:
```kotlin
@Deprecated(
    message = "Use getEtfOhlcv(LocalDate) instead",
    replaceWith = ReplaceWith("getEtfOhlcv(isin, LocalDate.parse(fromDate), LocalDate.parse(toDate))")
)
fun getEtfOhlcv(isin: String, fromDate: String, toDate: String): List<EtfOhlcv>
```

---

## 6. 디자인 패턴

### 6.1 Factory Pattern

**API 클라이언트 생성**

```kotlin
object KrxClientFactory {
    fun create(
        baseUrl: String = "https://data-dbg.krx.co.kr",
        timeout: Long = 30000
    ): KrxApiClient {
        val httpClient = HttpClient(CIO) {
            install(ContentNegotiation) {
                json()
            }
            install(HttpTimeout) {
                requestTimeoutMillis = timeout
            }
        }

        return KrxApiClientImpl(httpClient)
    }
}

// 사용
val krxClient = KrxClientFactory.create()
```

### 6.2 Strategy Pattern

**타입 변환 전략**

```kotlin
internal interface TypeConverter<T> {
    fun convert(raw: String): T
}

internal object IntConverter : TypeConverter<Int> {
    override fun convert(raw: String): Int {
        return raw.replace(",", "")
            .let { if (it == "-") "0" else it }
            .toIntOrNull() ?: 0
    }
}

internal object BigDecimalConverter : TypeConverter<BigDecimal> {
    override fun convert(raw: String): BigDecimal {
        return raw.replace(",", "")
            .let { if (it == "-") "0" else it }
            .toBigDecimalOrNull() ?: BigDecimal.ZERO
    }
}
```

### 6.3 Template Method Pattern

**API 요청 템플릿**

```kotlin
internal abstract class BaseApiClient(
    protected val httpClient: HttpClient
) {
    protected suspend fun <T> request(
        url: String,
        params: Map<String, String>,
        parser: (JsonElement) -> T
    ): T {
        // 1. 요청 전처리
        validateParams(params)

        // 2. HTTP 요청
        val response = httpClient.post(url) {
            setBody(params)
        }

        // 3. 응답 검증
        validateResponse(response)

        // 4. 파싱
        val json = Json.parseToJsonElement(response.bodyAsText())
        return parser(json)
    }

    protected open fun validateParams(params: Map<String, String>) {
        // 파라미터 검증 로직
    }

    protected open fun validateResponse(response: HttpResponse) {
        // 응답 검증 로직
    }
}
```

### 6.4 Builder Pattern

**HTTP 클라이언트 구성**

```kotlin
class KrxClientBuilder {
    private var baseUrl: String = "https://data-dbg.krx.co.kr"
    private var timeout: Long = 30000
    private var retryCount: Int = 3

    fun baseUrl(url: String) = apply { this.baseUrl = url }
    fun timeout(millis: Long) = apply { this.timeout = millis }
    fun retryCount(count: Int) = apply { this.retryCount = count }

    fun build(): KrxApiClient {
        val httpClient = HttpClient(CIO) {
            install(ContentNegotiation) { json() }
            install(HttpTimeout) { requestTimeoutMillis = timeout }
        }

        return KrxApiClientImpl(httpClient, retryCount)
    }
}

// 사용
val client = KrxClientBuilder()
    .baseUrl("https://data.krx.co.kr")
    .timeout(60000)
    .retryCount(5)
    .build()
```

---

## 7. 인터페이스 설계

### 7.1 인터페이스 분리 원칙 (ISP)

**단일 책임을 가진 작은 인터페이스**

```kotlin
// ✅ 좋은 예: 기능별 분리
interface EtfMasterDataApi {
    suspend fun getEtfList(): List<EtfListItem>
    suspend fun getEtfDetail(isin: String, date: LocalDate): EtfDetail
    suspend fun searchEtf(searchTerm: String): List<EtfSearchResult>
}

interface EtfPriceDataApi {
    suspend fun getEtfOhlcv(isin: String, fromDate: LocalDate, toDate: LocalDate): List<EtfOhlcv>
    suspend fun getAllEtfDailyPrices(date: LocalDate): List<EtfDailyPrice>
}

interface EtfPerformanceApi {
    suspend fun getEtfTrackingError(isin: String, fromDate: LocalDate, toDate: LocalDate): List<TrackingError>
    suspend fun getEtfDivergenceRate(isin: String, fromDate: LocalDate, toDate: LocalDate): List<DivergenceRate>
}

// ❌ 나쁜 예: 모든 기능을 하나의 인터페이스에
interface KrxApiClient {
    // 15 functions in one interface
}
```

### 7.2 의존성 역전 원칙 (DIP)

**구현이 아닌 인터페이스에 의존**

```kotlin
// ✅ 좋은 예: 인터페이스 의존
class EtfDataCollector(
    private val krxClient: KrxApiClient,  // 인터페이스
    private val naverClient: NaverApiClient  // 인터페이스
) {
    suspend fun collect(ticker: String) {
        // ...
    }
}

// ❌ 나쁜 예: 구현체 직접 의존
class EtfDataCollector(
    private val krxClient: KrxApiClientImpl  // 구현체
) {
    // 테스트 어려움, 유연성 감소
}
```

### 7.3 멀티플랫폼 고려 (향후)

**Kotlin Multiplatform 대비 설계**

```kotlin
// 공통 인터페이스 (commonMain)
expect interface HttpClient {
    suspend fun post(url: String, body: String): String
}

// JVM 구현 (jvmMain)
actual class HttpClientImpl : HttpClient {
    private val client = OkHttpClient()

    override suspend fun post(url: String, body: String): String {
        // OkHttp 구현
    }
}

// JS 구현 (jsMain)
actual class HttpClientImpl : HttpClient {
    override suspend fun post(url: String, body: String): String {
        // Fetch API 구현
    }
}
```

---

## 요약

### 설계 원칙 Checklist

- ✅ **API 1:1 매핑**: 각 함수는 단일 API 엔드포인트에 매핑
- ✅ **Raw Data 반환**: 계산이나 조합 없이 API 응답을 그대로 반환
- ✅ **타입 안전성**: 모든 데이터는 명시적 타입으로 변환
- ✅ **인터페이스 우선**: 구현보다 인터페이스를 먼저 정의
- ✅ **책임 분리**: 라이브러리 vs 애플리케이션 명확히 구분
- ✅ **확장 가능**: 새로운 API, 데이터 타입 추가 용이
- ✅ **디자인 패턴**: Factory, Strategy, Template Method, Builder 적용
- ✅ **Rate Limiting**: Source별 투명한 자동 제어

### 라이브러리 vs 애플리케이션

| 구분 | 라이브러리 (kotlin-krx) | 애플리케이션 |
|------|-------------------------|-------------|
| **역할** | 데이터 수집 + Rate 제어 | 비즈니스 로직 |
| **예시** | API 호출, 파싱, 타입 변환, Rate Limiting | 계산, 조합, 저장, 스케줄링 |
| **의존성** | Ktor, Kotlinx-serialization | Spring, PostgreSQL, Redis |
| **테스트** | 단위 테스트, 통합 테스트 | E2E 테스트, 성능 테스트 |

---

**작성일**: 2025-01-19
**버전**: v2.0 (소스별 분류 + Facade 패턴)
**작성자**: kotlin-krx 프로젝트
