# 데이터 매핑 명세

## 개요

본 문서는 KRX API 원시 응답 데이터를 Kotlin 타입 안전 모델로 변환하기 위한 완전한 매핑 규칙을 제공합니다. 모든 엔드포인트의 필드 매핑, 데이터 타입 변환, 정규화 규칙, 특수 값 처리를 포함합니다.

## 금융 데이터 타입 선택 가이드

### BigDecimal 사용 원칙

kotlin-krx는 모든 금융 관련 값에 `BigDecimal`을 사용합니다:

**이유**:
1. **정밀도 보장**: 부동소수점 오류 없음
2. **오버플로우 방지**: 임의 정밀도 지원
3. **금융 표준**: 금융 시스템의 업계 표준
4. **감사 추적**: 정확한 계산 결과 보장

**타입별 용도**:

| 데이터 종류 | Kotlin 타입 | 스케일 | 예시 |
|------------|------------|--------|------|
| 가격 (Price) | `BigDecimal` | 2 | 종가, 시가, NAV |
| 금액 (Amount) | `BigDecimal` | 0 | 시가총액, 거래대금 |
| 비율 (Rate) | `BigDecimal` | 4 | 등락률, 보수율 |
| 수량 (Quantity) | `Long` | - | 거래량, 주식수 |
| 개수 (Count) | `Long` | - | CU 수량 |
| 날짜 (Date) | `LocalDate` | - | 거래일 |

**잘못된 예 ❌**:
```kotlin
data class Price(
    val close: Int,           // ❌ 오버플로우 위험
    val amount: Long,         // ❌ 정밀도 손실
    val changeRate: Double    // ❌ 부동소수점 오류
)
```

**올바른 예 ✅**:
```kotlin
data class Price(
    val close: BigDecimal,         // ✅ 정밀도 보장
    val amount: BigDecimal,        // ✅ 임의 크기 지원
    val changeRate: BigDecimal,    // ✅ 정확한 계산
    val volume: Long               // ✅ 정수 수량
)
```

### BigDecimal 연산 예제

```kotlin
// 가격 계산
val price1 = BigDecimal("42965.00")
val price2 = BigDecimal("43079.14")
val diff = price2.subtract(price1)  // 114.14

// 비율 계산 (괴리율)
val marketPrice = BigDecimal("42965.00")
val nav = BigDecimal("43079.14")
val deviation = marketPrice.subtract(nav)
    .divide(nav, 4, RoundingMode.HALF_UP)
    .multiply(BigDecimal("100"))  // -0.2650%

// 금액 계산 (거래대금)
val volume = 2500000L
val price = BigDecimal("42965.00")
val amount = price.multiply(BigDecimal(volume))  // 107,412,500,000
```

---

## 데이터 타입 변환 규칙

### 1. String → BigDecimal (가격 - Prices)

**사용 사례**: 시가, 고가, 저가, 종가

**원시 형식**: `"42,965"`, `"43,250"`, `"-"`, `""`

**정규화 규칙**:
1. 콤마(`,`) 제거
2. 공백 제거 (trim)
3. `"-"` → `"0"` 변환
4. 빈 문자열 → `"0"` 변환
5. `toBigDecimalOrNull()` 사용, 실패 시 `BigDecimal.ZERO` 반환

**스케일 설정**: 소수점 2자리 (RoundingMode.HALF_UP)

**Kotlin 구현**:
```kotlin
fun String.toKrxPrice(): BigDecimal {
    return this.replace(",", "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toBigDecimalOrNull()
        ?.setScale(2, RoundingMode.HALF_UP)
        ?: BigDecimal.ZERO
}
```

**예제**:
```kotlin
"42,965".toKrxPrice()     // BigDecimal("42965.00")
"43,250.50".toKrxPrice()  // BigDecimal("43250.50")
"-".toKrxPrice()          // BigDecimal("0.00")
"".toKrxPrice()           // BigDecimal("0.00")
```

---

### 2. String → BigDecimal (금액 - Amounts)

**사용 사례**: 시가총액, 거래대금, 투자자산총액

**원시 형식**: `"850,707,000,000"`, `"-"`, `""`

**정규화 규칙**:
1. 콤마 제거
2. 공백 제거
3. `"-"` → `"0"` 변환
4. 빈 문자열 → `"0"` 변환
5. `toBigDecimalOrNull()` 사용

**스케일 설정**: 소수점 0자리 (정수 금액)

**Kotlin 구현**:
```kotlin
fun String.toKrxAmount(): BigDecimal {
    return this.replace(",", "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toBigDecimalOrNull()
        ?.setScale(0, RoundingMode.HALF_UP)
        ?: BigDecimal.ZERO
}
```

**예제**:
```kotlin
"850,707,000,000".toKrxAmount()  // BigDecimal("850707000000")
"8,222,510,755".toKrxAmount()    // BigDecimal("8222510755")
"-".toKrxAmount()                 // BigDecimal("0")
```

---

### 3. String → BigDecimal (비율 - Rates/Ratios)

**사용 사례**: 등락률, 괴리율, 추적오차율, 보수율

**원시 형식**: `"2.58"`, `"-1.23"`, `"0.15"`, `"-"`, `""`

**정규화 규칙**:
1. 콤마 제거 (드물지만 존재 가능)
2. 공백 제거
3. `"-"` → `"0"` 변환
4. 빈 문자열 → `"0"` 변환
5. **음수 부호 유지**
6. `toBigDecimalOrNull()` 사용

**스케일 설정**: 소수점 4자리 (RoundingMode.HALF_UP)

**Kotlin 구현**:
```kotlin
fun String.toKrxRate(): BigDecimal {
    return this.replace(",", "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toBigDecimalOrNull()
        ?.setScale(4, RoundingMode.HALF_UP)
        ?: BigDecimal.ZERO
}
```

**예제**:
```kotlin
"2.58".toKrxRate()     // BigDecimal("2.5800")
"-1.23".toKrxRate()    // BigDecimal("-1.2300") - 음수 유지
"0.15".toKrxRate()     // BigDecimal("0.1500")
"-".toKrxRate()        // BigDecimal("0.0000")
"".toKrxRate()         // BigDecimal("0.0000")
```

---

### 4. String → BigDecimal (NAV 및 지수 - High Precision)

**사용 사례**: NAV, 지수 값, NAV 변화금액

**원시 형식**: `"43,079.14"`, `"421.35"`, `"-"`, `""`

**정규화 규칙**:
1. 콤마 제거
2. 공백 제거
3. `"-"` → `"0"` 변환
4. 빈 문자열 → `"0"` 변환
5. `toBigDecimalOrNull()` 사용, 실패 시 `BigDecimal.ZERO` 반환

**스케일 설정**: 원본 정밀도 유지 (스케일 지정 안함)

**Kotlin 구현**:
```kotlin
fun String.toKrxBigDecimal(): BigDecimal {
    return this.replace(",", "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toBigDecimalOrNull() ?: BigDecimal.ZERO
}
```

**예제**:
```kotlin
"43,079.14".toKrxBigDecimal()  // BigDecimal("43079.14")
"421.35".toKrxBigDecimal()     // BigDecimal("421.35")
"0.15".toKrxBigDecimal()       // BigDecimal("0.15")
"-".toKrxBigDecimal()          // BigDecimal.ZERO
```

---

### 5. String → Long (수량 - Quantities)

**사용 사례**: 거래량, 상장주식수, 계약수 (정수만)

**원시 형식**: `"192,061"`, `"19,800,000"`, `"-"`, `""`

**정규화 규칙**:
1. 콤마 제거
2. 공백 제거
3. `"-"` → `"0"` 변환
4. 빈 문자열 → `"0"` 변환
5. `toLongOrNull()` 사용, 실패 시 `0L` 반환

**Kotlin 구현**:
```kotlin
fun String.toKrxLong(): Long {
    return this.replace(",", "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toLongOrNull() ?: 0L
}
```

**예제**:
```kotlin
"192,061".toKrxLong()          // 192061L
"19,800,000".toKrxLong()       // 19800000L
"850,707,000,000".toKrxLong()  // 850707000000L (시가총액 호환성)
"-".toKrxLong()                // 0L
```

---

### 6. String → Long (부호 있음 - 순매수)

**사용 사례**: 순매수 거래대금, 순매수 거래량 (음수 가능)

**원시 형식**: `"1,234,567"`, `"-1,234,567"`, `"-"`, `""`

**정규화 규칙**:
1. 콤마 제거
2. 공백 제거
3. `"-"` 단독 → `"0"` 변환
4. 빈 문자열 → `"0"` 변환
5. **음수 부호 유지**
6. `toLongOrNull()` 사용

**Kotlin 구현**:
```kotlin
fun String.toKrxSignedLong(): Long {
    val clean = this.replace(",", "").trim()
    return when {
        clean.isEmpty() || clean == "-" -> 0L
        else -> clean.toLongOrNull() ?: 0L
    }
}
```

**예제**:
```kotlin
"1,234,567".toKrxSignedLong()   // 1234567L
"-1,234,567".toKrxSignedLong()  // -1234567L (음수 유지)
"-".toKrxSignedLong()           // 0L
```

---

### 7. String → LocalDate (날짜)

**사용 사례**: 거래일, 상장일, 52주 고가/저가 날짜

**원시 형식**:
- Slash 형식: `"2024/01/02"`
- Compact 형식: `"20240102"`
- 특수 값: `"-"`, `""`

**정규화 규칙**:
1. 공백 제거
2. `"-"` → `LocalDate.MIN` 변환
3. 빈 문자열 → `LocalDate.MIN` 변환
4. `/` 포함 → `yyyy/MM/dd` 형식 파싱
5. 그 외 → `yyyyMMdd` 형식 파싱

**Kotlin 구현**:
```kotlin
import java.time.LocalDate
import java.time.format.DateTimeFormatter

fun String.toKrxDate(): LocalDate {
    val s = this.trim()
    return when {
        s.isEmpty() || s == "-" -> LocalDate.MIN
        s.contains("/") -> LocalDate.parse(s, DateTimeFormatter.ofPattern("yyyy/MM/dd"))
        else -> LocalDate.parse(s, DateTimeFormatter.ofPattern("yyyyMMdd"))
    }
}
```

**예제**:
```kotlin
"2024/01/02".toKrxDate()  // LocalDate.of(2024, 1, 2)
"20240102".toKrxDate()    // LocalDate.of(2024, 1, 2)
"-".toKrxDate()           // LocalDate.MIN
"".toKrxDate()            // LocalDate.MIN
```

---

### 8. String → Enum (등락구분)

**사용 사례**: 가격 방향, 지수 방향

**원시 형식**: `"1"`, `"2"`, `"3"`

**매핑**:
- `"1"` → `Direction.UP` (상승)
- `"2"` → `Direction.DOWN` (하락)
- `"3"` → `Direction.UNCHANGED` (보합)

**Kotlin 구현**:
```kotlin
enum class Direction {
    UP,       // 상승
    DOWN,     // 하락
    UNCHANGED // 보합
}

fun String.toKrxDirection(): Direction {
    return when (this.trim()) {
        "1" -> Direction.UP
        "2" -> Direction.DOWN
        "3" -> Direction.UNCHANGED
        else -> Direction.UNCHANGED
    }
}
```

---

## 주요 엔드포인트별 매핑 테이블

### MDCSTAT04701 - ETF 개별종목 종합정보

| KRX 필드 | 한글명 | 원본 타입 | 정규화 타입 | 변환 함수 | 예시 입력 | 예시 출력 |
|---------|--------|----------|-----------|----------|----------|----------|
| TRD_DD | 거래일자 | String | LocalDate | toKrxDate() | "2024/01/02" | LocalDate(2024, 1, 2) |
| ISU_CD | 종목코드 | String | String | (변환 없음) | "KR7152100004" | "KR7152100004" |
| ISU_SRT_CD | 단축코드 | String | String | (변환 없음) | "152100" | "152100" |
| TDD_CLSPRC | 종가 | String | **BigDecimal** | toKrxPrice() | "42,965" | BigDecimal("42965.00") |
| LST_NAV | NAV | String | BigDecimal | toKrxBigDecimal() | "43,079.14" | BigDecimal("43079.14") |
| ACC_TRDVOL | 거래량 | String | Long | toKrxLong() | "192,061" | 192061L |
| MKTCAP | 시가총액 | String | **BigDecimal** | toKrxAmount() | "850,707,000,000" | BigDecimal("850707000000") |
| FLUC_RT | 등락률 | String | **BigDecimal** | toKrxRate() | "2.58" | BigDecimal("2.5800") |
| WK52_HGPR | 52주최고가 | String | **BigDecimal** | toKrxPrice() | "45,230" | BigDecimal("45230.00") |
| ETF_TOT_FEE | 총보수 | String | BigDecimal | toKrxRate() | "0.15" | BigDecimal("0.1500") |

### MDCSTAT04501 - 개별종목 시세 추이 (OHLCV)

| KRX 필드 | 한글명 | 원본 타입 | 정규화 타입 | 변환 함수 | 비고 |
|---------|--------|----------|-----------|----------|------|
| TRD_DD | 날짜 | String | LocalDate | toKrxDate() | |
| TDD_OPNPRC | 시가 | String | **BigDecimal** | toKrxPrice() | |
| TDD_HGPRC | 고가 | String | **BigDecimal** | toKrxPrice() | |
| TDD_LWPRC | 저가 | String | **BigDecimal** | toKrxPrice() | |
| TDD_CLSPRC | 종가 | String | **BigDecimal** | toKrxPrice() | |
| ACC_TRDVOL | 거래량 | String | Long | toKrxLong() | |
| ACC_TRDVAL | 거래대금 | String | **BigDecimal** | toKrxAmount() | |
| LST_NAV | NAV | String | BigDecimal | toKrxBigDecimal() | |
| OBJ_STKPRC_IDX | 지수 | String | BigDecimal | toKrxBigDecimal() | |

### MDCSTAT04601 - ETF 전종목 기본정보

| KRX 필드 | 한글명 | 원본 타입 | 정규화 타입 | 변환 함수 | 비고 |
|---------|--------|----------|-----------|----------|------|
| ISU_CD | 종목코드 | String | String | (변환 없음) | ISIN |
| ISU_SRT_CD | 단축코드 | String | String | (변환 없음) | 티커 |
| ISU_ABBRV | 종목약명 | String | String | (변환 없음) | |
| LIST_DD | 상장일 | String | LocalDate | toKrxDate() | |
| ETF_TOT_FEE | 총보수 | String | BigDecimal | toKrxRate() | |
| LIST_SHRS | 상장주식수 | String | Long | toKrxLong() | |
| CU_QTY | CU수량 | String | Long | toKrxLong() | |
| IDX_ASST_CLSS_NM | 자산구분 | String | String | (변환 없음) | 주식/채권/상품 |

### MDCSTAT04801 - 투자자별 거래실적 (기간합계)

| KRX 필드 | 한글명 | 원본 타입 | 정규화 타입 | 변환 함수 | 비고 |
|---------|--------|----------|-----------|----------|------|
| INVST_NM | 투자자명 | String | String | (변환 없음) | |
| ASK_TRDVOL | 매도거래량 | String | Long | toKrxLong() | 항상 양수 |
| BID_TRDVOL | 매수거래량 | String | Long | toKrxLong() | 항상 양수 |
| NETBID_TRDVOL | 순매수거래량 | String | Long | toKrxSignedLong() | **부호 있음** |
| ASK_TRDVAL | 매도거래대금 | String | **BigDecimal** | toKrxAmount() | 항상 양수 |
| BID_TRDVAL | 매수거래대금 | String | **BigDecimal** | toKrxAmount() | 항상 양수 |
| NETBID_TRDVAL | 순매수거래대금 | String | Long | toKrxSignedLong() | **부호 있음** |

### MDCSTAT04802 - 투자자별 거래실적 (일별추이)

| KRX 필드 | 한글명 | 원본 타입 | 정규화 타입 | 변환 함수 | 비고 |
|---------|--------|----------|-----------|----------|------|
| TRD_DD | 날짜 | String | LocalDate | toKrxDate() | |
| NUM_ITM_VAL21 | 기관 | String | Long | toKrxSignedLong() | **부호 있음** |
| NUM_ITM_VAL22 | 기타법인 | String | Long | toKrxSignedLong() | **부호 있음** |
| NUM_ITM_VAL23 | 개인 | String | Long | toKrxSignedLong() | **부호 있음** |
| NUM_ITM_VAL24 | 외국인 | String | Long | toKrxSignedLong() | **부호 있음** |
| NUM_ITM_VAL25 | 전체 | String | Long | toKrxSignedLong() | 순매수는 항상 0 |

### MDCSTAT05001 - PDF (포트폴리오)

| KRX 필드 | 한글명 | 원본 타입 | 정규화 타입 | 변환 함수 | 비고 |
|---------|--------|----------|-----------|----------|------|
| COMPST_ISU_CD | 구성종목코드 | String | String | (변환 없음) | 혼합 형식 주의 |
| COMPST_ISU_NM | 구성종목명 | String | String | (변환 없음) | |
| COMPST_ISU_CU1_SHRS | 수량 | String | BigDecimal | toKrxBigDecimal() | 소수점 가능 |
| VALU_AMT | 금액 | String | **BigDecimal** | toKrxAmount() | |
| COMPST_RTO | 비중 | String | BigDecimal | toKrxRate() | 백분율 |

### MDCSTAT05901 - 추적오차율 추이

| KRX 필드 | 한글명 | 원본 타입 | 정규화 타입 | 변환 함수 | 비고 |
|---------|--------|----------|-----------|----------|------|
| TRD_DD | 날짜 | String | LocalDate | toKrxDate() | |
| LST_NAV | NAV | String | BigDecimal | toKrxBigDecimal() | |
| NAV_CHG_RT | NAV변동률 | String | **BigDecimal** | toKrxRate() | |
| OBJ_STKPRC_IDX | 지수 | String | BigDecimal | toKrxBigDecimal() | |
| IDX_CHG_RTO | 지수변동률 | String | **BigDecimal** | toKrxRate() | |
| TRACE_ERR_RT | 추적오차율 | String | **BigDecimal** | toKrxRate() | |

### MDCSTAT06001 - 괴리율 추이

| KRX 필드 | 한글명 | 원본 타입 | 정규화 타입 | 변환 함수 | 비고 |
|---------|--------|----------|-----------|----------|------|
| TRD_DD | 날짜 | String | LocalDate | toKrxDate() | |
| CLSPRC | 종가 | String | **BigDecimal** | toKrxPrice() | |
| LST_NAV | NAV | String | BigDecimal | toKrxBigDecimal() | |
| DIVRG_RT | 괴리율 | String | **BigDecimal** | toKrxRate() | **부호 있음** |

---

## 특수 값 처리

### 1. "-" (대시)

**의미**: 데이터 없음 또는 해당 없음

**처리 방법**:
- 숫자 타입: `0` 또는 `BigDecimal.ZERO`로 변환
- 날짜 타입: `LocalDate.MIN`으로 변환
- 문자열 타입: 그대로 유지 또는 `null`

**발생 사례**:
- 신규 상장 ETF의 과거 데이터
- 휴일의 거래 데이터
- 선택적 필드

### 2. "" (빈 문자열)

**의미**: 데이터 누락

**처리 방법**: `"-"`와 동일

### 3. null

**의미**: 필드 자체가 응답에 없음

**처리 방법**:
- Kotlin의 null 안전성 활용
- Elvis 연산자 `?:` 사용
- 기본값 제공

**예제**:
```kotlin
val value = raw["FIELD_NAME"]?.toString()?.toKrxBigDecimal() ?: BigDecimal.ZERO
```

### 4. 음수 값 (부호 있는 정수)

**발생 필드**:
- `NETBID_TRDVAL` (순매수 거래대금)
- `NETBID_TRDVOL` (순매수 거래량)
- `NUM_ITM_VAL21~24` (투자자별 순매수)
- `CMPPREVDD_PRC` (전일 대비 - 하락 시)
- `DIVRG_RT` (괴리율 - 음수 가능)

**처리 방법**: **음수 부호 유지** (제거하지 않음)

---

## 정규화 파이프라인 (단계별)

### 전체 흐름

```
┌──────────────────────────────────────────────────────────────┐
│           1단계: KRX API 원시 JSON 응답                      │
│  {                                                           │
│    "TRD_DD": "2024/01/02",                                   │
│    "TDD_CLSPRC": "42,965",                                   │
│    "ACC_TRDVOL": "192,061",                                  │
│    "LST_NAV": "43,079.14",                                   │
│    "FLUC_RT": "2.58",                                        │
│    "MKTCAP": "850,707,000,000",                              │
│    "NETBID_TRDVAL": "-1,234,567"                             │
│  }                                                           │
└──────────────────────┬───────────────────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────────────────┐
│           2단계: 필드 추출 (Map 접근)                        │
│  val rawClosePrice = raw["TDD_CLSPRC"]                       │
│  // "42,965"                                                 │
└──────────────────────┬───────────────────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────────────────┐
│           3단계: 타입 변환 (toString)                        │
│  val closePriceStr = rawClosePrice.toString()                │
│  // "42,965"                                                 │
└──────────────────────┬───────────────────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────────────────┐
│           4단계: 정규화 확장 함수 호출                       │
│  val closePrice = closePriceStr.toKrxPrice()                 │
│                                                              │
│  내부 동작:                                                  │
│  1. replace(",", "") → "42965"                               │
│  2. trim() → "42965"                                         │
│  3. "-" 체크 → 해당 없음                                     │
│  4. toBigDecimalOrNull() → BigDecimal("42965")               │
│  5. setScale(2) → BigDecimal("42965.00")                     │
└──────────────────────┬───────────────────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────────────────┐
│           5단계: 타입 안전 모델 생성                         │
│  ComprehensiveEtfInfo(                                       │
│    closePrice = BigDecimal("42965.00"),                      │
│    volume = 192061L,                                         │
│    nav = BigDecimal("43079.14"),                             │
│    changeRate = BigDecimal("2.5800"),                        │
│    marketCap = BigDecimal("850707000000"),                   │
│    netBuyValue = -1234567L  // 음수 유지                     │
│  )                                                           │
└──────────────────────────────────────────────────────────────┘
```

---

## 정규화를 위한 Kotlin 확장 함수 (완전한 구현)

### NormalizationExtensions.kt

```kotlin
package com.kairos.krx.util

import java.math.BigDecimal
import java.math.RoundingMode
import java.time.LocalDate
import java.time.format.DateTimeFormatter

/**
 * KRX API 응답 데이터 정규화를 위한 확장 함수
 */

// 날짜 형식
private val slashFormatter = DateTimeFormatter.ofPattern("yyyy/MM/dd")
private val compactFormatter = DateTimeFormatter.ofPattern("yyyyMMdd")

/**
 * String → BigDecimal 변환 (가격용)
 * 콤마 제거, "-" → 0, 빈 문자열 → 0
 * 스케일: 소수점 2자리
 */
fun String.toKrxPrice(): BigDecimal {
    return this.replace(",", "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toBigDecimalOrNull()
        ?.setScale(2, RoundingMode.HALF_UP)
        ?: BigDecimal.ZERO
}

/**
 * String → BigDecimal 변환 (금액용)
 * 콤마 제거, "-" → 0, 빈 문자열 → 0
 * 스케일: 소수점 0자리 (정수)
 */
fun String.toKrxAmount(): BigDecimal {
    return this.replace(",", "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toBigDecimalOrNull()
        ?.setScale(0, RoundingMode.HALF_UP)
        ?: BigDecimal.ZERO
}

/**
 * String → BigDecimal 변환 (비율용)
 * 비율, 등락률 등에 사용
 * 음수 부호 유지
 * 스케일: 소수점 4자리
 */
fun String.toKrxRate(): BigDecimal {
    return this.replace(",", "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toBigDecimalOrNull()
        ?.setScale(4, RoundingMode.HALF_UP)
        ?: BigDecimal.ZERO
}

/**
 * String → BigDecimal 변환 (고정밀)
 * NAV, 지수, 보수율 등 고정밀 계산에 사용
 * 원본 정밀도 유지
 */
fun String.toKrxBigDecimal(): BigDecimal {
    return this.replace(",", "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toBigDecimalOrNull() ?: BigDecimal.ZERO
}

/**
 * String → Long 변환 (항상 양수)
 * 콤마 제거, "-" → 0, 빈 문자열 → 0
 */
fun String.toKrxLong(): Long {
    return this.replace(",", "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toLongOrNull() ?: 0L
}

/**
 * String → Long 변환 (부호 있음)
 * 순매수 거래량/거래대금 등에 사용
 * 음수 부호 유지
 */
fun String.toKrxSignedLong(): Long {
    val clean = this.replace(",", "").trim()
    return when {
        clean.isEmpty() || clean == "-" -> 0L
        else -> clean.toLongOrNull() ?: 0L
    }
}

/**
 * String → LocalDate 변환
 * 두 가지 형식 지원: "yyyy/MM/dd", "yyyyMMdd"
 * "-" 또는 빈 문자열 → LocalDate.MIN
 */
fun String.toKrxDate(): LocalDate {
    val s = this.trim()
    return when {
        s.isEmpty() || s == "-" -> LocalDate.MIN
        s.contains("/") -> {
            try {
                LocalDate.parse(s, slashFormatter)
            } catch (e: Exception) {
                LocalDate.MIN
            }
        }
        else -> {
            try {
                LocalDate.parse(s, compactFormatter)
            } catch (e: Exception) {
                LocalDate.MIN
            }
        }
    }
}

/**
 * String → Direction Enum 변환
 * 1=상승, 2=하락, 3=보합
 */
fun String.toKrxDirection(): Direction {
    return when (this.trim()) {
        "1" -> Direction.UP
        "2" -> Direction.DOWN
        "3" -> Direction.UNCHANGED
        else -> Direction.UNCHANGED
    }
}

/**
 * 등락 방향 Enum
 */
enum class Direction {
    UP,       // 상승
    DOWN,     // 하락
    UNCHANGED // 보합
}

/**
 * Any? → String 안전 변환
 * null-safe toString
 */
fun Any?.toStringSafe(): String {
    return this?.toString() ?: ""
}
```

---

## 엣지 케이스 및 오류 처리

### 1. 숫자 파싱 실패

**문제**: 예상치 못한 형식의 숫자 문자열

**예제**: `"N/A"`, `"--"`, `"none"`

**해결책**: `toBigDecimalOrNull()`, `toLongOrNull()` 등 사용 후 Elvis 연산자로 기본값

```kotlin
val value = rawValue.toString()
    .replace(",", "")
    .toBigDecimalOrNull() ?: BigDecimal.ZERO
```

### 2. 날짜 파싱 실패

**문제**: 잘못된 날짜 형식

**예제**: `"2024-01-02"` (대시 형식), `"20240132"` (잘못된 날짜)

**해결책**: try-catch로 예외 처리 후 `LocalDate.MIN` 반환

```kotlin
fun String.toKrxDate(): LocalDate {
    return try {
        // 파싱 로직
    } catch (e: Exception) {
        LocalDate.MIN
    }
}
```

### 3. 필드 누락

**문제**: 응답에 예상 필드가 없음

**해결책**: Safe call 연산자 `?.` 및 Elvis 연산자 `?:` 사용

```kotlin
val closePrice = (raw["TDD_CLSPRC"] as? String)?.toKrxPrice() ?: BigDecimal.ZERO
```

### 4. 타입 불일치

**문제**: 예상과 다른 타입 (예: BigDecimal 대신 String)

**해결책**: `as?` 연산자로 안전한 캐스팅

```kotlin
val output = (response["output"] as? List<*>) ?: emptyList()
```

---

## 부호 있는 vs 부호 없는 정수 규칙

### 항상 양수인 필드

| 필드 | 설명 | 변환 함수 |
|------|------|----------|
| TDD_CLSPRC | 종가 | toKrxPrice() |
| ACC_TRDVOL | 거래량 | toKrxLong() |
| MKTCAP | 시가총액 | toKrxAmount() |
| LIST_SHRS | 상장주식수 | toKrxLong() |
| ASK_TRDVOL | 매도거래량 | toKrxLong() |
| BID_TRDVOL | 매수거래량 | toKrxLong() |

### 음수 가능한 필드 (부호 있음)

| 필드 | 설명 | 변환 함수 | 음수 의미 |
|------|------|----------|-----------|
| NETBID_TRDVAL | 순매수거래대금 | toKrxSignedLong() | 순매도 |
| NETBID_TRDVOL | 순매수거래량 | toKrxSignedLong() | 순매도 |
| NUM_ITM_VAL21~24 | 투자자별 순매수 | toKrxSignedLong() | 순매도 |
| CMPPREVDD_PRC | 전일대비 | toKrxPrice() | 하락 |
| DIVRG_RT | 괴리율 | toKrxRate() | NAV보다 낮음 |
| FLUC_RT | 등락률 | toKrxRate() | 하락률 |

**중요**: 음수 부호를 제거하지 말고 그대로 유지해야 합니다!

---

## 날짜 형식 변환

### KRX → Kotlin 변환

| KRX 형식 | 예시 | Kotlin 형식 | 변환 함수 |
|---------|------|------------|----------|
| yyyy/MM/dd | "2024/01/02" | LocalDate | toKrxDate() |
| yyyyMMdd | "20240102" | LocalDate | toKrxDate() |

### Kotlin → KRX 변환 (요청 파라미터)

| Kotlin 형식 | KRX 형식 | 변환 방법 |
|------------|---------|----------|
| LocalDate | yyyyMMdd | `date.format(DateTimeFormatter.ofPattern("yyyyMMdd"))` |

**예제**:
```kotlin
val date = LocalDate.of(2024, 1, 2)
val krxFormat = date.format(DateTimeFormatter.ofPattern("yyyyMMdd"))
// "20240102"
```

---

## 정규화 테스트

### NormalizationExtensionsTest.kt

```kotlin
package com.kairos.krx.util

import org.junit.jupiter.api.Test
import org.junit.jupiter.api.Assertions.*
import java.math.BigDecimal
import java.time.LocalDate

class NormalizationExtensionsTest {

    @Test
    fun `toKrxPrice - 정상 값`() {
        assertEquals(BigDecimal("42965.00"), "42,965".toKrxPrice())
        assertEquals(BigDecimal("1080.00"), "1,080".toKrxPrice())
        assertEquals(BigDecimal("0.00"), "0".toKrxPrice())
    }

    @Test
    fun `toKrxPrice - 특수 값`() {
        assertEquals(BigDecimal.ZERO, "-".toKrxPrice())
        assertEquals(BigDecimal.ZERO, "".toKrxPrice())
        assertEquals(BigDecimal.ZERO, "  ".toKrxPrice())
    }

    @Test
    fun `toKrxAmount - 대용량 값`() {
        assertEquals(BigDecimal("850707000000"), "850,707,000,000".toKrxAmount())
        assertEquals(BigDecimal("19800000"), "19,800,000".toKrxAmount())
    }

    @Test
    fun `toKrxRate - 소수점 및 스케일`() {
        assertEquals(BigDecimal("2.5800"), "2.58".toKrxRate())
        assertEquals(BigDecimal("-1.2300"), "-1.23".toKrxRate())
        assertEquals(BigDecimal("0.0000"), "-".toKrxRate())
    }

    @Test
    fun `toKrxSignedLong - 음수 값`() {
        assertEquals(1234567L, "1,234,567".toKrxSignedLong())
        assertEquals(-1234567L, "-1,234,567".toKrxSignedLong())
        assertEquals(0L, "-".toKrxSignedLong())
    }

    @Test
    fun `toKrxLong - 대용량 값`() {
        assertEquals(850707000000L, "850,707,000,000".toKrxLong())
        assertEquals(19800000L, "19,800,000".toKrxLong())
    }

    @Test
    fun `toKrxBigDecimal - 고정밀`() {
        assertEquals(BigDecimal("43079.14"), "43,079.14".toKrxBigDecimal())
        assertEquals(BigDecimal("0.15"), "0.15".toKrxBigDecimal())
        assertEquals(BigDecimal.ZERO, "-".toKrxBigDecimal())
    }

    @Test
    fun `toKrxDate - Slash 형식`() {
        assertEquals(LocalDate.of(2024, 1, 2), "2024/01/02".toKrxDate())
    }

    @Test
    fun `toKrxDate - Compact 형식`() {
        assertEquals(LocalDate.of(2024, 1, 2), "20240102".toKrxDate())
    }

    @Test
    fun `toKrxDate - 특수 값`() {
        assertEquals(LocalDate.MIN, "-".toKrxDate())
        assertEquals(LocalDate.MIN, "".toKrxDate())
    }

    @Test
    fun `toKrxDirection - 등락구분`() {
        assertEquals(Direction.UP, "1".toKrxDirection())
        assertEquals(Direction.DOWN, "2".toKrxDirection())
        assertEquals(Direction.UNCHANGED, "3".toKrxDirection())
    }
}
```

---

## 성능 최적화

### 1. 문자열 정규화 캐싱

대량의 데이터를 처리할 때 동일한 값이 반복되면 캐싱 고려:

```kotlin
private val dateCache = mutableMapOf<String, LocalDate>()

fun String.toKrxDateCached(): LocalDate {
    return dateCache.getOrPut(this) {
        this.toKrxDate()
    }
}
```

### 2. Regex 사전 컴파일

반복적인 정규식 사용 시:

```kotlin
private val commaRegex = Regex(",")

fun String.toKrxPriceOptimized(): BigDecimal {
    return this.replace(commaRegex, "")
        .trim()
        .let { if (it == "-" || it.isEmpty()) "0" else it }
        .toBigDecimalOrNull()
        ?.setScale(2, RoundingMode.HALF_UP)
        ?: BigDecimal.ZERO
}
```

---

## 요약

### 핵심 원칙

1. **금융 데이터는 BigDecimal**: 모든 가격, 금액, 비율에 BigDecimal 사용
2. **일관성**: 모든 엔드포인트에 동일한 정규화 규칙 적용
3. **타입 안전성**: String이 아닌 적절한 Kotlin 타입 사용
4. **Null 안전성**: Safe call 및 Elvis 연산자 활용
5. **특수 값 처리**: "-", "", null을 항상 처리
6. **음수 부호 유지**: 금융 데이터에서 음수는 의미가 있음

### 타입별 변환 함수 매핑

| 데이터 종류 | 변환 함수 | 스케일 | 예시 |
|------------|----------|--------|------|
| 가격 (Price) | `toKrxPrice()` | 2 | 종가, 시가 |
| 금액 (Amount) | `toKrxAmount()` | 0 | 시가총액, 거래대금 |
| 비율 (Rate) | `toKrxRate()` | 4 | 등락률, 보수율 |
| 고정밀 (NAV/지수) | `toKrxBigDecimal()` | 원본 | NAV, 지수 |
| 수량 (Quantity) | `toKrxLong()` | - | 거래량, 주식수 |
| 부호있는수량 | `toKrxSignedLong()` | - | 순매수 |
| 날짜 (Date) | `toKrxDate()` | - | 거래일 |
| 방향 (Direction) | `toKrxDirection()` | - | 등락구분 |

### 다음 단계

1. **NormalizationExtensions.kt 구현**: 모든 확장 함수 생성
2. **단위 테스트 작성**: 모든 엣지 케이스 커버
3. **모델 클래스 적용**: fromRaw() 메서드에서 정규화 함수 사용
4. **통합 테스트**: 실제 KRX API 응답으로 검증

## 참조

- 01-프로젝트-개요.md: 아키텍처 개요
- 02-KRX-ETF-엔드포인트-분석.md: 필드 목록
- 03-MDCSTAT04701-상세명세.md: ComprehensiveEtfInfo 구현 예제
- 07-테스트-전략.md: 정규화 테스트 전략
